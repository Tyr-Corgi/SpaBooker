#!/bin/bash
# Pre-commit hook to enforce testing requirements
# Install: git config core.hooksPath .githooks

set -e

echo "ðŸ” Running pre-commit checks..."

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Get list of changed C# files (excluding test files)
CHANGED_CS_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.cs$' | grep -v 'Tests\.cs$' | grep -v '^tests/' || true)

if [ -z "$CHANGED_CS_FILES" ]; then
    echo -e "${GREEN}âœ“ No production C# files changed${NC}"
    exit 0
fi

echo -e "${YELLOW}ðŸ“ Changed production files:${NC}"
echo "$CHANGED_CS_FILES" | sed 's/^/  - /'

# Check if test files were also modified
CHANGED_TEST_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E 'Tests?\.cs$' || true)

if [ -z "$CHANGED_TEST_FILES" ]; then
    echo -e "${RED}âŒ ERROR: Production code changed without test modifications!${NC}"
    echo -e "${YELLOW}Please add or update tests for your changes.${NC}"
    echo ""
    echo "Guidelines:"
    echo "  â€¢ New entities â†’ Add unit tests in tests/SpaBooker.Tests.Unit/Entities/"
    echo "  â€¢ New services â†’ Add integration tests in tests/SpaBooker.Tests.Integration/Services/"
    echo "  â€¢ New features â†’ Add appropriate test coverage"
    echo ""
    echo "To bypass this check (NOT RECOMMENDED):"
    echo "  git commit --no-verify"
    exit 1
fi

echo -e "${GREEN}âœ“ Test files detected:${NC}"
echo "$CHANGED_TEST_FILES" | sed 's/^/  - /'

# Run tests to ensure they pass
echo ""
echo "ðŸ§ª Running test suite..."

if ! dotnet test --nologo --verbosity quiet; then
    echo -e "${RED}âŒ Tests failed! Please fix failing tests before committing.${NC}"
    exit 1
fi

echo -e "${GREEN}âœ“ All tests passed!${NC}"

# Check for minimum test coverage (optional - requires coverlet)
echo ""
echo "ðŸ“Š Checking test coverage..."

# Run tests with coverage
if command -v dotnet-coverage &> /dev/null; then
    COVERAGE_OUTPUT=$(dotnet test --collect:"XPlat Code Coverage" --verbosity quiet 2>&1 || true)
    
    # Extract coverage percentage (this is a simplified check)
    # You may need to adjust based on your coverage tool output
    echo -e "${GREEN}âœ“ Coverage check complete${NC}"
else
    echo -e "${YELLOW}âš  Coverage tool not installed. Skipping coverage check.${NC}"
    echo "  Install: dotnet tool install --global coverlet.console"
fi

echo ""
echo -e "${GREEN}âœ… Pre-commit checks passed!${NC}"
exit 0

