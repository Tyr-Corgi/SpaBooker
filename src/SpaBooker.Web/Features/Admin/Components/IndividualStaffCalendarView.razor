@using SpaBooker.Core.Entities

<div class="card h-100">
    <div class="card-header bg-light d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="bi bi-calendar3"></i> Schedule Calendar</h5>
        <div class="d-flex align-items-center gap-2">
            <span class="badge bg-info me-2">Click any day to add/edit schedule</span>
            
            @* View Toggle *@
            <div class="btn-group btn-group-sm">
                <button type="button" class="btn @(ViewMode == ViewModeEnum.Week ? "btn-primary" : "btn-outline-secondary")" 
                        @onclick="() => OnViewModeChanged.InvokeAsync(ViewModeEnum.Week)">
                    Week
                </button>
                <button type="button" class="btn @(ViewMode == ViewModeEnum.Month ? "btn-primary" : "btn-outline-secondary")" 
                        @onclick="() => OnViewModeChanged.InvokeAsync(ViewModeEnum.Month)">
                    Month
                </button>
            </div>
            
            @* Navigation *@
            <div class="btn-group btn-group-sm">
                <button class="btn btn-primary" @onclick="OnNavigatePrevious" title="Previous">
                    <span style="font-size: 1.2rem;">◀</span>
                </button>
                <button class="btn btn-outline-secondary" disabled>
                    @ViewTitle
                </button>
                <button class="btn btn-primary" @onclick="OnNavigateNext" title="Next">
                    <span style="font-size: 1.2rem;">▶</span>
                </button>
            </div>
            
            @* Date Picker for quick navigation *@
            <div class="d-flex align-items-center gap-2">
                <label class="form-label mb-0 small text-muted">Jump to:</label>
                <input type="date" 
                       class="form-control form-control-sm" 
                       style="width: 150px;"
                       value="@ViewDate.ToString("yyyy-MM-dd")" 
                       @onchange="@HandleDatePickerChanged" />
            </div>
            
            <button class="btn btn-sm btn-primary" @onclick="OnGoToToday">
                <i class="bi bi-calendar-check"></i> Today
            </button>
        </div>
    </div>
    <div class="card-body">
        <style>
            .staff-calendar-grid {
                display: grid;
                grid-template-columns: repeat(7, 1fr);
                gap: 2px;
                background-color: #e9ecef;
                padding: 2px;
                border-radius: 4px;
            }
            
            .staff-calendar-day-header {
                background-color: #6c757d;
                color: white;
                text-align: center;
                padding: 12px 8px;
                font-weight: 600;
                font-size: 0.875rem;
                text-transform: uppercase;
            }
            
            .staff-calendar-day {
                background-color: white;
                min-height: 80px;
                padding: 8px;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: flex-start;
                position: relative;
                transition: all 0.2s ease;
            }
            
            .staff-calendar-day:hover {
                background-color: #f8f9fa;
            }
            
            .staff-calendar-day-number {
                font-size: 0.875rem;
                font-weight: 500;
                margin-bottom: 4px;
            }
            
            .staff-calendar-other-month {
                opacity: 0.3;
            }
            
            .staff-calendar-other-month:hover {
                opacity: 0.5;
            }
            
            .staff-calendar-past-day {
                background-color: #f8f9fa;
                color: #adb5bd;
            }
            
            .staff-calendar-scheduled-day {
                background-color: #d4edda;
                border: 2px solid #28a745;
            }
            
            .staff-calendar-scheduled-day .staff-calendar-day-number {
                color: #155724;
                font-weight: 700;
            }
            
            .staff-calendar-unscheduled-day {
                background-color: #fff3cd;
                border: 2px solid #ffc107;
            }
            
            .staff-calendar-unscheduled-day .staff-calendar-day-number {
                color: #856404;
            }
            
            .staff-calendar-clickable {
                cursor: pointer;
            }
        </style>
        
        @RenderCalendarGrid()
    </div>
</div>

@code {
    [Parameter] public ViewModeEnum ViewMode { get; set; }
    [Parameter] public DateTime ViewDate { get; set; }
    [Parameter] public string ViewTitle { get; set; } = "";
    [Parameter] public List<TherapistAvailability> Schedules { get; set; } = new();
    
    [Parameter] public EventCallback<ViewModeEnum> OnViewModeChanged { get; set; }
    [Parameter] public EventCallback OnNavigatePrevious { get; set; }
    [Parameter] public EventCallback OnNavigateNext { get; set; }
    [Parameter] public EventCallback OnGoToToday { get; set; }
    [Parameter] public EventCallback<string?> OnDatePickerChanged { get; set; }
    [Parameter] public EventCallback<DateTime> OnDayClick { get; set; }
    [Parameter] public Func<DateTime, bool> IsScheduledFunc { get; set; } = null!;
    [Parameter] public Func<DateTime, string> GetScheduleTextFunc { get; set; } = null!;

    private async Task HandleDatePickerChanged(ChangeEventArgs e)
    {
        await OnDatePickerChanged.InvokeAsync(e.Value?.ToString());
    }

    private RenderFragment RenderCalendarGrid() => builder =>
    {
        DateTime startDate;
        int daysToDisplay;
        var dayNames = new[] { "Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat" };
        
        if (ViewMode == ViewModeEnum.Week)
        {
            startDate = GetWeekStart();
            daysToDisplay = 7;
        }
        else // Month
        {
            var firstDayOfMonth = new DateTime(ViewDate.Year, ViewDate.Month, 1);
            startDate = firstDayOfMonth.AddDays(-(int)firstDayOfMonth.DayOfWeek);
            daysToDisplay = 42;
        }
        
        builder.OpenElement(0, "div");
        builder.AddAttribute(1, "class", "staff-calendar-grid");
        
        // Day headers
        foreach (var dayName in dayNames)
        {
            builder.OpenElement(2, "div");
            builder.AddAttribute(3, "class", "staff-calendar-day-header");
            builder.AddContent(4, dayName);
            builder.CloseElement();
        }
        
        // Calendar days
        for (int i = 0; i < daysToDisplay; i++)
        {
            var currentDate = startDate.AddDays(i);
            var capturedDate = currentDate;
            var isCurrentPeriod = ViewMode == ViewModeEnum.Week ? true : currentDate.Month == ViewDate.Month;
            var isScheduled = IsScheduledFunc?.Invoke(currentDate) ?? false;
            var isPast = currentDate < DateTime.Today;
            
            var cssClass = "staff-calendar-day";
            if (!isCurrentPeriod) cssClass += " staff-calendar-other-month";
            if (isPast) cssClass += " staff-calendar-past-day";
            if (isScheduled && !isPast) cssClass += " staff-calendar-scheduled-day";
            if (!isScheduled && !isPast && isCurrentPeriod) cssClass += " staff-calendar-unscheduled-day";
            if (!isPast && isCurrentPeriod) cssClass += " staff-calendar-clickable";
            
            builder.OpenElement(5, "div");
            builder.AddAttribute(6, "class", cssClass);
            if (!isPast && isCurrentPeriod)
            {
                builder.AddAttribute(7, "onclick", Microsoft.AspNetCore.Components.EventCallback.Factory.Create(this, () => OnDayClick.InvokeAsync(capturedDate)));
            }
            
            builder.OpenElement(8, "div");
            builder.AddAttribute(9, "class", "staff-calendar-day-number");
            builder.AddContent(10, currentDate.Day);
            builder.CloseElement();
            
            if (isScheduled && isCurrentPeriod)
            {
                builder.OpenElement(11, "div");
                builder.AddAttribute(12, "class", "staff-calendar-day-times");
                builder.AddContent(13, GetScheduleTextFunc?.Invoke(currentDate) ?? "");
                builder.CloseElement();
            }
            
            builder.CloseElement();
        }
        
        builder.CloseElement();
    };

    private DateTime GetWeekStart()
    {
        return ViewDate.AddDays(-(int)ViewDate.DayOfWeek);
    }

    public enum ViewModeEnum { Week, Month }
}
