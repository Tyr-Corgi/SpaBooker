@page "/admin/dashboard"
@using Microsoft.EntityFrameworkCore
@using SpaBooker.Core.Entities
@using SpaBooker.Infrastructure.Data
@using Microsoft.AspNetCore.Authorization
@inject ApplicationDbContext DbContext
@attribute [Authorize(Roles = "Admin")]

<PageTitle>Admin Dashboard - SpaBooker</PageTitle>

<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="text-rose-gold mb-2">Admin Dashboard</h1>
            <p class="text-muted">System overview and key metrics</p>
        </div>
    </div>

    @if (isLoading)
    {
        <div class="text-center py-5">
            <div class="spinner"></div>
            <p class="mt-3 text-muted">Loading dashboard...</p>
        </div>
    }
    else
    {
        <!-- Key Metrics -->
        <div class="row g-4 mb-4">
            <div class="col-lg-3 col-md-6">
                <div class="card metric-card">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="flex-grow-1">
                                <h6 class="text-muted mb-1">Total Bookings</h6>
                                <h2 class="mb-0 text-rose-gold">@stats.TotalBookings</h2>
                                <small class="text-success">
                                    <i class="bi bi-arrow-up"></i> @stats.BookingsThisMonth this month
                                </small>
                            </div>
                            <div class="metric-icon bg-primary">
                                <i class="bi bi-calendar-check"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-3 col-md-6">
                <div class="card metric-card">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="flex-grow-1">
                                <h6 class="text-muted mb-1">Revenue (Est.)</h6>
                                <h2 class="mb-0 text-rose-gold">$@stats.TotalRevenue.ToString("N0")</h2>
                                <small class="text-success">
                                    <i class="bi bi-arrow-up"></i> $@stats.RevenueThisMonth.ToString("N0") this month
                                </small>
                            </div>
                            <div class="metric-icon bg-success">
                                <i class="bi bi-currency-dollar"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-3 col-md-6">
                <div class="card metric-card">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="flex-grow-1">
                                <h6 class="text-muted mb-1">Active Members</h6>
                                <h2 class="mb-0 text-rose-gold">@stats.ActiveMembers</h2>
                                <small class="text-info">
                                    @stats.TotalMembers total memberships
                                </small>
                            </div>
                            <div class="metric-icon bg-warning">
                                <i class="bi bi-star"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-3 col-md-6">
                <div class="card metric-card">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="flex-grow-1">
                                <h6 class="text-muted mb-1">Total Users</h6>
                                <h2 class="mb-0 text-rose-gold">@stats.TotalUsers</h2>
                                <small class="text-muted">
                                    @stats.TotalClients clients â€¢ @stats.TotalTherapists therapists
                                </small>
                            </div>
                            <div class="metric-icon bg-info">
                                <i class="bi bi-people"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Activity & Charts -->
        <div class="row mb-4">
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Recent Bookings</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Client</th>
                                        <th>Service</th>
                                        <th>Therapist</th>
                                        <th>Date</th>
                                        <th>Status</th>
                                        <th>Amount</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var booking in recentBookings)
                                    {
                                        <tr>
                                            <td>@booking.Client.FirstName @booking.Client.LastName</td>
                                            <td>@booking.Service.Name</td>
                                            <td>@booking.Therapist.FirstName @booking.Therapist.LastName</td>
                                            <td>@booking.StartTime.ToString("MMM dd, h:mm tt")</td>
                                            <td>
                                                <span class="badge @GetStatusBadgeClass(booking.Status)">
                                                    @booking.Status
                                                </span>
                                            </td>
                                            <td>$@booking.TotalPrice.ToString("F2")</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Booking Status</h5>
                    </div>
                    <div class="card-body">
                        <div class="status-breakdown">
                            <div class="status-item">
                                <div class="d-flex justify-content-between mb-1">
                                    <span>Pending</span>
                                    <strong>@statusBreakdown.Pending</strong>
                                </div>
                                <div class="progress" style="height: 8px;">
                                    <div class="progress-bar bg-warning" style="width: @GetPercentage(statusBreakdown.Pending, stats.TotalBookings)%"></div>
                                </div>
                            </div>

                            <div class="status-item">
                                <div class="d-flex justify-content-between mb-1">
                                    <span>Confirmed</span>
                                    <strong>@statusBreakdown.Confirmed</strong>
                                </div>
                                <div class="progress" style="height: 8px;">
                                    <div class="progress-bar bg-success" style="width: @GetPercentage(statusBreakdown.Confirmed, stats.TotalBookings)%"></div>
                                </div>
                            </div>

                            <div class="status-item">
                                <div class="d-flex justify-content-between mb-1">
                                    <span>Completed</span>
                                    <strong>@statusBreakdown.Completed</strong>
                                </div>
                                <div class="progress" style="height: 8px;">
                                    <div class="progress-bar bg-secondary" style="width: @GetPercentage(statusBreakdown.Completed, stats.TotalBookings)%"></div>
                                </div>
                            </div>

                            <div class="status-item">
                                <div class="d-flex justify-content-between mb-1">
                                    <span>Cancelled</span>
                                    <strong>@statusBreakdown.Cancelled</strong>
                                </div>
                                <div class="progress" style="height: 8px;">
                                    <div class="progress-bar bg-danger" style="width: @GetPercentage(statusBreakdown.Cancelled, stats.TotalBookings)%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Low Stock Items</h5>
                    </div>
                    <div class="card-body">
                        @if (lowStockItems.Any())
                        {
                            <div class="list-group list-group-flush">
                                @foreach (var item in lowStockItems.Take(5))
                                {
                                    <div class="list-group-item px-0">
                                        <div class="d-flex justify-content-between">
                                            <div>
                                                <strong>@item.Name</strong>
                                                <br />
                                                <small class="text-muted">@item.Location.Name</small>
                                            </div>
                                            <span class="badge badge-danger">@item.CurrentStock left</span>
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <p class="text-muted mb-0">All items sufficiently stocked</p>
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- Top Services & Locations -->
        <div class="row">
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Top Services</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Service</th>
                                        <th class="text-center">Bookings</th>
                                        <th class="text-end">Revenue</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var service in topServices)
                                    {
                                        <tr>
                                            <td>@service.ServiceName</td>
                                            <td class="text-center">@service.BookingCount</td>
                                            <td class="text-end">$@service.Revenue.ToString("N0")</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Location Performance</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Location</th>
                                        <th class="text-center">Bookings</th>
                                        <th class="text-end">Revenue</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var location in locationPerformance)
                                    {
                                        <tr>
                                            <td>@location.LocationName</td>
                                            <td class="text-center">@location.BookingCount</td>
                                            <td class="text-end">$@location.Revenue.ToString("N0")</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private DashboardStats stats = new();
    private StatusBreakdown statusBreakdown = new();
    private List<Booking> recentBookings = new();
    private List<InventoryItem> lowStockItems = new();
    private List<TopService> topServices = new();
    private List<LocationPerformance> locationPerformance = new();
    private bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadDashboardData();
    }

    private async Task LoadDashboardData()
    {
        isLoading = true;

        var now = DateTime.UtcNow;
        var monthStart = new DateTime(now.Year, now.Month, 1, 0, 0, 0, DateTimeKind.Utc);

        // Calculate stats
        var allBookings = await DbContext.Bookings
            .Include(b => b.Service)
            .Include(b => b.Client)
            .Include(b => b.Therapist)
            .ToListAsync();

        stats = new DashboardStats
        {
            TotalBookings = allBookings.Count,
            BookingsThisMonth = allBookings.Count(b => b.CreatedAt >= monthStart),
            TotalRevenue = allBookings.Where(b => b.Status != BookingStatus.Cancelled).Sum(b => b.TotalPrice),
            RevenueThisMonth = allBookings.Where(b => b.CreatedAt >= monthStart && b.Status != BookingStatus.Cancelled).Sum(b => b.TotalPrice),
            ActiveMembers = await DbContext.UserMemberships.CountAsync(m => m.Status == MembershipStatus.Active),
            TotalMembers = await DbContext.UserMemberships.CountAsync(),
            TotalUsers = await DbContext.Users.CountAsync(),
            TotalClients = await DbContext.UserRoles
                .Where(ur => DbContext.Roles.Any(r => r.Id == ur.RoleId && r.Name == "Client"))
                .CountAsync(),
            TotalTherapists = await DbContext.UserRoles
                .Where(ur => DbContext.Roles.Any(r => r.Id == ur.RoleId && r.Name == "Therapist"))
                .CountAsync()
        };

        // Status breakdown
        statusBreakdown = new StatusBreakdown
        {
            Pending = allBookings.Count(b => b.Status == BookingStatus.Pending),
            Confirmed = allBookings.Count(b => b.Status == BookingStatus.Confirmed),
            Completed = allBookings.Count(b => b.Status == BookingStatus.Completed),
            Cancelled = allBookings.Count(b => b.Status == BookingStatus.Cancelled),
            NoShow = allBookings.Count(b => b.Status == BookingStatus.NoShow)
        };

        // Recent bookings
        recentBookings = allBookings
            .OrderByDescending(b => b.CreatedAt)
            .Take(10)
            .ToList();

        // Low stock items
        lowStockItems = await DbContext.InventoryItems
            .Include(i => i.Location)
            .Where(i => i.CurrentStock <= i.MinimumStock && i.IsActive)
            .OrderBy(i => i.CurrentStock)
            .ToListAsync();

        // Top services
        topServices = allBookings
            .Where(b => b.Status != BookingStatus.Cancelled)
            .GroupBy(b => new { b.ServiceId, b.Service.Name })
            .Select(g => new TopService
            {
                ServiceName = g.Key.Name,
                BookingCount = g.Count(),
                Revenue = g.Sum(b => b.TotalPrice)
            })
            .OrderByDescending(s => s.BookingCount)
            .Take(5)
            .ToList();

        // Location performance
        locationPerformance = allBookings
            .Where(b => b.Status != BookingStatus.Cancelled)
            .GroupBy(b => new { b.LocationId, b.Location.Name })
            .Select(g => new LocationPerformance
            {
                LocationName = g.Key.Name,
                BookingCount = g.Count(),
                Revenue = g.Sum(b => b.TotalPrice)
            })
            .OrderByDescending(l => l.Revenue)
            .ToList();

        isLoading = false;
    }

    private string GetStatusBadgeClass(BookingStatus status)
    {
        return status switch
        {
            BookingStatus.Pending => "badge-warning",
            BookingStatus.Confirmed => "badge-success",
            BookingStatus.Completed => "badge-secondary",
            BookingStatus.Cancelled => "badge-danger",
            BookingStatus.NoShow => "badge-danger",
            _ => "badge-secondary"
        };
    }

    private double GetPercentage(int value, int total)
    {
        return total > 0 ? (value * 100.0 / total) : 0;
    }

    public class DashboardStats
    {
        public int TotalBookings { get; set; }
        public int BookingsThisMonth { get; set; }
        public decimal TotalRevenue { get; set; }
        public decimal RevenueThisMonth { get; set; }
        public int ActiveMembers { get; set; }
        public int TotalMembers { get; set; }
        public int TotalUsers { get; set; }
        public int TotalClients { get; set; }
        public int TotalTherapists { get; set; }
    }

    public class StatusBreakdown
    {
        public int Pending { get; set; }
        public int Confirmed { get; set; }
        public int Completed { get; set; }
        public int Cancelled { get; set; }
        public int NoShow { get; set; }
    }

    public class TopService
    {
        public string ServiceName { get; set; } = string.Empty;
        public int BookingCount { get; set; }
        public decimal Revenue { get; set; }
    }

    public class LocationPerformance
    {
        public string LocationName { get; set; } = string.Empty;
        public int BookingCount { get; set; }
        public decimal Revenue { get; set; }
    }
}

