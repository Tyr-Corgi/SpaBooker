@using Microsoft.AspNetCore.Components.Web
@using Microsoft.JSInterop
@rendermode RenderMode.InteractiveServer
@page "/admin/staff-scheduling"
@using Microsoft.EntityFrameworkCore
@using SpaBooker.Core.Entities
@using SpaBooker.Core.Enums
@using SpaBooker.Infrastructure.Data
@using Microsoft.AspNetCore.Authorization
@inject IDbContextFactory<ApplicationDbContext> DbContextFactory
@inject UserManager<ApplicationUser> UserManager
@inject IJSRuntime JSRuntime
@attribute [Authorize(Roles = "Admin")]

<PageTitle>Staff Scheduling - SpaBooker Admin</PageTitle>

<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="text-rose-gold mb-2">
                <i class="bi bi-calendar-week"></i> Staff Scheduling
            </h1>
            <p class="text-muted">Manage therapist work schedules and availability</p>
        </div>
    </div>

    @if (isLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-rose-gold" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3 text-muted">Loading schedules...</p>
        </div>
    }
    else
    {
        @if (!string.IsNullOrEmpty(successMessage))
        {
            <div class="alert alert-success alert-dismissible fade show">
                <i class="bi bi-check-circle"></i> @successMessage
                <button type="button" class="btn-close" @onclick="() => successMessage = null"></button>
            </div>
        }

        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="alert alert-danger alert-dismissible fade show">
                <i class="bi bi-exclamation-triangle"></i> @errorMessage
                <button type="button" class="btn-close" @onclick="() => errorMessage = null"></button>
            </div>
        }

        <div class="row">
            @* Therapist Selector *@
            <div class="col-12 mb-4">
                <div class="card">
                    <div class="card-header bg-light">
                        <h5 class="mb-0"><i class="bi bi-person-badge"></i> Select Therapist</h5>
                    </div>
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <label class="form-label">Therapist</label>
                                <select class="form-select form-select-lg" @onchange="OnTherapistChanged">
                                    <option value="">-- Select a therapist --</option>
                                    <option value="ALL_STAFF" selected="@(selectedTherapistId == "ALL_STAFF")">üìÖ All Staff Overview</option>
                                    @foreach (var therapist in therapists)
                                    {
                                        <option value="@therapist.Id" selected="@(therapist.Id == selectedTherapistId)">
                                            @therapist.FirstName @therapist.LastName
                                        </option>
                                    }
                                </select>
                            </div>
                            @if (!string.IsNullOrEmpty(selectedTherapistId))
                            {
                                <div class="col-md-6">
                                    @if (selectedTherapistId == "ALL_STAFF")
                                    {
                                        <div class="alert alert-info mb-0">
                                            <strong>All Staff Overview:</strong><br/>
                                            @GetAllStaffSummary()
                                        </div>
                                    }
                                    else
                                    {
                                        <div class="alert alert-info mb-0">
                                            <strong>Current Week Status:</strong><br/>
                                            @GetCurrentWeekSummary()
                                        </div>
                                    }
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>

            @if (selectedTherapistId == "ALL_STAFF")
            {
                @* All Staff Calendar View - Full Width *@
                <div class="col-12 mb-4">
                    <div class="card">
                        <div class="card-header bg-light">
                            <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                                <h5 class="mb-0"><i class="bi bi-calendar3"></i> All Staff Schedule Calendar</h5>
                                <div class="d-flex gap-2 align-items-center flex-wrap">
                                    @* View Toggle *@
                                    <div class="btn-group btn-group-sm" role="group">
                                        <button type="button" class="btn @(calendarViewMode == CalendarViewMode.Day ? "btn-primary" : "btn-outline-secondary")" 
                                                @onclick="() => SetCalendarViewMode(CalendarViewMode.Day)">
                                            Day
                                        </button>
                                        <button type="button" class="btn @(calendarViewMode == CalendarViewMode.Week ? "btn-primary" : "btn-outline-secondary")" 
                                                @onclick="() => SetCalendarViewMode(CalendarViewMode.Week)">
                                            Week
                                        </button>
                                        <button type="button" class="btn @(calendarViewMode == CalendarViewMode.Month ? "btn-primary" : "btn-outline-secondary")" 
                                                @onclick="() => SetCalendarViewMode(CalendarViewMode.Month)">
                                            Month
                                        </button>
                                    </div>
                                    
                                    @* Navigation *@
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-primary" @onclick="NavigatePrevious" title="Previous">
                                            <span style="font-size: 1.2rem;">‚óÄ</span>
                                        </button>
                                        <button class="btn btn-outline-secondary" disabled>
                                            @GetCalendarViewTitle()
                                        </button>
                                        <button class="btn btn-primary" @onclick="NavigateNext" title="Next">
                                            <span style="font-size: 1.2rem;">‚ñ∂</span>
                                        </button>
                                    </div>
                                    
                                    <button class="btn btn-sm btn-primary" @onclick="GoToToday">
                                        <i class="bi bi-calendar-check"></i> Today
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <style>
                                .staff-calendar-grid {
                                    display: grid;
                                    grid-template-columns: repeat(7, 1fr);
                                    gap: 2px;
                                    background-color: #e9ecef;
                                    padding: 2px;
                                    border-radius: 4px;
                                }
                                
                                .staff-calendar-day-header {
                                    background-color: #6c757d;
                                    color: white;
                                    text-align: center;
                                    padding: 12px 8px;
                                    font-weight: 600;
                                    font-size: 0.875rem;
                                    text-transform: uppercase;
                                }
                                
                                .staff-calendar-day {
                                    background-color: white;
                                    min-height: 100px;
                                    padding: 8px;
                                    display: flex;
                                    flex-direction: column;
                                    align-items: flex-start;
                                    justify-content: flex-start;
                                    position: relative;
                                    transition: all 0.2s ease;
                                }
                                
                                .staff-calendar-day:hover {
                                    background-color: #f8f9fa;
                                }
                                
                                .staff-calendar-day-number {
                                    font-size: 0.875rem;
                                    font-weight: 500;
                                    margin-bottom: 4px;
                                }
                                
                                .staff-calendar-day-indicator {
                                    font-size: 1.5rem;
                                    line-height: 1;
                                    color: #28a745;
                                }
                                
                                .staff-calendar-other-month {
                                    opacity: 0.3;
                                }
                                
                                .staff-calendar-other-month:hover {
                                    opacity: 0.5;
                                }
                                
                                .staff-calendar-past-day {
                                    background-color: #f8f9fa;
                                    color: #adb5bd;
                                }
                                
                                .staff-calendar-scheduled-day {
                                    background-color: #d4edda;
                                    border: 2px solid #28a745;
                                }
                                
                                .staff-calendar-scheduled-day .staff-calendar-day-number {
                                    color: #155724;
                                    font-weight: 700;
                                }
                                
                                .staff-calendar-unscheduled-day {
                                    background-color: #fff3cd;
                                    border: 2px solid #ffc107;
                                }
                                
                                .staff-calendar-unscheduled-day .staff-calendar-day-number {
                                    color: #856404;
                                }
                                
                                .staff-calendar-clickable {
                                    cursor: pointer;
                                }
                                
                                .staff-calendar-clickable:hover {
                                    box-shadow: 0 0 0 2px #007bff inset;
                                    transform: scale(1.02);
                                }
                                
                                .staff-calendar-therapist-badge {
                                    display: inline-block;
                                    padding: 2px 6px;
                                    margin: 2px;
                                    border-radius: 3px;
                                    font-size: 0.7rem;
                                    font-weight: 600;
                                    color: white;
                                    white-space: nowrap;
                                    overflow: hidden;
                                    text-overflow: ellipsis;
                                    max-width: 100%;
                                }
                            </style>
                            
                            @* All Staff Calendar Grid - supports Day/Week/Month views *@
                            @{
                                var firstDayOfMonthAll = new DateTime(calendarViewDate.Year, calendarViewDate.Month, 1);
                                var startDateAll = calendarViewMode switch
                                {
                                    CalendarViewMode.Day => calendarViewDate,
                                    CalendarViewMode.Week => GetWeekStart(),
                                    CalendarViewMode.Month => firstDayOfMonthAll.AddDays(-(int)firstDayOfMonthAll.DayOfWeek),
                                    _ => firstDayOfMonthAll.AddDays(-(int)firstDayOfMonthAll.DayOfWeek)
                                };
                                var dayCount = calendarViewMode switch
                                {
                                    CalendarViewMode.Day => 1,
                                    CalendarViewMode.Week => 7,
                                    CalendarViewMode.Month => 42,
                                    _ => 42
                                };
                                var dayNamesAll = new[] { "Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat" };
                                
                                // Generate color palette
                                var colors = new[] { "#3498db", "#e74c3c", "#2ecc71", "#f39c12", "#9b59b6", "#1abc9c", "#e67e22", "#95a5a6", "#34495e", "#16a085" };
                                var therapistColors = new Dictionary<string, string>();
                                for (int j = 0; j < therapists.Count; j++)
                                {
                                    therapistColors[therapists[j].Id] = colors[j % colors.Length];
                                }
                                
                                var gridColumns = calendarViewMode switch
                                {
                                    CalendarViewMode.Day => 1,
                                    CalendarViewMode.Week => 7,
                                    CalendarViewMode.Month => 7,
                                    _ => 7
                                };
                            }
                            
                            <div class="staff-calendar-grid" style="grid-template-columns: repeat(@gridColumns, 1fr);">
                                @* Day headers (only for Week and Month views) *@
                                @if (calendarViewMode == CalendarViewMode.Week || calendarViewMode == CalendarViewMode.Month)
                                {
                                    @foreach (var dayName in dayNamesAll)
                                    {
                                        <div class="staff-calendar-day-header">@dayName</div>
                                    }
                                }
                                
                                @* Calendar days *@
                                @for (int i = 0; i < dayCount; i++)
                                {
                                    var currentDate = startDateAll.AddDays(i);
                                    var capturedDate = currentDate; // Capture loop variable for event handler
                                    var isCurrentMonth = currentDate.Month == calendarViewDate.Month;
                                    var isPast = currentDate < DateTime.Today;
                                    
                                    // For Day and Week views, always show as "current"
                                    if (calendarViewMode == CalendarViewMode.Day || calendarViewMode == CalendarViewMode.Week)
                                    {
                                        isCurrentMonth = true;
                                    }
                                    
                                    // Get all therapists scheduled for this day
                                    var scheduledTherapists = new List<(ApplicationUser therapist, string color)>();
                                    foreach (var therapist in therapists)
                                    {
                                        var therapistSchedules = schedules.Where(s => s.TherapistId == therapist.Id).ToList();
                                        if (IsTherapistScheduledForDayById(currentDate, therapist.Id, therapistSchedules))
                                        {
                                            scheduledTherapists.Add((therapist, therapistColors[therapist.Id]));
                                        }
                                    }
                                    
                                    var cssClass = "staff-calendar-day";
                                    if (!isCurrentMonth) cssClass += " staff-calendar-other-month";
                                    if (isPast) cssClass += " staff-calendar-past-day";
                                    if (!isPast && isCurrentMonth) cssClass += " staff-calendar-clickable";
                                    
                                    <div class="@cssClass" @onclick="() => OnAllStaffDayClick(capturedDate)" @onclick:stopPropagation="true">
                                        <div class="staff-calendar-day-number">@currentDate.Day</div>
                                        @if (scheduledTherapists.Any() && isCurrentMonth && !isPast)
                                        {
                                            <div style="display: flex; flex-direction: column; gap: 2px; width: 100%; margin-top: 4px;">
                                                @foreach (var (therapist, color) in scheduledTherapists)
                                                {
                                                    <div class="staff-calendar-therapist-badge" style="background-color: @color;" title="@therapist.FirstName @therapist.LastName">
                                                        @therapist.FirstName.Substring(0, 1)@therapist.LastName.Substring(0, 1)
                                                    </div>
                                                }
                                            </div>
                                        }
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            }
            else if (!string.IsNullOrEmpty(selectedTherapistId))
            {
                @* Quick Schedule Panel *@
                <div class="col-lg-4 mb-4">
                    <div class="card h-100">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0"><i class="bi bi-lightning-charge"></i> Quick Schedule</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label">Date Range</label>
                                <div class="row g-2">
                                    <div class="col-6">
                                        <input type="date" class="form-control" @bind="scheduleModel.StartDate" @bind:format="yyyy-MM-dd" min="@DateTime.Today.ToString("yyyy-MM-dd")" />
                                        <small class="text-muted">From</small>
                                    </div>
                                    <div class="col-6">
                                        <input type="date" class="form-control" @bind="scheduleModel.EndDate" @bind:format="yyyy-MM-dd" min="@DateTime.Today.ToString("yyyy-MM-dd")" />
                                        <small class="text-muted">To</small>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Time Range</label>
                                <div class="row g-2">
                                    <div class="col-6">
                                        <input type="time" class="form-control" value="@scheduleModel.StartTime" @onchange="@(e => scheduleModel.StartTime = e.Value?.ToString() ?? "09:00")" />
                                        <small class="text-muted">Start</small>
                                    </div>
                                    <div class="col-6">
                                        <input type="time" class="form-control" value="@scheduleModel.EndTime" @onchange="@(e => scheduleModel.EndTime = e.Value?.ToString() ?? "17:00")" />
                                        <small class="text-muted">End</small>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Notes (Optional)</label>
                                <textarea class="form-control" rows="2" @bind="scheduleModel.Notes" placeholder="e.g., Regular shift"></textarea>
                            </div>

                            <div class="d-grid gap-2 mb-3">
                                <button class="btn btn-primary" @onclick="ApplySchedule" disabled="@isSaving">
                                    @if (isSaving)
                                    {
                                        <span class="spinner-border spinner-border-sm me-2"></span>
                                    }
                                    <i class="bi bi-check-circle"></i> Apply Schedule
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                @* Calendar View *@
                <div class="col-lg-8 mb-4">
                    <div class="card h-100">
                        <div class="card-header bg-light d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="bi bi-calendar3"></i> Schedule Calendar</h5>
                            <div>
                                <span class="badge bg-info me-2">Click any day to add/edit schedule</span>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-secondary" @onclick="() => { calendarViewDate = calendarViewDate.AddMonths(-1); }">
                                        <i class="bi bi-chevron-left"></i>
                                    </button>
                                    <button class="btn btn-outline-secondary" disabled>
                                        @calendarViewDate.ToString("MMMM yyyy")
                                    </button>
                                    <button class="btn btn-outline-secondary" @onclick="() => { calendarViewDate = calendarViewDate.AddMonths(1); }">
                                        <i class="bi bi-chevron-right"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <style>
                                .staff-calendar-grid {
                                    display: grid;
                                    grid-template-columns: repeat(7, 1fr);
                                    gap: 2px;
                                    background-color: #e9ecef;
                                    padding: 2px;
                                    border-radius: 4px;
                                }
                                
                                .staff-calendar-day-header {
                                    background-color: #6c757d;
                                    color: white;
                                    text-align: center;
                                    padding: 12px 8px;
                                    font-weight: 600;
                                    font-size: 0.875rem;
                                    text-transform: uppercase;
                                }
                                
                                .staff-calendar-day {
                                    background-color: white;
                                    min-height: 80px;
                                    padding: 8px;
                                    display: flex;
                                    flex-direction: column;
                                    align-items: center;
                                    justify-content: flex-start;
                                    position: relative;
                                    transition: all 0.2s ease;
                                }
                                
                                .staff-calendar-day:hover {
                                    background-color: #f8f9fa;
                                }
                                
                                .staff-calendar-day-number {
                                    font-size: 0.875rem;
                                    font-weight: 500;
                                    margin-bottom: 4px;
                                }
                                
                                .staff-calendar-day-indicator {
                                    font-size: 1.5rem;
                                    line-height: 1;
                                    color: #28a745;
                                }
                                
                                .staff-calendar-other-month {
                                    opacity: 0.3;
                                }
                                
                                .staff-calendar-other-month:hover {
                                    opacity: 0.5;
                                }
                                
                                .staff-calendar-past-day {
                                    background-color: #f8f9fa;
                                    color: #adb5bd;
                                }
                                
                                .staff-calendar-scheduled-day {
                                    background-color: #d4edda;
                                    border: 2px solid #28a745;
                                }
                                
                                .staff-calendar-scheduled-day .staff-calendar-day-number {
                                    color: #155724;
                                    font-weight: 700;
                                }
                                
                                .staff-calendar-unscheduled-day {
                                    background-color: #fff3cd;
                                    border: 2px solid #ffc107;
                                }
                                
                                .staff-calendar-unscheduled-day .staff-calendar-day-number {
                                    color: #856404;
                                }
                            </style>
                            
                            @* Calendar Grid - using regular Razor instead of RenderFragment for proper event handling *@
                            @{
                                var firstDayOfMonth = new DateTime(calendarViewDate.Year, calendarViewDate.Month, 1);
                                var startDate = firstDayOfMonth.AddDays(-(int)firstDayOfMonth.DayOfWeek);
                                var dayNames = new[] { "Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat" };
                            }
                            
                            <div class="staff-calendar-grid">
                                @* Day headers *@
                                @foreach (var dayName in dayNames)
                                {
                                    <div class="staff-calendar-day-header">@dayName</div>
                                }
                                
                                @* Calendar days *@
                                @for (int i = 0; i < 42; i++)
                                {
                                    var currentDate = startDate.AddDays(i);
                                    var capturedDate = currentDate; // Capture loop variable for event handler
                                    var isCurrentMonth = currentDate.Month == calendarViewDate.Month;
                                    var isScheduled = IsTherapistScheduledForDay(currentDate);
                                    var isPast = currentDate < DateTime.Today;
                                    
                                    var cssClass = "staff-calendar-day";
                                    if (!isCurrentMonth) cssClass += " staff-calendar-other-month";
                                    if (isPast) cssClass += " staff-calendar-past-day";
                                    if (isScheduled && !isPast) cssClass += " staff-calendar-scheduled-day";
                                    if (!isScheduled && !isPast && isCurrentMonth) cssClass += " staff-calendar-unscheduled-day";
                                    if (!isPast && isCurrentMonth) cssClass += " staff-calendar-clickable";
                                    
                                    <div class="@cssClass" @onclick="() => OnCalendarDayClick(capturedDate)" @onclick:stopPropagation="true">
                                        <div class="staff-calendar-day-number">@currentDate.Day</div>
                                        @if (isScheduled && isCurrentMonth)
                                        {
                                            <div class="staff-calendar-day-indicator">‚óè</div>
                                        }
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                </div>

                @* Upcoming Appointments *@
                <div class="col-12">
                    <div class="card">
                        <div class="card-header bg-light">
                            <h5 class="mb-0"><i class="bi bi-calendar-check"></i> Upcoming Appointments</h5>
                        </div>
                        <div class="card-body">
                            @if (!upcomingAppointments.Any())
                            {
                                <div class="text-center py-4 text-muted">
                                    <i class="bi bi-calendar-x" style="font-size: 3rem;"></i>
                                    <p class="mt-2">No upcoming appointments found for this therapist.</p>
                                </div>
                            }
                            else
                            {
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>Date & Time</th>
                                                <th>Client</th>
                                                <th>Service</th>
                                                <th>Duration</th>
                                                <th>Room</th>
                                                <th>Status</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var booking in upcomingAppointments.Take(20))
                                            {
                                                <tr>
                                                    <td>
                                                        <strong>@booking.StartTime.ToString("MMM dd, yyyy")</strong><br/>
                                                        <small class="text-muted">@booking.StartTime.ToString("h:mm tt") - @booking.EndTime.ToString("h:mm tt")</small>
                                                    </td>
                                                    <td>
                                                        <i class="bi bi-person-fill text-muted"></i>
                                                        @booking.Client.FirstName @booking.Client.LastName
                                                    </td>
                                                    <td>
                                                        <i class="bi bi-scissors text-muted"></i>
                                                        @booking.Service.Name
                                                    </td>
                                                    <td>
                                                        <i class="bi bi-clock text-muted"></i>
                                                        @((booking.EndTime - booking.StartTime).TotalMinutes) min
                                                    </td>
                                                    <td>
                                                        @if (booking.Room != null)
                                                        {
                                                            <span class="badge" style="background-color: @booking.Room.ColorCode;">
                                                                @booking.Room.Name
                                                            </span>
                                                        }
                                                        else
                                                        {
                                                            <span class="badge bg-secondary">Unassigned</span>
                                                        }
                                                    </td>
                                                    <td>
                                                        @switch (booking.Status)
                                                        {
                                                            case BookingStatus.Confirmed:
                                                                <span class="badge bg-success">Confirmed</span>
                                                                break;
                                                            case BookingStatus.Pending:
                                                                <span class="badge bg-warning">Pending</span>
                                                                break;
                                                            case BookingStatus.Completed:
                                                                <span class="badge bg-primary">Completed</span>
                                                                break;
                                                            case BookingStatus.Cancelled:
                                                                <span class="badge bg-danger">Cancelled</span>
                                                                break;
                                                            case BookingStatus.NoShow:
                                                                <span class="badge bg-dark">No Show</span>
                                                                break;
                                                        }
                                                    </td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                                @if (upcomingAppointments.Count > 20)
                                {
                                    <div class="text-center mt-3">
                                        <small class="text-muted">Showing first 20 of @upcomingAppointments.Count appointments</small>
                                    </div>
                                }
                            }
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>

@* Modal for All Staff Day View *@
@if (showDayDetailModal && selectedDate.HasValue)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-calendar-day"></i> Staff Schedule - @selectedDate.Value.ToString("MMMM dd, yyyy (dddd)")
                    </h5>
                    <button type="button" class="btn-close" @onclick="CloseDayDetailModal"></button>
                </div>
                <div class="modal-body">
                    @if (!string.IsNullOrEmpty(dayDetailError))
                    {
                        <div class="alert alert-danger alert-dismissible fade show">
                            <i class="bi bi-exclamation-triangle"></i> @dayDetailError
                            <button type="button" class="btn-close" @onclick="() => dayDetailError = null"></button>
                        </div>
                    }
                    
                    @if (!string.IsNullOrEmpty(dayDetailSuccess))
                    {
                        <div class="alert alert-success alert-dismissible fade show">
                            <i class="bi bi-check-circle"></i> @dayDetailSuccess
                            <button type="button" class="btn-close" @onclick="() => dayDetailSuccess = null"></button>
                        </div>
                    }
                    
                    @if (hasUnsavedDayChanges)
                    {
                        <div class="alert alert-warning mb-3">
                            <i class="bi bi-exclamation-triangle"></i> You have unsaved changes. Click "Save All Changes" to apply them.
                        </div>
                    }
                    
                    @if (dayDetailTherapists.Any())
                    {
                        <p class="text-muted mb-3">
                            <i class="bi bi-info-circle"></i> Edit any staff member's schedule for this day below.
                        </p>
                        
                        @foreach (var detail in dayDetailTherapists)
                        {
                            var isEditing = editingTherapistId == detail.therapist.Id;
                            
                            <div class="card mb-3">
                                <div class="card-body">
                                    <div class="row align-items-center">
                                        <div class="col-md-3">
                                            <h6 class="mb-0">
                                                <span class="badge" style="background-color: @detail.color; font-size: 1rem;">
                                                    @detail.therapist.FirstName @detail.therapist.LastName
                                                </span>
                                            </h6>
                                        </div>
                                        
                                        @if (isEditing)
                                        {
                                            <div class="col-md-7">
                                                <div class="row g-2">
                                                    <div class="col-md-4">
                                                        <label class="form-label small mb-1">Start Time</label>
                                                        <input type="time" class="form-control form-control-sm" value="@editStartTime" @onchange="@((e) => editStartTime = e.Value?.ToString() ?? "")" />
                                                    </div>
                                                    <div class="col-md-4">
                                                        <label class="form-label small mb-1">End Time</label>
                                                        <input type="time" class="form-control form-control-sm" value="@editEndTime" @onchange="@((e) => editEndTime = e.Value?.ToString() ?? "")" />
                                                    </div>
                                                    <div class="col-md-4">
                                                        <label class="form-label small mb-1">Notes</label>
                                                        <input type="text" class="form-control form-control-sm" @bind="editNotes" placeholder="Optional" />
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-2 text-end">
                                                <button type="button" class="btn btn-sm btn-success me-1" @onclick="() => ApplyTherapistEdit(detail.therapist.Id)">
                                                    <i class="bi bi-check"></i> Apply
                                                </button>
                                                <button type="button" class="btn btn-sm btn-secondary me-1" @onclick="CancelTherapistEdit">
                                                    <i class="bi bi-x"></i> Cancel
                                                </button>
                                                <button type="button" class="btn btn-sm btn-outline-danger" @onclick="() => RemoveTherapistFromDay(detail.therapist.Id)">
                                                    <i class="bi bi-x-circle"></i> Remove
                                                </button>
                                            </div>
                                        }
                                        else
                                        {
                                            <div class="col-md-7">
                                                <p class="mb-0">
                                                    <i class="bi bi-clock"></i> @FormatTimeSpanToAmPm(detail.startTime) - @FormatTimeSpanToAmPm(detail.endTime)
                                                </p>
                                            </div>
                                            <div class="col-md-2 text-end">
                                                <button type="button" class="btn btn-sm btn-outline-primary" @onclick="() => StartEditingTherapist(detail.therapist.Id, detail.startTime, detail.endTime)">
                                                    <i class="bi bi-pencil"></i> Edit
                                                </button>
                                            </div>
                                        }
                                    </div>
                                </div>
                            </div>
                        }
                    }
                    else
                    {
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i> No staff scheduled for this day.
                        </div>
                    }
                </div>
                <div class="modal-footer">
                    @if (hasUnsavedDayChanges)
                    {
                        <button type="button" class="btn btn-success" @onclick="SaveAllDayChanges">
                            <i class="bi bi-save"></i> Save All Changes
                        </button>
                    }
                    <button type="button" class="btn btn-secondary" @onclick="AttemptCloseDayDetailModal">Close</button>
                </div>
            </div>
        </div>
    </div>
}

@* Modal for Single Therapist Day Edit *@
@if (showEditDayModal && selectedDate.HasValue && !string.IsNullOrEmpty(selectedTherapistId))
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-calendar-plus"></i> Schedule for @selectedDate.Value.ToString("MMMM dd, yyyy (dddd)")
                    </h5>
                    <button type="button" class="btn-close" @onclick="CloseEditDayModal"></button>
                </div>
                <div class="modal-body">
                    @if (!string.IsNullOrEmpty(editDayError))
                    {
                        <div class="alert alert-danger">@editDayError</div>
                    }
                    
                    <div class="mb-3">
                        <label class="form-label">Time Range</label>
                        <div class="row g-2">
                            <div class="col-6">
                                <input type="time" class="form-control" value="@editDayStartTime" @onchange="@(e => editDayStartTime = e.Value?.ToString() ?? "09:00")" />
                                <small class="text-muted">Start</small>
                            </div>
                            <div class="col-6">
                                <input type="time" class="form-control" value="@editDayEndTime" @onchange="@(e => editDayEndTime = e.Value?.ToString() ?? "17:00")" />
                                <small class="text-muted">End</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Notes (Optional)</label>
                        <input type="text" class="form-control" @bind="editDayNotes" placeholder="e.g., Special hours" />
                    </div>
                    
                    @if (existingDaySchedule != null)
                    {
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle"></i> This day already has a schedule. Saving will update it.
                        </div>
                    }
                </div>
                <div class="modal-footer">
                    @if (existingDaySchedule != null)
                    {
                        <button type="button" class="btn btn-danger" @onclick="DeleteDaySchedule" disabled="@isSaving">
                            <i class="bi bi-trash"></i> Delete
                        </button>
                    }
                    <button type="button" class="btn btn-secondary" @onclick="CloseEditDayModal">Cancel</button>
                    <button type="button" class="btn btn-primary" @onclick="SaveDaySchedule" disabled="@isSaving">
                        @if (isSaving)
                        {
                            <span class="spinner-border spinner-border-sm me-2"></span>
                        }
                        <i class="bi bi-check-circle"></i> Save
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private enum CalendarViewMode { Day, Week, Month }
    
    private bool isLoading = true;
    private bool isSaving = false;
    private string? successMessage;
    private string? errorMessage;

    private List<ApplicationUser> therapists = new();
    private List<TherapistAvailability> schedules = new();
    private List<Booking> upcomingAppointments = new();
    
    private string? selectedTherapistId;
    private DateTime calendarViewDate = DateTime.Today;
    private CalendarViewMode calendarViewMode = CalendarViewMode.Month;
    
    private ScheduleModel scheduleModel = new();
    
    // Day detail modal (All Staff view)
    private bool showDayDetailModal = false;
    private DateTime? selectedDate;
    private List<(ApplicationUser therapist, string color, TimeSpan startTime, TimeSpan endTime)> dayDetailTherapists = new();
    private string? dayDetailError;
    private string? dayDetailSuccess;
    
    // Inline editing in day detail modal
    private string? editingTherapistId;
    private string editStartTime = "09:00";
    private string editEndTime = "17:00";
    private string? editNotes;
    private bool hasUnsavedDayChanges = false;
    private Dictionary<string, (TimeSpan startTime, TimeSpan endTime, string? notes)> pendingScheduleChanges = new();
    
    // Edit day modal (Single therapist view)
    private bool showEditDayModal = false;
    private string editDayStartTime = "09:00";
    private string editDayEndTime = "17:00";
    private string? editDayNotes;
    private string? editDayError;
    private TherapistAvailability? existingDaySchedule;

    protected override async Task OnInitializedAsync()
    {
        await LoadTherapists();
        isLoading = false;
    }

    private async Task LoadTherapists()
    {
        var therapistList = await UserManager.GetUsersInRoleAsync("Therapist");
        var adminList = await UserManager.GetUsersInRoleAsync("Admin");
        therapists = therapistList.Union(adminList).OrderBy(t => t.FirstName).ThenBy(t => t.LastName).ToList();
    }

    private async Task OnTherapistChanged(ChangeEventArgs e)
    {
        selectedTherapistId = e.Value?.ToString();
        if (!string.IsNullOrEmpty(selectedTherapistId))
        {
            await LoadSchedules();
            await LoadUpcomingAppointments();
            calendarViewDate = DateTime.Today;
        }
        else
        {
            schedules.Clear();
            upcomingAppointments.Clear();
        }
    }

    private async Task LoadSchedules()
    {
        if (string.IsNullOrEmpty(selectedTherapistId)) return;

        using var context = await DbContextFactory.CreateDbContextAsync();
        
        if (selectedTherapistId == "ALL_STAFF")
        {
            // Load all schedules for all therapists
            schedules = await context.TherapistAvailability
                .OrderBy(a => a.SpecificDate ?? DateTime.MinValue)
                .ThenBy(a => a.DayOfWeek)
                .ToListAsync();
        }
        else
        {
            // Load all schedules for this therapist (both weekly recurring and specific dates)
            schedules = await context.TherapistAvailability
                .Where(a => a.TherapistId == selectedTherapistId)
                .OrderBy(a => a.SpecificDate ?? DateTime.MinValue)
                .ThenBy(a => a.DayOfWeek)
                .ToListAsync();
        }
    }
    
    private async Task LoadUpcomingAppointments()
    {
        upcomingAppointments.Clear();
        
        if (string.IsNullOrEmpty(selectedTherapistId) || selectedTherapistId == "ALL_STAFF")
        {
            return; // Don't load appointments for All Staff view
        }

        using var context = await DbContextFactory.CreateDbContextAsync();
        var now = DateTime.UtcNow;
        
        upcomingAppointments = await context.Bookings
            .Include(b => b.Client)
            .Include(b => b.Service)
            .Include(b => b.Room)
            .Where(b => b.TherapistId == selectedTherapistId && 
                       b.StartTime >= now &&
                       b.Status != BookingStatus.Cancelled &&
                       b.Status != BookingStatus.NoShow)
            .OrderBy(b => b.StartTime)
            .ToListAsync();
    }

    private string GetCurrentWeekSummary()
    {
        if (!schedules.Any()) return "No schedules set - UNAVAILABLE";

        var today = DateTime.Today;
        var startOfWeek = today.AddDays(-(int)today.DayOfWeek);
        var daysScheduled = 0;

        for (int i = 0; i < 7; i++)
        {
            var checkDate = startOfWeek.AddDays(i);
            if (IsTherapistScheduledForDay(checkDate))
            {
                daysScheduled++;
            }
        }

        return $"{daysScheduled} days scheduled this week";
    }

    private bool IsTherapistScheduledForDay(DateTime date)
    {
        var utcDate = DateTime.SpecifyKind(date.Date, DateTimeKind.Utc);
        
        // Check specific date first
        var specificSchedule = schedules.FirstOrDefault(s => s.SpecificDate == utcDate && s.IsAvailable);
        if (specificSchedule != null) return true;

        // Check if specifically blocked
        var specificBlock = schedules.FirstOrDefault(s => s.SpecificDate == utcDate && !s.IsAvailable);
        if (specificBlock != null) return false;

        // Fall back to weekly schedule
        var weeklySchedule = schedules.FirstOrDefault(s => s.SpecificDate == null && s.DayOfWeek == date.DayOfWeek && s.IsAvailable);
        return weeklySchedule != null;
    }

    private string FormatTimeSpanToAmPm(TimeSpan time)
    {
        var dateTime = DateTime.Today.Add(time);
        return dateTime.ToString("h:mm tt");
    }
    
    private string GetAllStaffSummary()
    {
        var today = DateTime.Today;
        var startOfWeek = today.AddDays(-(int)today.DayOfWeek);
        var therapistScheduleCounts = new Dictionary<string, int>();

        foreach (var therapist in therapists)
        {
            var therapistSchedules = schedules.Where(s => s.TherapistId == therapist.Id).ToList();
            var daysScheduled = 0;

            for (int i = 0; i < 7; i++)
            {
                var checkDate = startOfWeek.AddDays(i);
                var isScheduled = IsTherapistScheduledForDayById(checkDate, therapist.Id, therapistSchedules);
                if (isScheduled) daysScheduled++;
            }

            if (daysScheduled > 0)
            {
                therapistScheduleCounts[$"{therapist.FirstName} {therapist.LastName}"] = daysScheduled;
            }
        }

        if (!therapistScheduleCounts.Any())
            return "No staff scheduled this week";

        var summary = string.Join(", ", therapistScheduleCounts.Select(kvp => $"{kvp.Key}: {kvp.Value} days"));
        return summary;
    }

    private bool IsTherapistScheduledForDayById(DateTime date, string therapistId, List<TherapistAvailability> therapistSchedules)
    {
        var utcDate = DateTime.SpecifyKind(date.Date, DateTimeKind.Utc);
        
        // Check specific date first
        var specificSchedule = therapistSchedules.FirstOrDefault(s => s.SpecificDate == utcDate && s.IsAvailable);
        if (specificSchedule != null) return true;

        // Check if specifically blocked
        var specificBlock = therapistSchedules.FirstOrDefault(s => s.SpecificDate == utcDate && !s.IsAvailable);
        if (specificBlock != null) return false;

        // Fall back to weekly schedule
        var weeklySchedule = therapistSchedules.FirstOrDefault(s => s.SpecificDate == null && s.DayOfWeek == date.DayOfWeek && s.IsAvailable);
        return weeklySchedule != null;
    }


    private async Task ApplySchedule()
    {
        if (string.IsNullOrEmpty(selectedTherapistId))
        {
            errorMessage = "Please select a therapist first.";
            return;
        }

        if (scheduleModel.StartDate > scheduleModel.EndDate)
        {
            errorMessage = "End date must be after start date.";
            return;
        }

        if (!TimeSpan.TryParse(scheduleModel.StartTime, out var startTime) || 
            !TimeSpan.TryParse(scheduleModel.EndTime, out var endTime))
        {
            errorMessage = "Invalid time format.";
            return;
        }

        if (startTime >= endTime)
        {
            errorMessage = "End time must be after start time.";
            return;
        }

        isSaving = true;
        errorMessage = null;

        try
        {
            using var context = await DbContextFactory.CreateDbContextAsync();
            
            var daysToSchedule = (scheduleModel.EndDate - scheduleModel.StartDate).Days + 1;
            var schedulesAdded = 0;

            for (int i = 0; i < daysToSchedule; i++)
            {
                var targetDate = scheduleModel.StartDate.AddDays(i);
                var utcTargetDate = DateTime.SpecifyKind(targetDate, DateTimeKind.Utc);
                
                // Check if schedule already exists for this specific date
                var existingSchedule = await context.TherapistAvailability
                    .FirstOrDefaultAsync(a => a.TherapistId == selectedTherapistId && a.SpecificDate == utcTargetDate);

                if (existingSchedule != null)
                {
                    // Update existing
                    existingSchedule.StartTime = startTime;
                    existingSchedule.EndTime = endTime;
                    existingSchedule.IsAvailable = true;
                    existingSchedule.Notes = scheduleModel.Notes;
                    existingSchedule.UpdatedAt = DateTime.UtcNow;
                }
                else
                {
                    // Create new
                    var newSchedule = new TherapistAvailability
                    {
                        TherapistId = selectedTherapistId,
                        DayOfWeek = targetDate.DayOfWeek,
                        StartTime = startTime,
                        EndTime = endTime,
                        IsAvailable = true,
                        SpecificDate = DateTime.SpecifyKind(targetDate, DateTimeKind.Utc),
                        Notes = scheduleModel.Notes,
                        CreatedAt = DateTime.UtcNow
                    };
                    context.TherapistAvailability.Add(newSchedule);
                    schedulesAdded++;
                }
            }

            await context.SaveChangesAsync();
            successMessage = $"Successfully scheduled {daysToSchedule} days ({schedulesAdded} new, {daysToSchedule - schedulesAdded} updated).";
            
            await LoadSchedules();
            
            // Reset form
            scheduleModel = new ScheduleModel();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error applying schedule: {ex.Message}";
        }
        finally
        {
            isSaving = false;
        }
    }

    private async Task DeleteSchedule(int scheduleId)
    {
        try
        {
            using var context = await DbContextFactory.CreateDbContextAsync();
            var schedule = await context.TherapistAvailability.FindAsync(scheduleId);
            
            if (schedule != null)
            {
                context.TherapistAvailability.Remove(schedule);
                await context.SaveChangesAsync();
                await LoadSchedules();
                successMessage = "Schedule deleted successfully.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error deleting schedule: {ex.Message}";
        }
    }

    private async Task ClearAllSchedules()
    {
        if (string.IsNullOrEmpty(selectedTherapistId)) return;

        try
        {
            using var context = await DbContextFactory.CreateDbContextAsync();
            var allSchedules = await context.TherapistAvailability
                .Where(a => a.TherapistId == selectedTherapistId)
                .ToListAsync();

            context.TherapistAvailability.RemoveRange(allSchedules);
            await context.SaveChangesAsync();
            
            await LoadSchedules();
            successMessage = $"Cleared all {allSchedules.Count} schedules.";
        }
        catch (Exception ex)
        {
            errorMessage = $"Error clearing schedules: {ex.Message}";
        }
    }

    private void SetCalendarViewMode(CalendarViewMode mode)
    {
        calendarViewMode = mode;
    }
    
    private void NavigatePrevious()
    {
        calendarViewDate = calendarViewMode switch
        {
            CalendarViewMode.Day => calendarViewDate.AddDays(-1),
            CalendarViewMode.Week => calendarViewDate.AddDays(-7),
            CalendarViewMode.Month => calendarViewDate.AddMonths(-1),
            _ => calendarViewDate
        };
    }

    private void NavigateNext()
    {
        calendarViewDate = calendarViewMode switch
        {
            CalendarViewMode.Day => calendarViewDate.AddDays(1),
            CalendarViewMode.Week => calendarViewDate.AddDays(7),
            CalendarViewMode.Month => calendarViewDate.AddMonths(1),
            _ => calendarViewDate
        };
    }
    
    private void GoToToday()
    {
        calendarViewDate = DateTime.Today;
    }
    
    private string GetCalendarViewTitle()
    {
        return calendarViewMode switch
        {
            CalendarViewMode.Day => calendarViewDate.ToString("MMMM dd, yyyy (dddd)"),
            CalendarViewMode.Week => $"{GetWeekStart().ToString("MMM dd")} - {GetWeekEnd().ToString("MMM dd, yyyy")}",
            CalendarViewMode.Month => calendarViewDate.ToString("MMMM yyyy"),
            _ => calendarViewDate.ToString("MMMM yyyy")
        };
    }
    
    private DateTime GetWeekStart()
    {
        return calendarViewDate.AddDays(-(int)calendarViewDate.DayOfWeek);
    }
    
    private DateTime GetWeekEnd()
    {
        return GetWeekStart().AddDays(6);
    }

    private RenderFragment RenderCalendar() => builder =>
    {
        var firstDayOfMonth = new DateTime(calendarViewDate.Year, calendarViewDate.Month, 1);
        var lastDayOfMonth = firstDayOfMonth.AddMonths(1).AddDays(-1);
        var startDate = firstDayOfMonth.AddDays(-(int)firstDayOfMonth.DayOfWeek);
        
        builder.OpenElement(0, "div");
        builder.AddAttribute(1, "class", "staff-calendar-grid");
        
        // Day headers
        var dayNames = new[] { "Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat" };
        foreach (var dayName in dayNames)
        {
            builder.OpenElement(2, "div");
            builder.AddAttribute(3, "class", "staff-calendar-day-header");
            builder.AddContent(4, dayName);
            builder.CloseElement();
        }
        
        // Calendar days
        var currentDate = startDate;
        for (int i = 0; i < 42; i++) // 6 weeks
        {
            var dateToCheck = currentDate;
            var isCurrentMonth = dateToCheck.Month == calendarViewDate.Month;
            var isScheduled = IsTherapistScheduledForDay(dateToCheck);
            var isPast = dateToCheck < DateTime.Today;
            
            var cssClass = "staff-calendar-day";
            if (!isCurrentMonth) cssClass += " staff-calendar-other-month";
            if (isPast) cssClass += " staff-calendar-past-day";
            if (isScheduled && !isPast) cssClass += " staff-calendar-scheduled-day";
            if (!isScheduled && !isPast && isCurrentMonth) cssClass += " staff-calendar-unscheduled-day";
            
            // Make clickable if not past and in current month
            if (!isPast && isCurrentMonth)
            {
                cssClass += " staff-calendar-clickable";
            }
            
            builder.OpenElement(5, "div");
            builder.AddAttribute(6, "class", cssClass);
            
            // Add click handler if not past and in current month
            if (!isPast && isCurrentMonth)
            {
                var capturedDate = dateToCheck;
                builder.AddAttribute(7, "onclick", Microsoft.AspNetCore.Components.EventCallback.Factory.Create(this, async () => await OnCalendarDayClick(capturedDate)));
            }
            
            builder.OpenElement(7, "div");
            builder.AddAttribute(8, "class", "staff-calendar-day-number");
            builder.AddContent(9, dateToCheck.Day);
            builder.CloseElement();
            
            if (isScheduled && isCurrentMonth)
            {
                builder.OpenElement(10, "div");
                builder.AddAttribute(11, "class", "staff-calendar-day-indicator");
                builder.AddContent(12, "‚óè");
                builder.CloseElement();
            }
            
            builder.CloseElement();
            
            currentDate = currentDate.AddDays(1);
        }
        
        builder.CloseElement();
    };

    private RenderFragment RenderAllStaffCalendar() => builder =>
    {
        var firstDayOfMonth = new DateTime(calendarViewDate.Year, calendarViewDate.Month, 1);
        var lastDayOfMonth = firstDayOfMonth.AddMonths(1).AddDays(-1);
        var startDate = firstDayOfMonth.AddDays(-(int)firstDayOfMonth.DayOfWeek);
        
        // Generate color palette for therapists
        var colors = new[] { "#3498db", "#e74c3c", "#2ecc71", "#f39c12", "#9b59b6", "#1abc9c", "#e67e22", "#95a5a6", "#34495e", "#16a085" };
        var therapistColors = new Dictionary<string, string>();
        for (int i = 0; i < therapists.Count; i++)
        {
            therapistColors[therapists[i].Id] = colors[i % colors.Length];
        }
        
        builder.OpenElement(0, "div");
        builder.AddAttribute(1, "class", "staff-calendar-grid");
        
        // Day headers
        var dayNames = new[] { "Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat" };
        foreach (var dayName in dayNames)
        {
            builder.OpenElement(2, "div");
            builder.AddAttribute(3, "class", "staff-calendar-day-header");
            builder.AddContent(4, dayName);
            builder.CloseElement();
        }
        
        // Calendar days
        var currentDate = startDate;
        for (int i = 0; i < 42; i++) // 6 weeks
        {
            var dateToCheck = currentDate;
            var isCurrentMonth = dateToCheck.Month == calendarViewDate.Month;
            var isPast = dateToCheck < DateTime.Today;
            
            // Get all therapists scheduled for this day
            var scheduledTherapists = new List<(ApplicationUser therapist, string color)>();
            foreach (var therapist in therapists)
            {
                var therapistSchedules = schedules.Where(s => s.TherapistId == therapist.Id).ToList();
                if (IsTherapistScheduledForDayById(dateToCheck, therapist.Id, therapistSchedules))
                {
                    scheduledTherapists.Add((therapist, therapistColors[therapist.Id]));
                }
            }
            
            var cssClass = "staff-calendar-day";
            if (!isCurrentMonth) cssClass += " staff-calendar-other-month";
            if (isPast) cssClass += " staff-calendar-past-day";
            
            // Make clickable if not past and in current month
            if (!isPast && isCurrentMonth)
            {
                cssClass += " staff-calendar-clickable";
            }
            
            builder.OpenElement(5, "div");
            builder.AddAttribute(6, "class", cssClass);
            
            // Add click handler for all staff view
            if (!isPast && isCurrentMonth)
            {
                var capturedDate = dateToCheck;
                builder.AddAttribute(7, "onclick", Microsoft.AspNetCore.Components.EventCallback.Factory.Create(this, () => OnAllStaffDayClick(capturedDate)));
            }
            
            builder.OpenElement(7, "div");
            builder.AddAttribute(8, "class", "staff-calendar-day-number");
            builder.AddContent(9, dateToCheck.Day);
            builder.CloseElement();
            
            // Show therapist badges if any are scheduled
            if (scheduledTherapists.Any() && isCurrentMonth && !isPast)
            {
                builder.OpenElement(10, "div");
                builder.AddAttribute(11, "style", "display: flex; flex-direction: column; gap: 2px; width: 100%; margin-top: 4px;");
                
                foreach (var (therapist, color) in scheduledTherapists)
                {
                    builder.OpenElement(12, "div");
                    builder.AddAttribute(13, "class", "staff-calendar-therapist-badge");
                    builder.AddAttribute(14, "style", $"background-color: {color};");
                    builder.AddAttribute(15, "title", $"{therapist.FirstName} {therapist.LastName}");
                    builder.AddContent(16, $"{therapist.FirstName.Substring(0, 1)}. {therapist.LastName}");
                    builder.CloseElement();
                }
                
                builder.CloseElement();
            }
            
            builder.CloseElement();
            
            currentDate = currentDate.AddDays(1);
        }
        
        builder.CloseElement();
        
        // Add legend
        builder.OpenElement(20, "div");
        builder.AddAttribute(21, "style", "margin-top: 20px; padding: 15px; background-color: #f8f9fa; border-radius: 4px;");
        
        builder.OpenElement(22, "h6");
        builder.AddContent(23, "Staff Legend:");
        builder.CloseElement();
        
        builder.OpenElement(24, "div");
        builder.AddAttribute(25, "style", "display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px;");
        
        foreach (var therapist in therapists)
        {
            builder.OpenElement(26, "div");
            builder.AddAttribute(27, "style", "display: flex; align-items: center; gap: 5px;");
            
            builder.OpenElement(28, "div");
            builder.AddAttribute(29, "style", $"width: 20px; height: 20px; background-color: {therapistColors[therapist.Id]}; border-radius: 3px;");
            builder.CloseElement();
            
            builder.OpenElement(30, "span");
            builder.AddContent(31, $"{therapist.FirstName} {therapist.LastName}");
            builder.CloseElement();
            
            builder.CloseElement();
        }
        
        builder.CloseElement();
        builder.CloseElement();
    };

    // Calendar day click handlers
    private async Task OnCalendarDayClick(DateTime date)
    {
        try
        {
            selectedDate = date;
            editDayError = null;
            
            // Load existing schedule for this day
            using var context = await DbContextFactory.CreateDbContextAsync();
            var utcDate = DateTime.SpecifyKind(date.Date, DateTimeKind.Utc);
            existingDaySchedule = await context.TherapistAvailability
                .FirstOrDefaultAsync(a => a.TherapistId == selectedTherapistId && a.SpecificDate == utcDate);
            
            if (existingDaySchedule != null)
            {
                editDayStartTime = existingDaySchedule.StartTime.ToString(@"HH\:mm");
                editDayEndTime = existingDaySchedule.EndTime.ToString(@"HH\:mm");
                editDayNotes = existingDaySchedule.Notes;
            }
            else
            {
                editDayStartTime = "09:00";
                editDayEndTime = "17:00";
                editDayNotes = null;
            }
            
            showEditDayModal = true;
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading schedule: {ex.Message}";
        }
    }
    
    private void OnAllStaffDayClick(DateTime date)
    {
        try
        {
            selectedDate = date;
            dayDetailTherapists.Clear();
            
            // Generate color palette
            var colors = new[] { "#3498db", "#e74c3c", "#2ecc71", "#f39c12", "#9b59b6", "#1abc9c", "#e67e22", "#95a5a6", "#34495e", "#16a085" };
            
            // Get all therapists scheduled for this day
            var utcDate = DateTime.SpecifyKind(date.Date, DateTimeKind.Utc);
            foreach (var therapist in therapists)
            {
                var therapistSchedules = schedules.Where(s => s.TherapistId == therapist.Id).ToList();
                
                // Check specific date first
                var specificSchedule = therapistSchedules.FirstOrDefault(s => s.SpecificDate == utcDate && s.IsAvailable);
                if (specificSchedule != null)
                {
                    var color = colors[therapists.IndexOf(therapist) % colors.Length];
                    dayDetailTherapists.Add((therapist, color, specificSchedule.StartTime, specificSchedule.EndTime));
                    continue;
                }
                
                // Check if specifically blocked
                var specificBlock = therapistSchedules.FirstOrDefault(s => s.SpecificDate == utcDate && !s.IsAvailable);
                if (specificBlock != null) continue;
                
                // Fall back to weekly schedule
                var weeklySchedule = therapistSchedules.FirstOrDefault(s => s.SpecificDate == null && s.DayOfWeek == date.DayOfWeek && s.IsAvailable);
                if (weeklySchedule != null)
                {
                    var color = colors[therapists.IndexOf(therapist) % colors.Length];
                    dayDetailTherapists.Add((therapist, color, weeklySchedule.StartTime, weeklySchedule.EndTime));
                }
            }
            
            showDayDetailModal = true;
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading day details: {ex.Message}";
        }
    }
    
    private void CloseDayDetailModal()
    {
        showDayDetailModal = false;
        selectedDate = null;
        dayDetailTherapists.Clear();
        editingTherapistId = null;
        dayDetailError = null;
        dayDetailSuccess = null;
        hasUnsavedDayChanges = false;
        pendingScheduleChanges.Clear();
    }
    
    private async Task AttemptCloseDayDetailModal()
    {
        if (hasUnsavedDayChanges)
        {
            bool confirmed = await JSRuntime.InvokeAsync<bool>("schedulerHelpers.confirmUnsavedChanges");
            if (!confirmed)
            {
                return; // User cancelled, keep modal open
            }
        }
        
        CloseDayDetailModal();
    }
    
    private void StartEditingTherapist(string therapistId, TimeSpan startTime, TimeSpan endTime)
    {
        editingTherapistId = therapistId;
        editStartTime = startTime.ToString(@"hh\:mm");
        editEndTime = endTime.ToString(@"hh\:mm");
        editNotes = null;
        dayDetailError = null;
        dayDetailSuccess = null;
    }
    
    private void CancelTherapistEdit()
    {
        editingTherapistId = null;
        dayDetailError = null;
    }
    
    private void ApplyTherapistEdit(string therapistId)
    {
        try
        {
            dayDetailError = null;
            dayDetailSuccess = null;
            
            if (!TimeSpan.TryParse(editStartTime, out var startTime) || !TimeSpan.TryParse(editEndTime, out var endTime))
            {
                dayDetailError = "Invalid time format.";
                return;
            }
            
            if (endTime <= startTime)
            {
                dayDetailError = "End time must be after start time.";
                return;
            }
            
            // Store the pending change
            pendingScheduleChanges[therapistId] = (startTime, endTime, editNotes);
            hasUnsavedDayChanges = true;
            
            // Update the display with the pending change
            var index = dayDetailTherapists.FindIndex(d => d.therapist.Id == therapistId);
            if (index >= 0)
            {
                var detail = dayDetailTherapists[index];
                dayDetailTherapists[index] = (detail.therapist, detail.color, startTime, endTime);
            }
            
            editingTherapistId = null;
        }
        catch (Exception ex)
        {
            dayDetailError = $"Error applying changes: {ex.Message}";
        }
    }
    
    private async Task SaveAllDayChanges()
    {
        if (!selectedDate.HasValue) return;
        
        try
        {
            dayDetailError = null;
            dayDetailSuccess = null;
            
            using var context = await DbContextFactory.CreateDbContextAsync();
            var utcDate = DateTime.SpecifyKind(selectedDate.Value.Date, DateTimeKind.Utc);
            
            foreach (var (therapistId, (startTime, endTime, notes)) in pendingScheduleChanges)
            {
                var schedule = await context.TherapistAvailability
                    .FirstOrDefaultAsync(a => a.TherapistId == therapistId && a.SpecificDate == utcDate);
                
                if (schedule != null)
                {
                    // Update existing schedule
                    schedule.StartTime = startTime;
                    schedule.EndTime = endTime;
                    schedule.Notes = notes;
                }
                else
                {
                    // Create new schedule
                    schedule = new TherapistAvailability
                    {
                        TherapistId = therapistId,
                        DayOfWeek = selectedDate.Value.DayOfWeek,
                        StartTime = startTime,
                        EndTime = endTime,
                        IsAvailable = true,
                        SpecificDate = utcDate,
                        Notes = notes,
                        CreatedAt = DateTime.UtcNow
                    };
                    context.TherapistAvailability.Add(schedule);
                }
            }
            
            await context.SaveChangesAsync();
            
            // Refresh the schedules to reflect changes in the calendar
            await LoadSchedules();
            
            // Clear pending changes
            pendingScheduleChanges.Clear();
            hasUnsavedDayChanges = false;
            
            dayDetailSuccess = $"{pendingScheduleChanges.Count} schedule(s) updated successfully!";
        }
        catch (Exception ex)
        {
            dayDetailError = $"Error saving changes: {ex.Message}";
        }
    }
    
    private async Task RemoveTherapistFromDay(string therapistId)
    {
        if (!selectedDate.HasValue) return;
        
        try
        {
            dayDetailError = null;
            dayDetailSuccess = null;
            
            using var context = await DbContextFactory.CreateDbContextAsync();
            var utcDate = DateTime.SpecifyKind(selectedDate.Value.Date, DateTimeKind.Utc);
            
            // Find any bookings for this therapist on this date
            var dayStart = utcDate;
            var dayEnd = utcDate.AddDays(1);
            
            var bookingsToReassign = await context.Bookings
                .Where(b => b.TherapistId == therapistId && 
                            b.StartTime >= dayStart && 
                            b.StartTime < dayEnd &&
                            b.Status != BookingStatus.Cancelled)
                .ToListAsync();
            
            // Unassign therapist from these bookings (keep room assignments)
            foreach (var booking in bookingsToReassign)
            {
                booking.TherapistId = null;
                // RoomId remains unchanged - we preserve room assignments
            }
            
            // Remove the therapist's schedule for this day
            var schedule = await context.TherapistAvailability
                .FirstOrDefaultAsync(a => a.TherapistId == therapistId && a.SpecificDate == utcDate);
            
            if (schedule != null)
            {
                context.TherapistAvailability.Remove(schedule);
            }
            
            await context.SaveChangesAsync();
            
            // Refresh the calendar schedules
            await LoadSchedules();
            
            // Refresh the day detail modal by reloading therapists for this day
            var savedDate = selectedDate.Value; // Save the date before clearing
            dayDetailTherapists.Clear();
            
            // Reload the therapists for this specific day
            using var refreshContext = await DbContextFactory.CreateDbContextAsync();
            var utcDateRefresh = DateTime.SpecifyKind(savedDate.Date, DateTimeKind.Utc);
            
            var therapistsForDay = await refreshContext.TherapistAvailability
                .Include(a => a.Therapist)
                .Where(a => a.SpecificDate == utcDateRefresh && a.IsAvailable)
                .ToListAsync();
            
            // Generate color palette for therapists
            var colors = new[] { "#3498db", "#e74c3c", "#2ecc71", "#f39c12", "#9b59b6", "#1abc9c", "#e67e22", "#95a5a6", "#34495e", "#16a085" };
            var colorIndex = 0;
            
            foreach (var availability in therapistsForDay)
            {
                var color = colors[colorIndex % colors.Length];
                dayDetailTherapists.Add((availability.Therapist, color, availability.StartTime, availability.EndTime));
                colorIndex++;
            }
            
            // Clear edit mode
            editingTherapistId = null;
            
            if (bookingsToReassign.Any())
            {
                dayDetailSuccess = $"Therapist removed from this day. {bookingsToReassign.Count} booking(s) moved to 'Unassigned' group.";
            }
            else
            {
                dayDetailSuccess = "Therapist removed from this day.";
            }
            
            await InvokeAsync(StateHasChanged);
        }
        catch (Exception ex)
        {
            dayDetailError = $"Error removing therapist: {ex.Message}";
        }
    }
    
    private async Task EditTherapistScheduleForDay(string therapistId, DateTime date)
    {
        // Close the day detail modal
        showDayDetailModal = false;
        
        // Set the selected therapist and date
        selectedTherapistId = therapistId;
        selectedDate = date;
        
        // Load schedules for this therapist
        await LoadSchedules();
        
        // Open the edit day modal (single therapist view)
        await OnCalendarDayClick(date);
    }
    
    private void CloseEditDayModal()
    {
        showEditDayModal = false;
        selectedDate = null;
        existingDaySchedule = null;
        editDayError = null;
    }
    
    private async Task SaveDaySchedule()
    {
        if (!selectedDate.HasValue || string.IsNullOrEmpty(selectedTherapistId)) return;
        
        if (!TimeSpan.TryParse(editDayStartTime, out var startTime) || !TimeSpan.TryParse(editDayEndTime, out var endTime))
        {
            editDayError = "Invalid time format.";
            return;
        }
        
        if (startTime >= endTime)
        {
            editDayError = "End time must be after start time.";
            return;
        }
        
        isSaving = true;
        editDayError = null;
        
        try
        {
            using var context = await DbContextFactory.CreateDbContextAsync();
            
            if (existingDaySchedule != null)
            {
                // Update existing
                var scheduleToUpdate = await context.TherapistAvailability.FindAsync(existingDaySchedule.Id);
                if (scheduleToUpdate != null)
                {
                    scheduleToUpdate.StartTime = startTime;
                    scheduleToUpdate.EndTime = endTime;
                    scheduleToUpdate.IsAvailable = true;
                    scheduleToUpdate.Notes = editDayNotes;
                    scheduleToUpdate.UpdatedAt = DateTime.UtcNow;
                }
            }
            else
            {
                // Create new
                var newSchedule = new TherapistAvailability
                {
                    TherapistId = selectedTherapistId,
                    DayOfWeek = selectedDate.Value.DayOfWeek,
                    StartTime = startTime,
                    EndTime = endTime,
                    IsAvailable = true,
                    SpecificDate = DateTime.SpecifyKind(selectedDate.Value.Date, DateTimeKind.Utc),
                    Notes = editDayNotes,
                    CreatedAt = DateTime.UtcNow
                };
                context.TherapistAvailability.Add(newSchedule);
            }
            
            await context.SaveChangesAsync();
            await LoadSchedules();
            successMessage = $"Schedule for {selectedDate.Value:MMMM dd, yyyy} saved successfully.";
            CloseEditDayModal();
        }
        catch (Exception ex)
        {
            editDayError = $"Error saving schedule: {ex.Message}";
        }
        finally
        {
            isSaving = false;
        }
    }
    
    private async Task DeleteDaySchedule()
    {
        if (existingDaySchedule == null) return;
        
        isSaving = true;
        
        try
        {
            using var context = await DbContextFactory.CreateDbContextAsync();
            var scheduleToDelete = await context.TherapistAvailability.FindAsync(existingDaySchedule.Id);
            
            if (scheduleToDelete != null)
            {
                context.TherapistAvailability.Remove(scheduleToDelete);
                await context.SaveChangesAsync();
                await LoadSchedules();
                successMessage = $"Schedule for {selectedDate.Value:MMMM dd, yyyy} deleted successfully.";
            }
            
            CloseEditDayModal();
        }
        catch (Exception ex)
        {
            editDayError = $"Error deleting schedule: {ex.Message}";
        }
        finally
        {
            isSaving = false;
        }
    }

    private class ScheduleModel
    {
        public DateTime StartDate { get; set; } = DateTime.Today;
        public DateTime EndDate { get; set; } = DateTime.Today;
        public string StartTime { get; set; } = "09:00";
        public string EndTime { get; set; } = "17:00";
        public string? Notes { get; set; }
    }
}

