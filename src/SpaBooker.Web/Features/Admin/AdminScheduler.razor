@page "/admin/scheduler"
@using Microsoft.EntityFrameworkCore
@using Microsoft.Extensions.Options
@using SpaBooker.Core.Entities
@using SpaBooker.Core.Enums
@using SpaBooker.Core.Settings
@using SpaBooker.Infrastructure.Data
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.JSInterop
@inject IDbContextFactory<ApplicationDbContext> DbContextFactory
@inject UserManager<ApplicationUser> UserManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject NavigationManager NavigationManager
@inject IOptions<BufferTimeSettings> BufferTimeOptions
@inject IJSRuntime JSRuntime
@attribute [Authorize(Roles = "Admin")]
@rendermode RenderMode.InteractiveServer

<PageTitle>Admin Scheduler - SpaBooker</PageTitle>

<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="text-rose-gold mb-2">
                <i class="bi bi-calendar3"></i> Scheduler Management
            </h1>
            <p class="text-muted">Manage room and therapist schedules</p>
        </div>
    </div>

    @if (!string.IsNullOrEmpty(loadError))
    {
        <div class="alert alert-danger">
            <h5><i class="bi bi-exclamation-triangle me-2"></i>Error Loading Scheduler</h5>
            <p class="mb-0">@loadError</p>
        </div>
    }

    @if (isLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3 text-muted">Loading schedule data...</p>
        </div>
    }
    else if (!locations.Any())
    {
        <div class="alert alert-warning">
            <i class="bi bi-info-circle me-2"></i>
            No active locations found. Please add locations first.
        </div>
    }
    else
    {
        <!-- Controls -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <!-- Location Selector -->
                            <div class="col-md-4 mb-3 mb-md-0">
                                <label class="form-label fw-bold mb-2">
                                    <i class="bi bi-geo-alt"></i> Location
                                </label>
                                <select class="form-select" @bind="selectedLocationId" @bind:after="OnLocationChanged">
                                    @foreach (var location in locations)
                                    {
                                        <option value="@location.Id">@location.Name</option>
                                    }
                                </select>
                            </div>

                            <!-- Date Navigation -->
                            <div class="col-md-4 mb-3 mb-md-0">
                                <label class="form-label fw-bold mb-2">
                                    <i class="bi bi-calendar-event"></i> Date
                                </label>
                                <div class="d-flex gap-2 align-items-center">
                                    <button class="btn btn-primary fw-bold" @onclick="NavigatePreviousDay" title="Previous Day">
                                        ◀
                                    </button>
                                    <div class="flex-grow-1 text-center date-display-box">
                                        <strong>@currentDate.ToString("dddd, dd/MM/yyyy")</strong>
                                    </div>
                                    <button class="btn btn-primary fw-bold" @onclick="NavigateNextDay" title="Next Day">
                                        ▶
                                    </button>
                                </div>
                            </div>

                            <!-- Today Button -->
                            <div class="col-md-4 text-md-end">
                                <label class="form-label fw-bold mb-2 d-block">&nbsp;</label>
                                <button class="btn btn-primary" @onclick="GoToToday">
                                    <i class="bi bi-calendar-check"></i> Today
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        @if (!rooms.Any() && !therapists.Any())
        {
            <div class="alert alert-info">
                <i class="bi bi-info-circle me-2"></i>
                No rooms or therapists found for this location. Please ensure rooms are configured and therapists have bookings at this location.
            </div>
        }
        else
        {
            <!-- View Options -->
            <div class="row mb-3">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body py-2">
                            <div class="d-flex align-items-center gap-4">
                                <label class="form-label fw-bold mb-0">
                                    <i class="bi bi-eye"></i> Show:
                                </label>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="showRoomsCheckbox" 
                                           checked="@showRooms" @onchange="ToggleRoomsView">
                                    <label class="form-check-label" for="showRoomsCheckbox">
                                        Rooms
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="showTherapistsCheckbox" 
                                           checked="@showTherapists" @onchange="ToggleTherapistsView">
                                    <label class="form-check-label" for="showTherapistsCheckbox">
                                        Therapists
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            @ClearRenderedBookings()
            <!-- Schedule Grid -->
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body p-0">
                            <div class="schedule-grid-container">
                                <div class="schedule-grid" style="grid-template-columns: 80px repeat(@((showRooms ? rooms.Count : 0) + (showTherapists ? therapists.Count : 0)), minmax(150px, 1fr));">
                                    <!-- Header Row -->
                                    <div class="grid-cell header-cell time-header">Time</div>
                                    
                                    @if (rooms.Any() && showRooms)
                                    {
                                        <div class="grid-cell header-cell section-divider room-header-section" style="grid-column: span @rooms.Count;">
                                            <strong>ROOMS (@rooms.Count)</strong>
                                        </div>
                                    }
                                    
                                    @if (therapists.Any() && showTherapists)
                                    {
                                        <div class="grid-cell header-cell section-divider therapist-header-section" style="grid-column: span @therapists.Count;">
                                            <strong>THERAPISTS (@therapists.Count)</strong>
                                        </div>
                                    }

                                    <!-- Sub-header with names -->
                                    <div class="grid-cell time-header"></div>
                                    
                                    @if (showRooms)
                                    {
                                        @foreach (var room in rooms)
                                        {
                                            <div class="grid-cell column-header room-column">
                                                <div class="room-badge" style="background-color: @room.ColorCode;">
                                                    @room.Name
                                                </div>
                                            </div>
                                        }
                                    }
                                    
                                    @if (showTherapists)
                                    {
                                        var isFirstTherapist = true;
                                        @foreach (var therapist in therapists)
                                        {
                                            <div class="grid-cell column-header therapist-column @(isFirstTherapist ? "first-therapist-column" : "")">
                                                <i class="bi bi-person"></i>
                                                <div class="small">@therapist.FirstName</div>
                                                <div class="small">@therapist.LastName</div>
                                            </div>
                                            isFirstTherapist = false;
                                        }
                                    }

                                    <!-- Time Slot Rows -->
                                    @{ int rowNum = 3; } @* Start after header rows *@
                                    @foreach (var timeSlot in timeSlots)
                                    {
                                        var slotEnd = timeSlot.Add(TimeSpan.FromMinutes(15));
                                        int colNum = 2; // Start after time column
                                        
                                        <div class="grid-cell time-cell" style="grid-column: 1; grid-row: @rowNum;">
                                            @timeSlot.ToString(@"hh\:mm")
                                        </div>

                                        @* Room Cells *@
                                        @if (showRooms)
                                        {
                                            @foreach (var room in rooms)
                                            {
                                            var booking = GetBookingForRoomSlot(room.Id, timeSlot, slotEnd);
                                            var shouldRender = ShouldRenderRoomBooking(booking);
                                            
                                            @* Skip rendering for cells covered by merged bookings (they're already occupied by spanning cell) *@
                                            @if (!shouldRender && booking != null)
                                            {
                                                @* Do nothing - this grid position is occupied by a spanning cell from a previous row *@
                                                @* colNum++ is handled at the end of the loop *@
                                            }
                                            else if (shouldRender && booking != null)
                                            {
                                                // Calculate span and mark as rendered (room section only)
                                                var span = CalculateBookingSpan(booking, timeSlot);
                                                renderedRoomBookingIds.Add(booking.Id);
                                                
                                                var currentRoom = room;
                                                var currentTimeSlot = timeSlot;
                                                var currentBooking = booking;
                                                
                                                <button type="button" class="grid-cell slot-cell room-slot occupied merged-slot" 
                                                        style="grid-column: @colNum; grid-row: @rowNum / span @span;" 
                                                        @onclick="() => HandleRoomSlotClick(currentRoom, currentTimeSlot, currentBooking)" 
                                                        @onclick:stopPropagation="true">
                                                    <div class="booking-info">
                                                        <div class="time-label">@booking.StartTime.ToString("HH:mm") - @booking.EndTime.ToString("HH:mm")</div>
                                                        <div class="client-name">@booking.Client.FirstName @booking.Client.LastName</div>
                                                        <div class="service-name">@booking.Service.Name</div>
                                                        <div class="therapist-badge">
                                                            <i class="bi bi-person-fill"></i> @booking.Therapist.FirstName
                                                        </div>
                                                    </div>
                                                </button>
                                            }
                                            else if (booking == null)
                                            {
                                                var currentRoom = room;
                                                var currentTimeSlot = timeSlot;
                                                var isBuffer = IsBufferSlot(room.Id, timeSlot, slotEnd);
                                                
                                                @if (isBuffer)
                                                {
                                                    <div class="grid-cell slot-cell room-slot buffer-slot" style="grid-column: @colNum; grid-row: @rowNum;">
                                                        <div class="buffer-label">
                                                            <i class="bi bi-hourglass-split"></i>
                                                            <div class="small">Buffer</div>
                                                        </div>
                                                    </div>
                                                }
                                                else
                                                {
                                                    <button type="button" class="grid-cell slot-cell room-slot available" 
                                                            style="grid-column: @colNum; grid-row: @rowNum;"
                                                            @onclick="() => HandleRoomSlotClick(currentRoom, currentTimeSlot, null)" 
                                                            @onclick:stopPropagation="true">
                                                    <div class="available-label">
                                                        <i class="bi bi-plus-circle"></i>
                                                        <div class="small">Available</div>
                                                    </div>
                                                    </button>
                                                }
                                            }
                                            colNum++;
                                            }
                                        }

                                        @* Therapist Cells *@
                                        @if (showTherapists)
                                        {
                                            colNum = 2 + (showRooms ? rooms.Count : 0); // Start after time + room columns (if shown)
                                            var isFirstTherapistCell = true;
                                            @foreach (var therapist in therapists)
                                            {
                                            var booking = GetBookingForTherapistSlot(therapist.Id, timeSlot, slotEnd);
                                            var isScheduled = IsTherapistScheduledForSlot(therapist.Id, timeSlot);
                                            var shouldRender = ShouldRenderTherapistBooking(booking);
                                            var firstTherapistClass = isFirstTherapistCell ? "first-therapist" : "";
                                            
                                            @* Skip rendering for cells covered by merged bookings (they're already occupied by spanning cell) *@
                                            @if (!shouldRender && booking != null)
                                            {
                                                @* Do nothing - this grid position is occupied by a spanning cell from a previous row *@
                                                @* colNum++ is handled at the end of the loop *@
                                            }
                                            else if (shouldRender && booking != null)
                                            {
                                                // Calculate span and mark as rendered (therapist section only)
                                                var span = CalculateBookingSpan(booking, timeSlot);
                                                renderedTherapistBookingIds.Add(booking.Id);
                                                
                                                var currentTherapist = therapist;
                                                var currentTimeSlot = timeSlot;
                                                var currentBooking = booking;
                                                
                                                <button type="button" class="grid-cell slot-cell therapist-slot occupied merged-slot @firstTherapistClass" 
                                                        style="grid-column: @colNum; grid-row: @rowNum / span @span;" 
                                                        @onclick="() => HandleTherapistSlotClick(currentTherapist, currentTimeSlot, currentBooking)" 
                                                        @onclick:stopPropagation="true">
                                                    <div class="booking-info">
                                                        <div class="time-label">@booking.StartTime.ToString("HH:mm") - @booking.EndTime.ToString("HH:mm")</div>
                                                        <div class="client-name">@booking.Client.FirstName @booking.Client.LastName</div>
                                                        <div class="service-name">@booking.Service.Name</div>
                                                        @if (booking.Room != null)
                                                        {
                                                            <div class="room-badge-small" style="background-color: @booking.Room.ColorCode;">
                                                                @booking.Room.Name
                                                            </div>
                                                        }
                                                    </div>
                                                </button>
                                            }
                                            else if (!isScheduled)
                                            {
                                                var currentTherapist = therapist;
                                                var currentTimeSlot = timeSlot;
                                                
                                                <button type="button" class="grid-cell slot-cell therapist-slot unavailable @firstTherapistClass" 
                                                        style="grid-column: @colNum; grid-row: @rowNum;"
                                                        @onclick="() => HandleTherapistSlotClick(currentTherapist, currentTimeSlot, null)" 
                                                        @onclick:stopPropagation="true">
                                                    <div class="blocked-info">
                                                        <i class="bi bi-calendar-x"></i>
                                                        <div class="small">Not Scheduled</div>
                                                    </div>
                                                </button>
                                            }
                                            else if (booking == null)
                                            {
                                                var currentTherapist = therapist;
                                                var currentTimeSlot = timeSlot;
                                                
                                                <button type="button" class="grid-cell slot-cell therapist-slot available @firstTherapistClass" 
                                                        style="grid-column: @colNum; grid-row: @rowNum;"
                                                        @onclick="() => HandleTherapistSlotClick(currentTherapist, currentTimeSlot, null)" 
                                                        @onclick:stopPropagation="true">
                                                    <div class="available-label">
                                                        <i class="bi bi-plus-circle"></i>
                                                        <div class="small">Available</div>
                                                    </div>
                                                </button>
                                            }
                                            colNum++;
                                            isFirstTherapistCell = false;
                                            }
                                        }
                                        rowNum++;
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        }
    }
</div>

<!-- Assignment Modal -->
@if (showAssignmentModal)
{
    <div class="modal-backdrop show"></div>
    <div class="modal show d-block" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-calendar-plus"></i> Create Booking
                    </h5>
                    <button type="button" class="btn-close" @onclick="CloseAssignmentModal"></button>
                </div>
                <div class="modal-body">
                    @if (!string.IsNullOrEmpty(assignmentError))
                    {
                        <div class="alert alert-danger">
                            <i class="bi bi-exclamation-triangle me-2"></i>@assignmentError
                        </div>
                    }

                    <div class="row mb-3">
                        <div class="col-md-4">
                            <strong>Room:</strong> @selectedRoom?.Name
                        </div>
                        <div class="col-md-4">
                            <strong>Time:</strong> @selectedTimeSlot.ToString(@"hh\:mm")
                        </div>
                        <div class="col-md-4">
                            @{
                                var availableMins = selectedRoom != null ? GetAvailableMinutesForRoom(selectedRoom.Id, currentDate.Date.Add(selectedTimeSlot)) : 0;
                            }
                            <strong>Available:</strong> 
                            <span class="badge bg-info">@availableMins min</span>
                        </div>
                    </div>

                    @if (availableServices.Any())
                    {
                        <div class="alert alert-info mb-3">
                            <i class="bi bi-info-circle me-2"></i>
                            <strong>@availableServices.Count service(s)</strong> available that fit in this time slot and are compatible with this room.
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-warning mb-3">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            <strong>No services available.</strong> Either no services are configured for this room, or there isn't enough time before the next booking.
                        </div>
                    }

                    <div class="mb-3">
                        <label class="form-label">Therapist *</label>
                        <select class="form-select" @bind="assignmentModel.TherapistId" @bind:after="OnTherapistSelected">
                            <option value="">-- Select Therapist --</option>
                            @foreach (var therapist in availableTherapists)
                            {
                                <option value="@therapist.Id">@therapist.FirstName @therapist.LastName</option>
                            }
                        </select>
                        @if (!availableTherapists.Any())
                        {
                            <small class="text-danger">⚠️ No therapists available for this time slot</small>
                        }
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Service *</label>
                        <select class="form-select" @bind="assignmentModel.ServiceId" disabled="@(!availableServices.Any())">
                            <option value="0">-- Select Service --</option>
                            @foreach (var service in availableServices)
                            {
                                <option value="@service.Id">@service.Name (@service.DurationMinutes min - $@service.BasePrice.ToString("F2"))</option>
                            }
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Client *</label>
                        <div class="position-relative">
                            <input type="text" 
                                   class="form-control" 
                                   placeholder="Search by name or email..."
                                   @bind="assignmentClientSearchText"
                                   @bind:event="oninput"
                                   @onfocus="() => showAssignmentClientDropdown = true"
                                   autocomplete="off" />
                            
                            @if (showAssignmentClientDropdown && filteredAssignmentClients.Any())
                            {
                                <div class="client-search-results">
                                    @foreach (var client in filteredAssignmentClients.Take(10))
                            {
                                        <div class="client-search-item" @onclick="() => SelectAssignmentClient(client)">
                                            <div class="fw-bold">@client.FirstName @client.LastName</div>
                                            <small class="text-muted">@client.Email</small>
                                        </div>
                                    }
                                </div>
                            }
                            
                            @if (!string.IsNullOrEmpty(selectedAssignmentClientName))
                            {
                                <div class="alert alert-success mt-2 py-2 d-flex justify-content-between align-items-center">
                                    <span><i class="bi bi-check-circle me-2"></i>Selected: <strong>@selectedAssignmentClientName</strong></span>
                                    <button type="button" class="btn btn-sm btn-outline-secondary" @onclick="ClearAssignmentClientSelection">
                                        <i class="bi bi-x"></i> Clear
                                    </button>
                                </div>
                            }
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Notes</label>
                        <textarea class="form-control" @bind="assignmentModel.Notes" rows="2"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseAssignmentModal">Cancel</button>
                    <button type="button" class="btn btn-primary" @onclick="SaveAssignment" disabled="@isSaving">
                        @if (isSaving)
                        {
                            <span class="spinner-border spinner-border-sm me-2"></span>
                        }
                        Create Booking
                    </button>
                </div>
            </div>
        </div>
    </div>
}

<!-- Therapist Booking Modal -->
@if (showTherapistBookingModal)
{
    <div class="modal-backdrop show"></div>
    <div class="modal show d-block" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-calendar-plus"></i> Book @selectedTherapist?.FirstName @selectedTherapist?.LastName
                    </h5>
                    <button type="button" class="btn-close" @onclick="CloseTherapistBookingModal"></button>
                </div>
                <div class="modal-body">
                    @if (!string.IsNullOrEmpty(therapistBookingError))
                    {
                        <div class="alert alert-danger">
                            <i class="bi bi-exclamation-triangle me-2"></i>@therapistBookingError
                        </div>
                    }

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong>Therapist:</strong> @selectedTherapist?.FirstName @selectedTherapist?.LastName
                        </div>
                        <div class="col-md-6">
                            <strong>Date:</strong> @currentDate.ToString("MMM dd, yyyy")
                        </div>
                    </div>

                    <!-- Time Selection -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Start Time *</label>
                            <input type="time" class="form-control" value="@therapistBookingModel.StartTime" 
                                   @onchange="@((ChangeEventArgs e) => therapistBookingModel.StartTime = e.Value?.ToString() ?? string.Empty)" />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">End Time *</label>
                            <input type="time" class="form-control" value="@therapistBookingModel.EndTime" 
                                   @onchange="@((ChangeEventArgs e) => therapistBookingModel.EndTime = e.Value?.ToString() ?? string.Empty)" />
                        </div>
                    </div>

                    <!-- Service Selection -->
                    <div class="mb-3">
                        <label class="form-label">Service *</label>
                        <select class="form-select" @bind="therapistBookingModel.ServiceId" @bind:after="OnTherapistServiceSelected">
                            <option value="0">-- Select a service --</option>
                            @foreach (var service in availableServicesForTherapist)
                            {
                                <option value="@service.Id">
                                    @service.Name (@service.DurationMinutes min - $@service.BasePrice.ToString("F2"))
                                </option>
                            }
                        </select>
                    </div>

                    <!-- Room Selection -->
                    @if (therapistBookingModel.ServiceId > 0)
                    {
                        <div class="mb-3">
                            <label class="form-label">Room</label>
                            @if (availableRoomsForTherapistBooking.Any())
                            {
                                <select class="form-select" @bind="therapistBookingModel.RoomId">
                                    <option value="">-- Select a room (optional) --</option>
                                    @foreach (var room in availableRoomsForTherapistBooking)
                                    {
                                        <option value="@room.Id">@room.Name</option>
                                    }
                                </select>
                                <small class="text-muted">@availableRoomsForTherapistBooking.Count room(s) available for this time slot</small>
                            }
                            else
                            {
                                <div class="alert alert-warning py-2 mb-0">
                                    <i class="bi bi-exclamation-triangle me-2"></i>
                                    No rooms available for this service and time slot
                                </div>
                            }
                        </div>
                    }

                    <!-- Client Selection -->
                    <div class="mb-3">
                        <label class="form-label">Client *</label>
                        <div class="position-relative">
                            <input type="text" 
                                   class="form-control" 
                                   placeholder="Search by name or email..."
                                   @bind="clientSearchText"
                                   @bind:event="oninput"
                                   @onfocus="() => showClientDropdown = true"
                                   autocomplete="off" />
                            
                            @if (showClientDropdown && filteredClients.Any())
                            {
                                <div class="client-search-results">
                                    @foreach (var client in filteredClients.Take(10))
                                    {
                                        <div class="client-search-item" @onclick="() => SelectClient(client)">
                                            <div class="fw-bold">@client.FirstName @client.LastName</div>
                                            <small class="text-muted">@client.Email</small>
                                        </div>
                                    }
                                </div>
                            }
                            
                            @if (!string.IsNullOrEmpty(selectedClientName))
                            {
                                <div class="alert alert-success mt-2 py-2 d-flex justify-content-between align-items-center">
                                    <span><i class="bi bi-check-circle me-2"></i>Selected: <strong>@selectedClientName</strong></span>
                                    <button type="button" class="btn btn-sm btn-outline-secondary" @onclick="ClearClientSelection">
                                        <i class="bi bi-x"></i> Clear
                                    </button>
                                </div>
                            }
                        </div>
                    </div>

                    <!-- Notes -->
                    <div class="mb-3">
                        <label class="form-label">Notes (Optional)</label>
                        <textarea class="form-control" rows="2" @bind="therapistBookingModel.Notes"></textarea>
                    </div>

                    <!-- Room Assignment Info -->
                    @if (!string.IsNullOrEmpty(therapistBookingModel.AssignedRoomName))
                    {
                        <div class="alert alert-info">
                            <i class="bi bi-door-open me-2"></i>
                            Will be assigned to: <strong>@therapistBookingModel.AssignedRoomName</strong>
                        </div>
                    }
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseTherapistBookingModal">Cancel</button>
                    <button type="button" class="btn btn-primary" @onclick="SaveTherapistBooking" disabled="@isSaving">
                        @if (isSaving)
                        {
                            <span class="spinner-border spinner-border-sm me-2"></span>
                        }
                        Create Booking
                    </button>
                </div>
            </div>
        </div>
    </div>
}

<!-- Booking Details Modal -->
@if (selectedBooking != null)
{
    <div class="modal-backdrop show"></div>
    <div class="modal show d-block" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-calendar-event"></i> Booking Details
                    </h5>
                    <button type="button" class="btn-close" @onclick="AttemptCloseBookingModal"></button>
                </div>
                <div class="modal-body">
                    @if (!string.IsNullOrEmpty(loadError))
                    {
                        <div class="alert alert-danger alert-dismissible fade show" role="alert">
                            <i class="bi bi-exclamation-triangle-fill"></i> <strong>Error:</strong> @loadError
                            <button type="button" class="btn-close" @onclick="() => loadError = null"></button>
                        </div>
                    }
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-rose-gold mb-3">Appointment Information</h6>
                            <dl class="row mb-0">
                                <dt class="col-sm-4">Service:</dt>
                                <dd class="col-sm-8">@selectedBooking.Service.Name</dd>
                                
                                <dt class="col-sm-4">Date:</dt>
                                <dd class="col-sm-8">
                                    <input type="date" 
                                           class="form-control form-control-sm" 
                                           style="max-width: 250px;"
                                           value="@editedDate"
                                           @onchange="@(e => { editedDate = e.Value?.ToString() ?? ""; hasUnsavedChanges = true; })" />
                                </dd>
                                
                                <dt class="col-sm-4">Start Time:</dt>
                                <dd class="col-sm-8">
                                    <input type="time" 
                                           class="form-control form-control-sm" 
                                           style="max-width: 150px;"
                                           value="@editedStartTime"
                                           @onchange="@(e => { editedStartTime = e.Value?.ToString() ?? ""; hasUnsavedChanges = true; })" />
                                </dd>
                                
                                <dt class="col-sm-4">End Time:</dt>
                                <dd class="col-sm-8">
                                    <input type="time" 
                                           class="form-control form-control-sm" 
                                           style="max-width: 150px;"
                                           value="@editedEndTime"
                                           @onchange="@(e => { editedEndTime = e.Value?.ToString() ?? ""; hasUnsavedChanges = true; })" />
                                </dd>
                                
                                <dt class="col-sm-4">Status:</dt>
                                <dd class="col-sm-8">
                                    <span class="badge @GetStatusBadgeClass(selectedBooking.Status)">
                                        @selectedBooking.Status
                                    </span>
                                </dd>
                                
                                <dt class="col-sm-4">Therapist:</dt>
                                <dd class="col-sm-8">
                                    <select class="form-select form-select-sm" 
                                            @bind="editedTherapistId"
                                            @bind:after="() => hasUnsavedChanges = true"
                                            style="max-width: 250px;">
                                        @foreach (var therapist in therapists)
                                        {
                                            <option value="@therapist.Id">@therapist.FirstName @therapist.LastName</option>
                                        }
                                    </select>
                                </dd>
                                
                                <dt class="col-sm-4">Room:</dt>
                                <dd class="col-sm-8">
                                    <select class="form-select form-select-sm" 
                                            @bind="editedRoomId"
                                            @bind:after="() => hasUnsavedChanges = true"
                                            style="max-width: 250px;">
                                        <option value="">Unassigned</option>
                                        @foreach (var room in rooms)
                                        {
                                            <option value="@room.Id">@room.Name</option>
                                        }
                                    </select>
                                </dd>
                            </dl>
                            
                            @if (!string.IsNullOrEmpty(roomAssignmentError))
                            {
                                <div class="alert alert-danger alert-sm mt-2 mb-0">
                                    <i class="bi bi-exclamation-triangle"></i> @roomAssignmentError
                                </div>
                            }
                        </div>
                        
                        <div class="col-md-6">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6 class="text-rose-gold mb-0">Client Information</h6>
                                @if (selectedBooking.Status != BookingStatus.Cancelled)
                                {
                                    <button type="button" class="btn btn-sm btn-outline-secondary" @onclick="ConfirmCancelBooking" title="Cancel this booking">
                                        <i class="bi bi-x-circle"></i> Cancel Booking
                                    </button>
                                }
                            </div>
                            <dl class="row mb-0">
                                <dt class="col-sm-4">Name:</dt>
                                <dd class="col-sm-8">
                                    <a href="javascript:void(0)" 
                                       class="text-decoration-none fw-bold client-name-link"
                                       @onclick="async () => await ShowClientCard(selectedBooking.Client.Id)"
                                       @onclick:stopPropagation="true">
                                        @selectedBooking.Client.FirstName @selectedBooking.Client.LastName
                                    </a>
                                </dd>
                                
                                <dt class="col-sm-4">Email:</dt>
                                <dd class="col-sm-8">
                                    <a href="mailto:@selectedBooking.Client.Email" class="text-decoration-none">
                                        @selectedBooking.Client.Email
                                    </a>
                                </dd>
                                
                                <dt class="col-sm-4">Phone:</dt>
                                <dd class="col-sm-8">@selectedBooking.Client.PhoneNumber</dd>
                            </dl>
                        </div>
                    </div>
                    
                    <!-- Most Recent Client Note Section -->
                    <div class="mt-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="text-rose-gold mb-0">Most Recent Client Note:</h6>
                        </div>
                        @if (mostRecentClientNote != null)
                        {
                            <div class="alert alert-secondary mb-2">
                                <div class="d-flex justify-content-between align-items-start mb-1">
                                    <small class="text-muted">
                                        <i class="bi bi-calendar3"></i> @mostRecentClientNote.CreatedAt.ToString("MMM dd, yyyy 'at' h:mm tt")
                                        @if (!string.IsNullOrEmpty(mostRecentClientNote.CreatedByName))
                                        {
                                            <span> - by @mostRecentClientNote.CreatedByName</span>
                                        }
                                    </small>
                                    @if (!string.IsNullOrEmpty(mostRecentClientNote.NoteType))
                                    {
                                        <span class="badge bg-info">@mostRecentClientNote.NoteType</span>
                                    }
                                </div>
                                <div>@mostRecentClientNote.Content</div>
                            </div>
                        }
                        else
                        {
                            <div class="alert alert-secondary mb-2">
                                <em class="text-muted">No notes available for this client</em>
                            </div>
                        }
                        <button type="button" class="btn btn-outline-primary btn-sm w-100" @onclick="NavigateToClientNotes">
                            <i class="bi bi-journal-text"></i> View All Client Notes
                        </button>
                    </div>
                    
                    @if (!string.IsNullOrEmpty(selectedBooking.Notes))
                    {
                        <div class="mt-3">
                            <h6 class="text-rose-gold">Appointment Notes:</h6>
                            <div class="alert alert-info mb-0">@selectedBooking.Notes</div>
                        </div>
                    }
                </div>
                <div class="modal-footer">
                    @if (hasUnsavedChanges)
                    {
                        <div class="alert alert-warning mb-0 me-auto">
                            <i class="bi bi-exclamation-triangle"></i> You have unsaved changes
                        </div>
                    }
                    @if (selectedBooking.Status == BookingStatus.Pending)
                    {
                        <button type="button" class="btn btn-success" @onclick="ConfirmBooking">
                            <i class="bi bi-check-circle"></i> Confirm
                        </button>
                    }
                    @if (hasUnsavedChanges)
                    {
                        <button type="button" class="btn btn-primary" @onclick="SaveBookingChanges" disabled="@isSaving">
                            @if (isSaving)
                            {
                                <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                            }
                            <i class="bi bi-save"></i> Save Changes
                        </button>
                    }
                    <button type="button" class="btn btn-secondary" @onclick="AttemptCloseBookingModal">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>
}

<!-- Client Card Modal -->
@if (showClientCard && selectedClient != null)
{
    <div class="modal-backdrop show"></div>
    <div class="modal show d-block" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-person-circle"></i> Client Information
                    </h5>
                    <button type="button" class="btn-close" @onclick="CloseClientCard"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-rose-gold mb-3">Personal Details</h6>
                            <dl class="row">
                                <dt class="col-sm-4">Name:</dt>
                                <dd class="col-sm-8">@selectedClient.FirstName @selectedClient.LastName</dd>
                                
                                <dt class="col-sm-4">Email:</dt>
                                <dd class="col-sm-8">
                                    <a href="mailto:@selectedClient.Email">@selectedClient.Email</a>
                                </dd>
                                
                                <dt class="col-sm-4">Phone:</dt>
                                <dd class="col-sm-8">
                                    @if (!string.IsNullOrEmpty(selectedClient.PhoneNumber))
                                    {
                                        <a href="tel:@selectedClient.PhoneNumber">@selectedClient.PhoneNumber</a>
                                    }
                                    else
                                    {
                                        <span class="text-muted">Not provided</span>
                                    }
                                </dd>
                                
                                <dt class="col-sm-4">Member Since:</dt>
                                <dd class="col-sm-8">@selectedClient.CreatedAt.ToString("MMM dd, yyyy")</dd>
                            </dl>
                        </div>
                        
                        <div class="col-md-6">
                            <h6 class="text-rose-gold mb-3">Booking Statistics</h6>
                            <dl class="row">
                                <dt class="col-sm-6">Total Bookings:</dt>
                                <dd class="col-sm-6">@clientBookingCount</dd>
                                
                                <dt class="col-sm-6">Completed:</dt>
                                <dd class="col-sm-6">@clientCompletedCount</dd>
                                
                                <dt class="col-sm-6">Upcoming:</dt>
                                <dd class="col-sm-6">@clientUpcomingCount</dd>
                                
                                <dt class="col-sm-6">Cancelled:</dt>
                                <dd class="col-sm-6">@clientCancelledCount</dd>
                            </dl>
                        </div>
                    </div>
                    
                    @if (clientRecentBookings.Any())
                    {
                        <div class="mt-4">
                            <h6 class="text-rose-gold mb-3">Recent Bookings</h6>
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Service</th>
                                            <th>Therapist</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var booking in clientRecentBookings.Take(5))
                                        {
                                            <tr>
                                                <td>@booking.StartTime.ToString("MMM dd, yyyy")</td>
                                                <td>@booking.Service?.Name</td>
                                                <td>@booking.Therapist?.FirstName @booking.Therapist?.LastName</td>
                                                <td>
                                                    <span class="badge @GetStatusBadgeClass(booking.Status)">
                                                        @booking.Status
                                                    </span>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    }
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseClientCard">Close</button>
                </div>
            </div>
        </div>
    </div>
}

<!-- Cancel Booking Confirmation Modal -->
@if (showCancelConfirmation && selectedBooking != null)
{
    <div class="modal-backdrop show"></div>
    <div class="modal show d-block" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-exclamation-triangle-fill"></i> Confirm Cancellation
                    </h5>
                    <button type="button" class="btn-close btn-close-white" @onclick="async () => await CloseCancelConfirmation()"></button>
                </div>
                <div class="modal-body">
                    <p class="mb-3">Are you sure you want to cancel this booking?</p>
                    
                    <div class="alert alert-info mb-3">
                        <strong>Booking Details:</strong><br/>
                        <i class="bi bi-person"></i> <strong>Client:</strong> @selectedBooking.Client.FirstName @selectedBooking.Client.LastName<br/>
                        <i class="bi bi-scissors"></i> <strong>Service:</strong> @selectedBooking.Service.Name<br/>
                        <i class="bi bi-clock"></i> <strong>Time:</strong> @selectedBooking.StartTime.ToString("MMM dd, yyyy 'at' h:mm tt")
                    </div>
                    
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="notifyClientCheck" @bind="notifyClientOnCancel">
                        <label class="form-check-label" for="notifyClientCheck">
                            <i class="bi bi-envelope"></i> Notify client via email about this cancellation
                        </label>
                    </div>
                    
                    <p class="text-danger mb-0">
                        <i class="bi bi-exclamation-circle"></i> <strong>Warning:</strong> This action cannot be undone.
                    </p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="async () => await CloseCancelConfirmation()">
                        <i class="bi bi-x"></i> Keep Booking
                    </button>
                    <button type="button" class="btn btn-danger" @onclick="ExecuteCancelBooking">
                        <i class="bi bi-trash"></i> Cancel Booking
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private bool isLoading = true;
    private bool isSaving = false;
    private bool showAssignmentModal = false;
    private string? assignmentError;
    private string? loadError;
    
    // View toggle state
    private bool showRooms = true;
    private bool showTherapists = true;
    
    // Booking edit state
    private bool hasUnsavedChanges = false;
    private string editedDate = "";
    private string editedStartTime = "";
    private string editedEndTime = "";
    private string editedTherapistId = "";
    private string editedRoomId = "";
    
    // Cancel confirmation state
    private bool showCancelConfirmation = false;
    private bool notifyClientOnCancel = false;
    
    // Client notes
    private ClientNote? mostRecentClientNote;
    
    // Room assignment state
    private List<Room> availableRoomsForBooking = new();
    private string? roomAssignmentError;
    private string? roomAssignmentSuccess;
    private bool isRoomSaving = false;
    private string tempRoomSelection = "";
    
    // Therapist booking modal state
    private bool showTherapistBookingModal = false;
    private string? therapistBookingError;
    private TherapistBookingModel therapistBookingModel = new();
    private List<SpaService> availableServicesForTherapist = new();
    private List<Room> availableRoomsForTherapistBooking = new();
    
    // Client card state
    private bool showClientCard = false;
    private ApplicationUser? selectedClient;
    private int clientBookingCount = 0;
    private int clientCompletedCount = 0;
    private int clientUpcomingCount = 0;
    private int clientCancelledCount = 0;
    private List<Booking> clientRecentBookings = new();
    
    // Client search state (Therapist Booking Modal)
    private string _clientSearchText = string.Empty;
    private string clientSearchText
    {
        get => _clientSearchText;
        set
        {
            _clientSearchText = value;
            FilterClients();
            if (!string.IsNullOrEmpty(value))
            {
                showClientDropdown = true;
            }
        }
    }
    private bool showClientDropdown = false;
    private string? selectedClientName;
    private List<ApplicationUser> filteredClients = new();
    
    // Assignment modal client search state
    private string _assignmentClientSearchText = string.Empty;
    private string assignmentClientSearchText
    {
        get => _assignmentClientSearchText;
        set
        {
            _assignmentClientSearchText = value;
            FilterAssignmentClients();
            if (!string.IsNullOrEmpty(value))
            {
                showAssignmentClientDropdown = true;
            }
        }
    }
    private bool showAssignmentClientDropdown = false;
    private string? selectedAssignmentClientName;
    private List<ApplicationUser> filteredAssignmentClients = new();

    private List<Location> locations = new();
    private List<Room> rooms = new();
    private List<ApplicationUser> therapists = new();
    private List<ApplicationUser> clients = new();
    private List<Booking> bookings = new();
    private List<TherapistAvailability> blockedTimes = new();
    private List<SpaService> availableServices = new();
    private List<ApplicationUser> availableTherapists = new();

    private int selectedLocationId;
    private DateTime currentDate = DateTime.UtcNow.Date;
    private Room? selectedRoom;
    private ApplicationUser? selectedTherapist;
    private TimeSpan selectedTimeSlot;
    private Booking? selectedBooking;

    // Track which bookings have already been rendered (for slot merging)
    // Separate tracking for room and therapist booking renders to allow same booking in both sections
    private HashSet<int> renderedRoomBookingIds = new();
    private HashSet<int> renderedTherapistBookingIds = new();

    private AssignmentModel assignmentModel = new();

    // Time slots: 8:00 AM to 8:00 PM in 15-minute intervals (48 slots)
    private readonly TimeSpan[] timeSlots = Enumerable.Range(0, 48)
        .Select(i => new TimeSpan(8, i * 15, 0))
        .ToArray();

    protected override async Task OnInitializedAsync()
    {
        try
        {
            await LoadLocations();
            if (locations.Any())
            {
                selectedLocationId = locations.First().Id;
                await LoadScheduleData();
            }
        }
        catch (Exception ex)
        {
            loadError = $"Failed to load scheduler: {ex.Message}";
            Console.WriteLine($"Error in OnInitializedAsync: {ex}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task LoadLocations()
    {
        using var context = await DbContextFactory.CreateDbContextAsync();
        locations = await context.Locations
            .Where(l => l.IsActive)
            .OrderBy(l => l.Name)
            .ToListAsync();
    }

    private async Task LoadScheduleData()
    {
        isLoading = true;
        renderedRoomBookingIds.Clear(); // Clear for fresh render
        renderedTherapistBookingIds.Clear();
        
        try
        {
            using var context = await DbContextFactory.CreateDbContextAsync();
            var startOfDay = currentDate.Date;
            var endOfDay = startOfDay.AddDays(1);

            // First, load all DbContext queries and await them
            rooms = await context.Rooms
                .Where(r => r.LocationId == selectedLocationId && r.IsActive)
                .OrderBy(r => r.DisplayOrder)
                .ToListAsync();

            var therapistIds = await context.Bookings
                .Where(b => b.LocationId == selectedLocationId)
                .Select(b => b.TherapistId)
                .Distinct()
                .ToListAsync();

            bookings = await context.Bookings
                .Include(b => b.Client)
                .Include(b => b.Service)
                .Include(b => b.Room)
                .Include(b => b.Therapist)
                .Where(b => b.LocationId == selectedLocationId 
                         && b.StartTime >= startOfDay 
                         && b.StartTime < endOfDay
                         && b.Status != BookingStatus.Cancelled)
                .OrderBy(b => b.StartTime)
                .ToListAsync();

            // Load ALL availability for the day (both specific dates and weekly recurring)
            var utcCurrentDate = DateTime.SpecifyKind(currentDate.Date, DateTimeKind.Utc);
            blockedTimes = await context.TherapistAvailability
                .Where(a => (a.SpecificDate == utcCurrentDate) || 
                           (a.SpecificDate == null && a.DayOfWeek == currentDate.DayOfWeek))
                .ToListAsync();

            // Now load UserManager operations (which use a separate DbContext internally)
            var therapistList = await UserManager.GetUsersInRoleAsync("Therapist");
            var adminList = await UserManager.GetUsersInRoleAsync("Admin");
            var allStaff = therapistList.Union(adminList).Distinct().ToList();

            clients = (await UserManager.GetUsersInRoleAsync("Client")).ToList();

            // Filter therapists to those who are scheduled to work on this day
            therapists = allStaff.Where(therapist => 
            {
                // Check if therapist has a specific date schedule for today
                var specificSchedule = blockedTimes.FirstOrDefault(a => 
                    a.TherapistId == therapist.Id && 
                    a.SpecificDate == utcCurrentDate && 
                    a.IsAvailable);
                
                if (specificSchedule != null) return true;
                
                // Check if specifically blocked for today
                var specificBlock = blockedTimes.FirstOrDefault(a => 
                    a.TherapistId == therapist.Id && 
                    a.SpecificDate == utcCurrentDate && 
                    !a.IsAvailable);
                
                if (specificBlock != null) return false;
                
                // Fall back to weekly recurring schedule
                var weeklySchedule = blockedTimes.FirstOrDefault(a => 
                    a.TherapistId == therapist.Id && 
                    a.SpecificDate == null && 
                    a.DayOfWeek == currentDate.DayOfWeek && 
                    a.IsAvailable);
                
                return weeklySchedule != null;
            })
                .OrderBy(u => u.FirstName)
                .ThenBy(u => u.LastName)
                .ToList();
            
            clients = clients.OrderBy(c => c.FirstName).ThenBy(c => c.LastName).ToList();
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task OnLocationChanged()
    {
        await LoadScheduleData();
    }

    private async Task NavigatePreviousDay()
    {
        currentDate = currentDate.AddDays(-1);
        await LoadScheduleData();
    }

    private async Task NavigateNextDay()
    {
        currentDate = currentDate.AddDays(1);
        await LoadScheduleData();
    }

    private async Task GoToToday()
    {
        currentDate = DateTime.UtcNow.Date;
        await LoadScheduleData();
    }
    
    // View Toggle Methods
    private void ToggleRoomsView(ChangeEventArgs e)
    {
        var newValue = (bool)(e.Value ?? false);
        
        // Prevent unchecking if it's the last one checked
        if (!newValue && !showTherapists)
        {
            return; // Keep at least one checked
        }
        
        showRooms = newValue;
        StateHasChanged();
    }
    
    private void ToggleTherapistsView(ChangeEventArgs e)
    {
        var newValue = (bool)(e.Value ?? false);
        
        // Prevent unchecking if it's the last one checked
        if (!newValue && !showRooms)
        {
            return; // Keep at least one checked
        }
        
        showTherapists = newValue;
        StateHasChanged();
    }

    // Booking Edit Methods
    private void InitializeEditFields()
    {
        if (selectedBooking == null) return;
        
        hasUnsavedChanges = false;
        editedDate = selectedBooking.StartTime.ToString("yyyy-MM-dd");
        editedStartTime = selectedBooking.StartTime.ToString("HH:mm");
        editedEndTime = selectedBooking.EndTime.ToString("HH:mm");
        editedTherapistId = selectedBooking.TherapistId;
        editedRoomId = selectedBooking.RoomId?.ToString() ?? "";
    }
    
    private async Task LoadMostRecentClientNote()
    {
        if (selectedBooking == null) return;
        
        using var context = await DbContextFactory.CreateDbContextAsync();
        mostRecentClientNote = await context.ClientNotes
            .Where(n => n.ClientId == selectedBooking.ClientId)
            .OrderByDescending(n => n.CreatedAt)
            .FirstOrDefaultAsync();
    }
    
    private void NavigateToClientNotes()
    {
        if (selectedBooking == null) return;
        
        // Navigate to client management page with the client ID as a query parameter
        NavigationManager.NavigateTo($"/admin/clients?clientId={selectedBooking.ClientId}");
    }

    private async Task SaveBookingChanges()
    {
        if (selectedBooking == null) return;

        try
        {
            isSaving = true;
            loadError = null;

            using var context = await DbContextFactory.CreateDbContextAsync();
            var booking = await context.Bookings
                .Include(b => b.Service)
                .Include(b => b.Room)
                .FirstOrDefaultAsync(b => b.Id == selectedBooking.Id);

            if (booking == null)
            {
                loadError = "Booking not found.";
                return;
            }

            // Parse the new date and times
            if (!DateTime.TryParse(editedDate, out var newDate))
            {
                loadError = "Invalid date format.";
                return;
            }

            if (!TimeSpan.TryParse(editedStartTime, out var newStartTime))
            {
                loadError = "Invalid start time format.";
                return;
            }

            if (!TimeSpan.TryParse(editedEndTime, out var newEndTime))
            {
                loadError = "Invalid end time format.";
                return;
            }

            // Validate times
            if (newEndTime <= newStartTime)
            {
                loadError = "End time must be after start time.";
                return;
            }

            // Create new DateTime values with UTC
            var newStartDateTime = DateTime.SpecifyKind(newDate.Date.Add(newStartTime), DateTimeKind.Utc);
            var newEndDateTime = DateTime.SpecifyKind(newDate.Date.Add(newEndTime), DateTimeKind.Utc);

            // Validate therapist availability (exclude current booking)
            var therapistConflict = bookings.Any(b => 
                b.Id != booking.Id && 
                b.TherapistId == editedTherapistId &&
                ((newStartDateTime >= b.StartTime && newStartDateTime < b.EndTime) ||
                 (newEndDateTime > b.StartTime && newEndDateTime <= b.EndTime) ||
                 (newStartDateTime <= b.StartTime && newEndDateTime >= b.EndTime)));

            if (therapistConflict)
            {
                loadError = "The selected therapist is already booked during this time.";
                return;
            }

            // Validate room availability (exclude current booking, include buffer time)
            if (!string.IsNullOrEmpty(editedRoomId))
            {
                var selectedRoomId = int.Parse(editedRoomId);
                var bufferMinutes = BufferTimeOptions.Value.BufferMinutes;
                
                var roomConflict = bookings.Any(b => 
                    b.Id != booking.Id && 
                    b.RoomId == selectedRoomId &&
                    ((newStartDateTime >= b.StartTime && newStartDateTime < b.EndTime.AddMinutes(bufferMinutes)) ||
                     (newEndDateTime > b.StartTime && newEndDateTime <= b.EndTime.AddMinutes(bufferMinutes)) ||
                     (newStartDateTime <= b.StartTime && newEndDateTime >= b.EndTime.AddMinutes(bufferMinutes))));

                if (roomConflict)
                {
                    loadError = $"The selected room is not available during this time (including {bufferMinutes}-minute buffer).";
                    return;
                }

                // Validate room service compatibility
                var selectedRoom = rooms.FirstOrDefault(r => r.Id == selectedRoomId);
                var roomSupportsService = await context.RoomServiceCapabilities
                    .AnyAsync(rsc => rsc.RoomId == selectedRoomId && rsc.ServiceId == booking.ServiceId);
                
                if (!roomSupportsService)
                {
                    var roomName = selectedRoom?.Name ?? "Selected room";
                    var serviceName = booking?.Service?.Name ?? "this service";
                    loadError = $"Cannot assign booking to {roomName}. This room is not equipped to provide {serviceName}.";
                    return;
                }
            }

            // Update booking
            booking.StartTime = newStartDateTime;
            booking.EndTime = newEndDateTime;
            booking.TherapistId = editedTherapistId;
            booking.RoomId = string.IsNullOrEmpty(editedRoomId) ? null : int.Parse(editedRoomId);

            context.Entry(booking).State = EntityState.Modified;
            await context.SaveChangesAsync();

            hasUnsavedChanges = false;
            await LoadScheduleData();
            
            // Reload the selected booking to show updated values
            selectedBooking = await context.Bookings
                .Include(b => b.Client)
                .Include(b => b.Service)
                .Include(b => b.Therapist)
                .Include(b => b.Room)
                .FirstOrDefaultAsync(b => b.Id == selectedBooking.Id);

            InitializeEditFields();
        }
        catch (Exception ex)
        {
            // Provide more user-friendly error messages
            if (ex is NullReferenceException)
            {
                loadError = "Unable to save changes. Please ensure all required information is properly loaded and try again.";
            }
            else if (ex is FormatException)
            {
                loadError = "Invalid data format. Please check your date and time entries.";
            }
            else if (ex.Message.Contains("foreign key") || ex.Message.Contains("constraint"))
            {
                loadError = "Unable to save changes. The selected room or therapist may no longer be available.";
            }
            else
            {
                loadError = $"Unable to save changes: {ex.Message}";
            }
        }
        finally
        {
            isSaving = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task AttemptCloseBookingModal()
    {
        if (hasUnsavedChanges)
        {
            var shouldClose = await JSRuntime.InvokeAsync<bool>("schedulerHelpers.confirmUnsavedChanges");
            if (shouldClose)
            {
                await CloseBookingModal();
            }
        }
        else
        {
            await CloseBookingModal();
        }
    }

    private Booking? GetBookingForRoomSlot(int roomId, TimeSpan slotStart, TimeSpan slotEnd)
    {
        return bookings.FirstOrDefault(b => 
            b.RoomId == roomId &&
            b.StartTime.TimeOfDay < slotEnd &&
            b.EndTime.TimeOfDay > slotStart);
    }

    private Booking? GetBookingForTherapistSlot(string therapistId, TimeSpan slotStart, TimeSpan slotEnd)
    {
        return bookings.FirstOrDefault(b => 
            b.TherapistId == therapistId &&
            b.StartTime.TimeOfDay < slotEnd &&
            b.EndTime.TimeOfDay > slotStart);
    }

    /// <summary>
    /// Calculate how many 15-minute slots a booking spans starting from the current slot
    /// </summary>
    private int CalculateBookingSpan(Booking booking, TimeSpan currentSlot)
    {
        var bookingStart = booking.StartTime.TimeOfDay;
        var bookingEnd = booking.EndTime.TimeOfDay;
        
        // If this slot doesn't contain the start of the booking, return 0 (already rendered)
        if (bookingStart < currentSlot || bookingStart >= currentSlot.Add(TimeSpan.FromMinutes(15)))
        {
            return 0;
        }
        
        // Calculate total duration in minutes
        var durationMinutes = (bookingEnd - bookingStart).TotalMinutes;
        
        // Convert to number of 15-minute slots (round up)
        var slots = (int)Math.Ceiling(durationMinutes / 15.0);
        
        return slots;
    }

    /// <summary>
    /// Check if a booking should be rendered in the current slot or if it's already been rendered
    /// </summary>
    /// <summary>
    /// Check if a booking should be rendered in a ROOM slot (prevents duplicate renders within room columns only)
    /// </summary>
    private bool ShouldRenderRoomBooking(Booking? booking)
    {
        if (booking == null) return false;
        if (renderedRoomBookingIds.Contains(booking.Id)) return false;
        return true;
    }
    
    /// <summary>
    /// Check if a booking should be rendered in a THERAPIST slot (prevents duplicate renders within therapist columns only)
    /// </summary>
    private bool ShouldRenderTherapistBooking(Booking? booking)
    {
        if (booking == null) return false;
        if (renderedTherapistBookingIds.Contains(booking.Id)) return false;
        return true;
    }

    /// <summary>
    /// Clear rendered booking IDs before each grid render to prevent bookings from disappearing after modal closes
    /// </summary>
    private string ClearRenderedBookings()
    {
        renderedRoomBookingIds.Clear();
        renderedTherapistBookingIds.Clear();
        return string.Empty; // Return empty string so it doesn't render anything in the markup
    }

    /// <summary>
    /// Check if a time slot is within the buffer period after a booking
    /// </summary>
    private bool IsBufferSlot(int roomId, TimeSpan slotStart, TimeSpan slotEnd)
    {
        var bufferMinutes = BufferTimeOptions.Value.BufferMinutes;
        if (bufferMinutes == 0) return false;

        // Check if this slot falls within buffer time after any booking in this room
        return bookings.Any(b => b.RoomId == roomId &&
            b.EndTime.TimeOfDay <= slotStart &&
            b.EndTime.TimeOfDay.Add(TimeSpan.FromMinutes(bufferMinutes)) > slotStart);
    }

    /// <summary>
    /// Check if a time slot is within the buffer period after a therapist's booking
    /// </summary>
    private bool IsTherapistBufferSlot(string therapistId, TimeSpan slotStart, TimeSpan slotEnd)
    {
        var bufferMinutes = BufferTimeOptions.Value.BufferMinutes;
        if (bufferMinutes == 0) return false;

        // Check if this slot falls within buffer time after any of therapist's bookings
        return bookings.Any(b => b.TherapistId == therapistId &&
            b.EndTime.TimeOfDay <= slotStart &&
            b.EndTime.TimeOfDay.Add(TimeSpan.FromMinutes(bufferMinutes)) > slotStart);
    }

    private TherapistAvailability? GetBlockedTimeForTherapist(string therapistId, TimeSpan slotStart)
    {
        return blockedTimes.FirstOrDefault(bt => 
            bt.TherapistId == therapistId &&
            bt.StartTime <= slotStart &&
            bt.EndTime > slotStart);
    }

    private bool IsTherapistScheduledForSlot(string therapistId, TimeSpan slotTime)
    {
        // Check specific date first (overrides weekly schedule)
        var specificAvailability = blockedTimes.FirstOrDefault(a => 
            a.TherapistId == therapistId && a.SpecificDate == currentDate.Date);
        
        if (specificAvailability != null)
        {
            return specificAvailability.IsAvailable && 
                   slotTime >= specificAvailability.StartTime && 
                   slotTime < specificAvailability.EndTime;
        }
        
        // Fall back to weekly schedule
        var weeklyAvailability = blockedTimes.FirstOrDefault(a => 
            a.TherapistId == therapistId && 
            a.SpecificDate == null && 
            a.DayOfWeek == currentDate.DayOfWeek);
        
        if (weeklyAvailability != null)
        {
            return weeklyAvailability.IsAvailable && 
                   slotTime >= weeklyAvailability.StartTime && 
                   slotTime < weeklyAvailability.EndTime;
        }
        
        // No schedule = not working (NEW DEFAULT BEHAVIOR)
        return false;
    }

    private async Task HandleRoomSlotClick(Room room, TimeSpan timeSlot, Booking? booking)
    {
        if (booking != null)
        {
            selectedBooking = booking;
            InitializeEditFields();
            await LoadAvailableRoomsForBooking();
            await LoadMostRecentClientNote();
        }
        else
        {
            await ShowAssignmentModal(room, timeSlot);
        }
    }

    private async Task HandleTherapistSlotClick(ApplicationUser therapist, TimeSpan timeSlot, Booking? booking)
    {
        if (booking != null)
        {
            selectedBooking = booking;
            InitializeEditFields();
            await LoadAvailableRoomsForBooking();
            await LoadMostRecentClientNote();
        }
        else
        {
            // Open therapist booking modal for available slots
            await ShowTherapistBookingModal(therapist, timeSlot);
        }
    }

    private async Task ShowAssignmentModal(Room room, TimeSpan timeSlot)
    {
        selectedRoom = room;
        selectedTimeSlot = timeSlot;
        assignmentModel = new AssignmentModel();
        assignmentError = null;

        // Reset client search state
        ClearAssignmentClientSelection();

        // Calculate available time until next booking
        var slotStart = currentDate.Date.Add(timeSlot);
        var availableMinutes = GetAvailableMinutesForRoom(room.Id, slotStart);
        
        // Load available therapists (not blocked, not booked during this slot)
        var slotEnd = slotStart.AddMinutes(15);
        
        availableTherapists = therapists.Where(t => 
            IsTherapistAvailable(t.Id, slotStart, slotEnd))
            .ToList();

        // Load services for this room that fit in the available time
        using var context = await DbContextFactory.CreateDbContextAsync();
        var roomServiceIds = await context.RoomServiceCapabilities
            .Where(rsc => rsc.RoomId == room.Id)
            .Select(rsc => rsc.ServiceId)
            .ToListAsync();

        availableServices = await context.SpaServices
            .Where(s => s.LocationId == selectedLocationId 
                     && s.IsActive 
                     && roomServiceIds.Contains(s.Id)
                     && s.DurationMinutes <= availableMinutes) // Only services that fit!
            .OrderBy(s => s.DurationMinutes) // Sort by duration (shortest first)
            .ThenBy(s => s.Name)
            .ToListAsync();

        showAssignmentModal = true;
        StateHasChanged();
    }
    
    /// <summary>
    /// Calculate how many minutes are available in a room starting from the given time
    /// before the next booking occurs.
    /// </summary>
    private int GetAvailableMinutesForRoom(int roomId, DateTime startTime)
    {
        // Find the next booking in this room after the start time
        var nextBooking = bookings
            .Where(b => b.RoomId == roomId && b.StartTime > startTime)
            .OrderBy(b => b.StartTime)
            .FirstOrDefault();
        
        if (nextBooking == null)
        {
            // No next booking - available until end of day (assume 8 PM / 20:00)
            var endOfDay = startTime.Date.AddHours(20);
            return (int)(endOfDay - startTime).TotalMinutes;
        }
        
        // Calculate minutes until next booking
        return (int)(nextBooking.StartTime - startTime).TotalMinutes;
    }

    private Task OnTherapistSelected()
    {
        // Can add additional logic here if needed
        StateHasChanged();
        return Task.CompletedTask;
    }

    private void CloseAssignmentModal()
    {
        showAssignmentModal = false;
        assignmentModel = new();
        assignmentError = null;
        selectedRoom = null;
        ClearAssignmentClientSelection();
    }

    private async Task SaveAssignment()
    {
        assignmentError = null;

        // Validation
        if (string.IsNullOrEmpty(assignmentModel.TherapistId))
        {
            assignmentError = "Please select a therapist";
            return;
        }
        if (assignmentModel.ServiceId == 0)
        {
            assignmentError = "Please select a service";
            return;
        }
        if (string.IsNullOrEmpty(assignmentModel.ClientId))
        {
            assignmentError = "Please select a client";
            return;
        }

        isSaving = true;

        try
        {
            using var context = await DbContextFactory.CreateDbContextAsync();
            var service = await context.SpaServices.FindAsync(assignmentModel.ServiceId);
            if (service == null)
            {
                assignmentError = "Service not found";
                return;
            }

            var startTime = currentDate.Date.Add(selectedTimeSlot);
            var endTime = startTime.AddMinutes(service.DurationMinutes);

            // Final availability check
            if (!IsTherapistAvailable(assignmentModel.TherapistId, startTime, endTime))
            {
                assignmentError = "Therapist is no longer available for this time slot";
                return;
            }

            if (!IsRoomAvailable(selectedRoom!.Id, startTime, endTime))
            {
                assignmentError = "Room is no longer available for this time slot";
                return;
            }

            var booking = new Booking
            {
                ClientId = assignmentModel.ClientId,
                TherapistId = assignmentModel.TherapistId,
                ServiceId = assignmentModel.ServiceId,
                LocationId = selectedLocationId,
                RoomId = selectedRoom.Id,
                StartTime = startTime,
                EndTime = endTime,
                Status = BookingStatus.Confirmed,
                ServicePrice = service.BasePrice,
                TotalPrice = service.BasePrice,
                Notes = assignmentModel.Notes,
                CreatedAt = DateTime.UtcNow
            };

            context.Bookings.Add(booking);
            await context.SaveChangesAsync();
            await LoadScheduleData();
            CloseAssignmentModal();
        }
        catch (Exception ex)
        {
            assignmentError = $"Error creating booking: {ex.Message}";
        }
        finally
        {
            isSaving = false;
        }
    }

    private async Task CloseBookingModal()
    {
        selectedBooking = null;
        availableRoomsForBooking.Clear();
        roomAssignmentError = null;
        roomAssignmentSuccess = null;
        isRoomSaving = false;
        hasUnsavedChanges = false;
        await InvokeAsync(StateHasChanged);
    }
    
    private async Task ShowClientCard(string clientId)
    {
        try
        {
            selectedClient = await UserManager.FindByIdAsync(clientId);
            if (selectedClient == null) return;
            
            using var context = await DbContextFactory.CreateDbContextAsync();
            
            // Get all bookings for this client
            var allClientBookings = await context.Bookings
                .Include(b => b.Service)
                .Include(b => b.Therapist)
                .Where(b => b.ClientId == clientId)
                .OrderByDescending(b => b.StartTime)
                .ToListAsync();
            
            clientBookingCount = allClientBookings.Count;
            clientCompletedCount = allClientBookings.Count(b => b.Status == BookingStatus.Completed);
            clientUpcomingCount = allClientBookings.Count(b => b.Status == BookingStatus.Confirmed && b.StartTime > DateTime.UtcNow);
            clientCancelledCount = allClientBookings.Count(b => b.Status == BookingStatus.Cancelled);
            clientRecentBookings = allClientBookings.Take(10).ToList();
            
            showClientCard = true;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading client card: {ex.Message}");
        }
    }
    
    private void CloseClientCard()
    {
        showClientCard = false;
        selectedClient = null;
        clientBookingCount = 0;
        clientCompletedCount = 0;
        clientUpcomingCount = 0;
        clientCancelledCount = 0;
        clientRecentBookings.Clear();
    }

    private async Task LoadAvailableRoomsForBooking()
    {
        availableRoomsForBooking.Clear();
        roomAssignmentError = null;
        
        if (selectedBooking == null) return;
        
        using var context = await DbContextFactory.CreateDbContextAsync();
        
        // Get all rooms that support this service
        var compatibleRoomIds = await context.RoomServiceCapabilities
            .Where(rsc => rsc.ServiceId == selectedBooking.ServiceId)
            .Select(rsc => rsc.RoomId)
            .ToListAsync();
        
        var compatibleRooms = rooms.Where(r => compatibleRoomIds.Contains(r.Id)).ToList();
        
        // Filter to only rooms that are available during the booking time (including buffer)
        foreach (var room in compatibleRooms)
        {
            if (IsRoomAvailableForBooking(room.Id, selectedBooking))
            {
                availableRoomsForBooking.Add(room);
            }
        }
    }

    private bool IsRoomAvailableForBooking(int roomId, Booking currentBooking)
    {
        var bufferMinutes = BufferTimeOptions.Value.BufferMinutes;
        
        // Check if any OTHER booking conflicts with this time slot (excluding current booking)
        var hasConflict = bookings.Any(b => 
            b.Id != currentBooking.Id && // Exclude the current booking
            b.RoomId == roomId &&
            ((currentBooking.StartTime >= b.StartTime && currentBooking.StartTime < b.EndTime.AddMinutes(bufferMinutes)) ||
             (currentBooking.EndTime > b.StartTime && currentBooking.EndTime <= b.EndTime.AddMinutes(bufferMinutes)) ||
             (currentBooking.StartTime <= b.StartTime && currentBooking.EndTime >= b.EndTime.AddMinutes(bufferMinutes))));
        
        return !hasConflict;
    }

    private async Task ConfirmBooking()
    {
        if (selectedBooking == null) return;

        using var context = await DbContextFactory.CreateDbContextAsync();
        context.Bookings.Attach(selectedBooking);
        selectedBooking.Status = BookingStatus.Confirmed;
        selectedBooking.UpdatedAt = DateTime.UtcNow;
        await context.SaveChangesAsync();
        await LoadScheduleData();
        await CloseBookingModal();
    }

    private void ConfirmCancelBooking()
    {
        if (selectedBooking == null) return;
        
        notifyClientOnCancel = false; // Default to not notifying
        showCancelConfirmation = true;
    }
    
    private async Task CloseCancelConfirmation()
    {
        showCancelConfirmation = false;
        notifyClientOnCancel = false;
        await InvokeAsync(StateHasChanged);
    }
    
    private async Task ExecuteCancelBooking()
    {
        showCancelConfirmation = false;
        await CancelBooking();
    }

    private async Task CancelBooking()
    {
        if (selectedBooking == null) return;

        using var context = await DbContextFactory.CreateDbContextAsync();
        context.Bookings.Attach(selectedBooking);
        selectedBooking.Status = BookingStatus.Cancelled;
        selectedBooking.CancelledAt = DateTime.UtcNow;
        selectedBooking.UpdatedAt = DateTime.UtcNow;
        await context.SaveChangesAsync();
        
        // TODO: If notifyClientOnCancel is true, send cancellation email to client
        // Email notification logic would go here
        
        await LoadScheduleData();
        await CloseBookingModal();
    }

    private async Task HandleRoomSelection()
    {
        if (selectedBooking == null)
        {
            roomAssignmentError = "No booking selected";
            return;
        }
        
        try
        {
            // Clear previous messages and show loading
            roomAssignmentError = null;
            roomAssignmentSuccess = null;
            isRoomSaving = true;
            await InvokeAsync(StateHasChanged);
            
            // Parse the selected room ID (empty string means unassigned)
            int? newRoomId = string.IsNullOrEmpty(tempRoomSelection) ? null : int.Parse(tempRoomSelection);
            
            Console.WriteLine($"[DEBUG] Starting room assignment: BookingId={selectedBooking.Id}, NewRoomId={newRoomId}");
            
            using var context = await DbContextFactory.CreateDbContextAsync();
            var booking = await context.Bookings
                .Include(b => b.Room)
                .FirstOrDefaultAsync(b => b.Id == selectedBooking.Id);
            
            if (booking == null)
            {
                roomAssignmentError = "Booking not found in database (ID: " + selectedBooking.Id + ")";
                Console.WriteLine($"[ERROR] Booking {selectedBooking.Id} not found");
                isRoomSaving = false;
                await InvokeAsync(StateHasChanged);
                return;
            }
            
            Console.WriteLine($"[DEBUG] Found booking. Current RoomId: {booking.RoomId}, Setting to: {newRoomId}");
            
            var oldRoomId = booking.RoomId;
            booking.RoomId = newRoomId;
            booking.UpdatedAt = DateTime.UtcNow;
            
            // Explicitly mark the entity as modified to ensure EF Core tracks the change
            context.Entry(booking).State = Microsoft.EntityFrameworkCore.EntityState.Modified;
            
            var saveResult = await context.SaveChangesAsync();
            Console.WriteLine($"[DEBUG] SaveChangesAsync returned: {saveResult} rows affected");
            
            if (saveResult == 0)
            {
                roomAssignmentError = "No changes were saved to the database. SaveChangesAsync returned 0.";
                isRoomSaving = false;
                await InvokeAsync(StateHasChanged);
                return;
            }
            
            // Success! Show success message
            var roomName = newRoomId.HasValue ? $"Room {newRoomId}" : "Unassigned";
            roomAssignmentSuccess = $"Room successfully updated to: {roomName}";
            Console.WriteLine($"[SUCCESS] Room updated from {oldRoomId} to {newRoomId}");
            
            // Reload the schedule to show the updated room assignment
            await LoadScheduleData();
            
            // Update the selected booking reference with the new room
            selectedBooking = await context.Bookings
                .Include(b => b.Service)
                .Include(b => b.Client)
                .Include(b => b.Therapist)
                .Include(b => b.Room)
                .FirstOrDefaultAsync(b => b.Id == selectedBooking.Id);
            
            Console.WriteLine($"[DEBUG] selectedBooking refreshed. New RoomId: {selectedBooking?.RoomId}, Room Name: {selectedBooking?.Room?.Name}");
            
            // Reload available rooms in case availability changed
            await LoadAvailableRoomsForBooking();
            
            isRoomSaving = false;
            await InvokeAsync(StateHasChanged);
            
            // Clear success message after 3 seconds
            _ = Task.Run(async () =>
            {
                await Task.Delay(3000);
                roomAssignmentSuccess = null;
                await InvokeAsync(StateHasChanged);
            });
        }
        catch (Exception ex)
        {
            roomAssignmentError = $"Exception: {ex.Message}\n\nStack Trace: {ex.StackTrace}";
            Console.WriteLine($"[ERROR] Exception in HandleRoomSelection: {ex}");
            isRoomSaving = false;
            await InvokeAsync(StateHasChanged);
        }
    }
    
    // Therapist Booking Modal Methods
    
    private async Task ShowTherapistBookingModal(ApplicationUser therapist, TimeSpan timeSlot)
    {
        selectedTherapist = therapist;
        selectedTimeSlot = timeSlot;
        therapistBookingModel = new TherapistBookingModel
        {
            StartTime = timeSlot.ToString("hh\\:mm"),
            EndTime = timeSlot.Add(TimeSpan.FromMinutes(15)).ToString("hh\\:mm")
        };
        therapistBookingError = null;

        // Reset client search state
        ClearClientSelection();

        // Load all services for this location
        using var context = await DbContextFactory.CreateDbContextAsync();
        availableServicesForTherapist = await context.SpaServices
            .Where(s => s.LocationId == selectedLocationId && s.IsActive)
            .OrderBy(s => s.Name)
            .ToListAsync();

        showTherapistBookingModal = true;
        StateHasChanged();
    }

    private async Task OnTherapistServiceSelected()
    {
        // Auto-calculate end time based on service duration
        if (therapistBookingModel.ServiceId > 0)
        {
            var service = availableServicesForTherapist.FirstOrDefault(s => s.Id == therapistBookingModel.ServiceId);
            if (service != null && TimeSpan.TryParse(therapistBookingModel.StartTime, out var startTime))
            {
                var endTime = startTime.Add(TimeSpan.FromMinutes(service.DurationMinutes));
                therapistBookingModel.EndTime = endTime.ToString("hh\\:mm");
            }
            
            // Load available rooms for the selected service and time
            await LoadAvailableRoomsForTherapistBooking();
        }
        else
        {
            availableRoomsForTherapistBooking.Clear();
            therapistBookingModel.RoomId = null;
        }
        StateHasChanged();
    }

    private async Task LoadAvailableRoomsForTherapistBooking()
    {
        availableRoomsForTherapistBooking.Clear();
        
        if (therapistBookingModel.ServiceId == 0)
        {
            StateHasChanged();
            return;
        }
        
        using var context = await DbContextFactory.CreateDbContextAsync();
        
        var service = await context.SpaServices.FindAsync(therapistBookingModel.ServiceId);
        if (service == null) return;
        
        if (!TimeSpan.TryParse(therapistBookingModel.StartTime, out var startTime) ||
            !TimeSpan.TryParse(therapistBookingModel.EndTime, out var endTime))
        {
            return;
        }
        
        var bookingDate = currentDate.Date;
        var bookingStartTime = new DateTime(bookingDate.Year, bookingDate.Month, bookingDate.Day, 
            startTime.Hours, startTime.Minutes, 0, DateTimeKind.Utc);
        var bookingEndTime = new DateTime(bookingDate.Year, bookingDate.Month, bookingDate.Day, 
            endTime.Hours, endTime.Minutes, 0, DateTimeKind.Utc);
        
        var bufferMinutes = BufferTimeOptions.Value.BufferMinutes;
        var bookingEndWithBuffer = bookingEndTime.AddMinutes(bufferMinutes);
        
        // Get rooms that can handle this service
        var roomIdsForService = await context.RoomServiceCapabilities
            .Where(rsc => rsc.ServiceId == therapistBookingModel.ServiceId)
            .Select(rsc => rsc.RoomId)
            .ToListAsync();
        
        var roomsForService = await context.Rooms
            .Where(r => r.LocationId == selectedLocationId && roomIdsForService.Contains(r.Id) && r.IsActive)
            .ToListAsync();
        
        foreach (var room in roomsForService)
        {
            // Check if room is available (no conflicting bookings)
            var hasConflict = await context.Bookings
                .AnyAsync(b => b.RoomId == room.Id &&
                              b.Status != BookingStatus.Cancelled &&
                              b.Status != BookingStatus.NoShow &&
                              b.StartTime < bookingEndWithBuffer &&
                              b.EndTime > bookingStartTime);
            
            if (!hasConflict)
            {
                availableRoomsForTherapistBooking.Add(room);
            }
        }
        
        StateHasChanged();
    }

    private void CloseTherapistBookingModal()
    {
        showTherapistBookingModal = false;
        therapistBookingModel = new();
        therapistBookingError = null;
        selectedTherapist = null;
        availableServicesForTherapist.Clear();
        availableRoomsForTherapistBooking.Clear();
        ClearClientSelection();
    }
    
    private void FilterClients()
    {
        if (string.IsNullOrWhiteSpace(clientSearchText))
        {
            filteredClients = clients;
        }
        else
        {
            var searchLower = clientSearchText.ToLower();
            filteredClients = clients
                .Where(c => 
                    c.FirstName.ToLower().Contains(searchLower) ||
                    c.LastName.ToLower().Contains(searchLower) ||
                    (c.Email?.ToLower().Contains(searchLower) ?? false))
                .ToList();
        }
    }
    
    private void SelectClient(ApplicationUser client)
    {
        therapistBookingModel.ClientId = client.Id;
        selectedClientName = $"{client.FirstName} {client.LastName}";
        clientSearchText = string.Empty;
        showClientDropdown = false;
        StateHasChanged();
    }
    
    private void ClearClientSelection()
    {
        therapistBookingModel.ClientId = string.Empty;
        selectedClientName = null;
        clientSearchText = string.Empty;
        showClientDropdown = false;
        // Don't clear filteredClients - it will be repopulated when user types
    }
    
    // Assignment Modal Client Search Methods
    private void FilterAssignmentClients()
    {
        if (string.IsNullOrWhiteSpace(assignmentClientSearchText))
        {
            filteredAssignmentClients = clients;
        }
        else
        {
            var searchLower = assignmentClientSearchText.ToLower();
            filteredAssignmentClients = clients
                .Where(c => 
                    c.FirstName.ToLower().Contains(searchLower) ||
                    c.LastName.ToLower().Contains(searchLower) ||
                    (c.Email?.ToLower().Contains(searchLower) ?? false))
                .ToList();
        }
    }
    
    private void SelectAssignmentClient(ApplicationUser client)
    {
        assignmentModel.ClientId = client.Id;
        selectedAssignmentClientName = $"{client.FirstName} {client.LastName}";
        assignmentClientSearchText = string.Empty;
        showAssignmentClientDropdown = false;
        StateHasChanged();
    }
    
    private void ClearAssignmentClientSelection()
    {
        assignmentModel.ClientId = string.Empty;
        selectedAssignmentClientName = null;
        assignmentClientSearchText = string.Empty;
        showAssignmentClientDropdown = false;
        // Don't clear filteredAssignmentClients - it will be repopulated when user types
    }

    private async Task SaveTherapistBooking()
    {
        therapistBookingError = null;

        // Validation
        if (selectedTherapist == null)
        {
            therapistBookingError = "Therapist information is missing";
            return;
        }
        if (therapistBookingModel.ServiceId == 0)
        {
            therapistBookingError = "Please select a service";
            return;
        }
        if (string.IsNullOrEmpty(therapistBookingModel.ClientId))
        {
            therapistBookingError = "Please select a client";
            return;
        }
        if (!TimeSpan.TryParse(therapistBookingModel.StartTime, out var startTime))
        {
            therapistBookingError = "Invalid start time";
            return;
        }
        if (!TimeSpan.TryParse(therapistBookingModel.EndTime, out var endTime))
        {
            therapistBookingError = "Invalid end time";
            return;
        }
        if (endTime <= startTime)
        {
            therapistBookingError = "End time must be after start time";
            return;
        }

        isSaving = true;

        try
        {
            using var context = await DbContextFactory.CreateDbContextAsync();
            var service = await context.SpaServices.FindAsync(therapistBookingModel.ServiceId);
            if (service == null)
            {
                therapistBookingError = "Service not found";
                return;
            }

            var bookingStartTime = currentDate.Date.Add(startTime);
            var bookingEndTime = currentDate.Date.Add(endTime);

            // Verify therapist is still available
            if (!IsTherapistAvailable(selectedTherapist.Id, bookingStartTime, bookingEndTime))
            {
                therapistBookingError = "Therapist is not available for the selected time";
                return;
            }

            // Use the selected room if provided, otherwise try to auto-assign
            Room? availableRoom = null;
            if (therapistBookingModel.RoomId.HasValue)
            {
                availableRoom = await context.Rooms.FindAsync(therapistBookingModel.RoomId.Value);
                if (availableRoom == null)
                {
                    therapistBookingError = "Selected room not found";
                    return;
                }
            }
            else
            {
                // Auto-assign: Find an available room that can handle this service
                var bufferMinutes = BufferTimeOptions.Value.BufferMinutes;
                var bookingEndWithBuffer = bookingEndTime.AddMinutes(bufferMinutes);
                
                // Get rooms that can handle this service
                var roomIdsForService = await context.RoomServiceCapabilities
                    .Where(rsc => rsc.ServiceId == therapistBookingModel.ServiceId)
                    .Select(rsc => rsc.RoomId)
                    .ToListAsync();
                
                var roomsForService = await context.Rooms
                    .Where(r => r.LocationId == selectedLocationId && roomIdsForService.Contains(r.Id) && r.IsActive)
                    .ToListAsync();
                
                foreach (var room in roomsForService)
                {
                    // Check if room is available (no conflicting bookings)
                    var hasConflict = await context.Bookings
                        .AnyAsync(b => b.RoomId == room.Id &&
                                      b.Status != BookingStatus.Cancelled &&
                                      b.Status != BookingStatus.NoShow &&
                                      b.StartTime < bookingEndWithBuffer &&
                                      b.EndTime > bookingStartTime);
                    
                    if (!hasConflict)
                    {
                        availableRoom = room;
                        break;
                    }
                }
                
                if (availableRoom == null)
                {
                    therapistBookingError = "No room is available for this service at the selected time. Please choose a different time or service.";
                    return;
                }
            }

            // Create the booking
            var booking = new Booking
            {
                ClientId = therapistBookingModel.ClientId,
                TherapistId = selectedTherapist.Id,
                ServiceId = therapistBookingModel.ServiceId,
                LocationId = selectedLocationId,
                RoomId = availableRoom.Id,
                StartTime = bookingStartTime,
                EndTime = bookingEndTime,
                Status = BookingStatus.Confirmed,
                ServicePrice = service.BasePrice,
                TotalPrice = service.BasePrice,
                Notes = therapistBookingModel.Notes,
                CreatedAt = DateTime.UtcNow
            };

            context.Bookings.Add(booking);
            await context.SaveChangesAsync();
            await LoadScheduleData();
            CloseTherapistBookingModal();
        }
        catch (Exception ex)
        {
            therapistBookingError = $"Error creating booking: {ex.Message}";
        }
        finally
        {
            isSaving = false;
        }
    }

    private bool IsTherapistAvailable(string therapistId, DateTime startTime, DateTime endTime)
    {
        // Check for existing bookings (NO buffer time for therapists - they can move to another room)
        var hasBooking = bookings.Any(b => b.TherapistId == therapistId
            && ((startTime >= b.StartTime && startTime < b.EndTime) ||
                (endTime > b.StartTime && endTime <= b.EndTime) ||
                (startTime <= b.StartTime && endTime >= b.EndTime)));

        if (hasBooking) return false;

        // NEW: Check if therapist is scheduled for this time (default = unavailable)
        // Check specific date availability first
        var specificAvailability = blockedTimes.FirstOrDefault(a => 
            a.TherapistId == therapistId && a.SpecificDate == startTime.Date);
        
        if (specificAvailability != null)
        {
            return specificAvailability.IsAvailable && 
                   startTime.TimeOfDay >= specificAvailability.StartTime && 
                   endTime.TimeOfDay <= specificAvailability.EndTime;
        }
        
        // Fall back to weekly schedule
        var weeklyAvailability = blockedTimes.FirstOrDefault(a => 
            a.TherapistId == therapistId && 
            a.SpecificDate == null && 
            a.DayOfWeek == startTime.DayOfWeek);
        
        if (weeklyAvailability != null)
        {
            return weeklyAvailability.IsAvailable && 
                   startTime.TimeOfDay >= weeklyAvailability.StartTime && 
                   endTime.TimeOfDay <= weeklyAvailability.EndTime;
        }
        
        // No schedule = not available (NEW DEFAULT BEHAVIOR)
        return false;
    }

    private bool IsRoomAvailable(int roomId, DateTime startTime, DateTime endTime)
    {
        var bufferMinutes = BufferTimeOptions.Value.BufferMinutes;
        
        // Check for conflicts including buffer time after existing bookings
        return !bookings.Any(b => b.RoomId == roomId
            && ((startTime >= b.StartTime && startTime < b.EndTime.AddMinutes(bufferMinutes)) ||
                (endTime > b.StartTime && endTime <= b.EndTime.AddMinutes(bufferMinutes)) ||
                (startTime <= b.StartTime && endTime >= b.EndTime.AddMinutes(bufferMinutes))));
    }

    private string GetStatusBadgeClass(BookingStatus status)
    {
        return status switch
        {
            BookingStatus.Pending => "bg-warning text-dark",
            BookingStatus.Confirmed => "bg-success",
            BookingStatus.Completed => "bg-secondary",
            BookingStatus.Cancelled => "bg-danger",
            BookingStatus.NoShow => "bg-dark",
            _ => "bg-secondary"
        };
    }

    public class AssignmentModel
    {
        public string TherapistId { get; set; } = string.Empty;
        public int ServiceId { get; set; }
        public string ClientId { get; set; } = string.Empty;
        public string? Notes { get; set; }
    }
    
    public class TherapistBookingModel
    {
        public string StartTime { get; set; } = string.Empty;
        public string EndTime { get; set; } = string.Empty;
        public int ServiceId { get; set; }
        public int? RoomId { get; set; }
        public string ClientId { get; set; } = string.Empty;
        public string? Notes { get; set; }
        public string? AssignedRoomName { get; set; }
    }
}

