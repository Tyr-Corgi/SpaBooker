@page "/admin/gift-certificates"
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Authorization
@using SpaBooker.Core.Entities
@using SpaBooker.Core.Interfaces
@using SpaBooker.Infrastructure.Data
@inject IGiftCertificateService GiftCertificateService
@inject ApplicationDbContext DbContext
@inject NavigationManager NavigationManager
@attribute [Authorize(Roles = "Admin")]

<PageTitle>Gift Certificate Management - SpaBooker</PageTitle>

<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-12 d-flex justify-content-between align-items-center">
            <div>
                <h1 class="text-rose-gold mb-2">
                    <i class="bi bi-gift me-2"></i>Gift Certificate Management
                </h1>
                <p class="text-muted">Manage and monitor all gift certificates</p>
            </div>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card border-success">
                <div class="card-body">
                    <h6 class="text-muted mb-2">Active Certificates</h6>
                    <h3 class="text-success mb-0">@activeCertificates</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-primary">
                <div class="card-body">
                    <h6 class="text-muted mb-2">Total Value Active</h6>
                    <h3 class="text-primary mb-0">$@totalActiveValue.ToString("N2")</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-info">
                <div class="card-body">
                    <h6 class="text-muted mb-2">This Month</h6>
                    <h3 class="text-info mb-0">@monthCount</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-warning">
                <div class="card-body">
                    <h6 class="text-muted mb-2">Expiring Soon</h6>
                    <h3 class="text-warning mb-0">@expiringSoon</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-3">
                    <label class="form-label">Status</label>
                    <select class="form-select" @bind="filterStatus" @bind:after="LoadGiftCertificates">
                        <option value="">All Statuses</option>
                        <option value="Active">Active</option>
                        <option value="PartiallyUsed">Partially Used</option>
                        <option value="FullyRedeemed">Fully Redeemed</option>
                        <option value="Expired">Expired</option>
                        <option value="Cancelled">Cancelled</option>
                        <option value="Pending">Pending Payment</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Location</label>
                    <select class="form-select" @bind="filterLocationId" @bind:after="LoadGiftCertificates">
                        <option value="">All Locations</option>
                        @foreach (var location in locations)
                        {
                            <option value="@location.Id">@location.Name</option>
                        }
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Search Code</label>
                    <input type="text" class="form-control" placeholder="Enter code..." 
                           @bind="searchCode" @bind:event="oninput" @bind:after="LoadGiftCertificates"/>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Sort By</label>
                    <select class="form-select" @bind="sortBy" @bind:after="LoadGiftCertificates">
                        <option value="newest">Newest First</option>
                        <option value="oldest">Oldest First</option>
                        <option value="value-high">Highest Value</option>
                        <option value="value-low">Lowest Value</option>
                        <option value="expiring">Expiring Soon</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    @if (isLoading)
    {
        <div class="text-center py-5">
            <div class="spinner"></div>
            <p class="mt-3 text-muted">Loading gift certificates...</p>
        </div>
    }
    else if (!giftCertificates.Any())
    {
        <div class="alert alert-info text-center">
            <i class="bi bi-info-circle me-2"></i>
            No gift certificates found matching your filters.
        </div>
    }
    else
    {
        <!-- Table View -->
        <div class="card shadow-sm">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Code</th>
                                <th>Status</th>
                                <th>Purchased By</th>
                                <th>Recipient</th>
                                <th>Original</th>
                                <th>Balance</th>
                                <th>Purchased</th>
                                <th>Expires</th>
                                <th>Location</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var cert in giftCertificates)
                            {
                                <tr>
                                    <td>
                                        <span class="badge bg-secondary font-monospace">@cert.Code</span>
                                    </td>
                                    <td>
                                        <span class="badge @GetStatusBadgeClass(cert.Status)">
                                            @cert.Status
                                        </span>
                                    </td>
                                    <td>
                                        @cert.PurchasedByUser.FirstName @cert.PurchasedByUser.LastName
                                        <div class="small text-muted">@cert.PurchasedByUser.Email</div>
                                    </td>
                                    <td>
                                        @cert.RecipientName
                                        <div class="small text-muted">@cert.RecipientEmail</div>
                                    </td>
                                    <td>$@cert.OriginalAmount.ToString("F2")</td>
                                    <td>
                                        <strong class="@(cert.RemainingBalance > 0 ? "text-success" : "text-muted")">
                                            $@cert.RemainingBalance.ToString("F2")
                                        </strong>
                                    </td>
                                    <td>
                                        <span class="small">@cert.PurchasedAt.ToLocalTime().ToString("MMM dd, yyyy")</span>
                                    </td>
                                    <td>
                                        @if (cert.ExpiresAt.HasValue)
                                        {
                                            var daysUntilExpiry = (cert.ExpiresAt.Value - DateTime.UtcNow).Days;
                                            <span class="small @(daysUntilExpiry < 30 ? "text-warning fw-bold" : "")">
                                                @cert.ExpiresAt.Value.ToLocalTime().ToString("MMM dd, yyyy")
                                            </span>
                                            @if (daysUntilExpiry > 0 && daysUntilExpiry < 30)
                                            {
                                                <div class="small text-warning">(@daysUntilExpiry days left)</div>
                                            }
                                        }
                                        else
                                        {
                                            <span class="small text-muted">Never</span>
                                        }
                                    </td>
                                    <td>
                                        @if (cert.RestrictedToLocationId.HasValue)
                                        {
                                            <span class="badge bg-info">@cert.RestrictedToLocation?.Name</span>
                                        }
                                        else
                                        {
                                            <span class="text-muted small">All</span>
                                        }
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary" @onclick="() => ViewDetails(cert.Id)">
                                            <i class="bi bi-eye"></i>
                                        </button>
                                        @if (cert.Status == "Active" || cert.Status == "PartiallyUsed")
                                        {
                                            <button class="btn btn-sm btn-outline-danger" @onclick="() => ShowCancelDialog(cert)">
                                                <i class="bi bi-x-circle"></i>
                                            </button>
                                        }
                                        @if (!cert.EmailSent)
                                        {
                                            <button class="btn btn-sm btn-outline-success" @onclick="() => ResendEmail(cert.Id)">
                                                <i class="bi bi-envelope"></i>
                                            </button>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    }
</div>

<!-- Cancel Confirmation Modal -->
@if (showCancelDialog && selectedCertificate != null)
{
    <div class="modal show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">Cancel Gift Certificate</h5>
                    <button type="button" class="btn-close btn-close-white" @onclick="() => showCancelDialog = false"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to cancel gift certificate <strong>@selectedCertificate.Code</strong>?</p>
                    <p class="text-muted small">Remaining balance: $@selectedCertificate.RemainingBalance.ToString("F2")</p>
                    
                    <div class="mb-3">
                        <label class="form-label">Reason for cancellation:</label>
                        <textarea class="form-control" rows="3" @bind="cancellationReason" 
                                  placeholder="Enter reason (e.g., customer request, fraud, etc.)"></textarea>
                    </div>

                    @if (!string.IsNullOrEmpty(cancelErrorMessage))
                    {
                        <div class="alert alert-danger">@cancelErrorMessage</div>
                    }
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" @onclick="() => showCancelDialog = false">Close</button>
                    <button class="btn btn-danger" @onclick="ConfirmCancel" disabled="@isCancelling">
                        @if (isCancelling)
                        {
                            <span class="spinner-border spinner-border-sm me-2"></span>
                        }
                        Cancel Certificate
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private List<GiftCertificate> giftCertificates = new();
    private List<Location> locations = new();
    private bool isLoading = true;
    
    // Filters
    private string filterStatus = "";
    private string filterLocationId = "";
    private string searchCode = "";
    private string sortBy = "newest";
    
    // Summary Stats
    private int activeCertificates;
    private decimal totalActiveValue;
    private int monthCount;
    private int expiringSoon;

    // Cancel dialog
    private bool showCancelDialog = false;
    private GiftCertificate? selectedCertificate;
    private string cancellationReason = "";
    private bool isCancelling = false;
    private string? cancelErrorMessage;

    protected override async Task OnInitializedAsync()
    {
        locations = await DbContext.Locations.Where(l => l.IsActive).ToListAsync();
        await LoadGiftCertificates();
        await CalculateStats();
    }

    private async Task LoadGiftCertificates()
    {
        isLoading = true;

        var query = DbContext.GiftCertificates
            .Include(gc => gc.PurchasedByUser)
            .Include(gc => gc.RestrictedToLocation)
            .Include(gc => gc.Transactions)
            .AsQueryable();

        // Apply filters
        if (!string.IsNullOrEmpty(filterStatus))
        {
            query = query.Where(gc => gc.Status == filterStatus);
        }

        if (!string.IsNullOrEmpty(filterLocationId) && int.TryParse(filterLocationId, out var locId))
        {
            query = query.Where(gc => gc.RestrictedToLocationId == locId);
        }

        if (!string.IsNullOrEmpty(searchCode))
        {
            var searchUpper = searchCode.Trim().ToUpper();
            query = query.Where(gc => gc.Code.Contains(searchUpper));
        }

        // Apply sorting
        query = sortBy switch
        {
            "oldest" => query.OrderBy(gc => gc.PurchasedAt),
            "value-high" => query.OrderByDescending(gc => gc.RemainingBalance),
            "value-low" => query.OrderBy(gc => gc.RemainingBalance),
            "expiring" => query.OrderBy(gc => gc.ExpiresAt),
            _ => query.OrderByDescending(gc => gc.PurchasedAt) // newest (default)
        };

        giftCertificates = await query.ToListAsync();
        isLoading = false;
    }

    private async Task CalculateStats()
    {
        activeCertificates = await DbContext.GiftCertificates
            .Where(gc => gc.Status == "Active" || gc.Status == "PartiallyUsed")
            .CountAsync();

        totalActiveValue = await DbContext.GiftCertificates
            .Where(gc => gc.Status == "Active" || gc.Status == "PartiallyUsed")
            .SumAsync(gc => gc.RemainingBalance);

        var firstDayOfMonth = new DateTime(DateTime.UtcNow.Year, DateTime.UtcNow.Month, 1);
        monthCount = await DbContext.GiftCertificates
            .Where(gc => gc.PurchasedAt >= firstDayOfMonth)
            .CountAsync();

        var thirtyDaysFromNow = DateTime.UtcNow.AddDays(30);
        expiringSoon = await DbContext.GiftCertificates
            .Where(gc => gc.ExpiresAt.HasValue 
                && gc.ExpiresAt.Value <= thirtyDaysFromNow 
                && gc.ExpiresAt.Value > DateTime.UtcNow
                && (gc.Status == "Active" || gc.Status == "PartiallyUsed"))
            .CountAsync();
    }

    private void ViewDetails(int id)
    {
        // For now, just show an alert - we could create a detailed view page later
        NavigationManager.NavigateTo($"/admin/gift-certificate/{id}");
    }

    private void ShowCancelDialog(GiftCertificate cert)
    {
        selectedCertificate = cert;
        cancellationReason = "";
        cancelErrorMessage = null;
        showCancelDialog = true;
    }

    private async Task ConfirmCancel()
    {
        if (selectedCertificate == null) return;

        if (string.IsNullOrWhiteSpace(cancellationReason))
        {
            cancelErrorMessage = "Please provide a reason for cancellation";
            return;
        }

        isCancelling = true;
        cancelErrorMessage = null;

        try
        {
            await GiftCertificateService.CancelGiftCertificateAsync(selectedCertificate.Id, cancellationReason);
            showCancelDialog = false;
            await LoadGiftCertificates();
            await CalculateStats();
        }
        catch (Exception ex)
        {
            cancelErrorMessage = $"Error cancelling certificate: {ex.Message}";
        }
        finally
        {
            isCancelling = false;
        }
    }

    private async Task ResendEmail(int id)
    {
        try
        {
            await GiftCertificateService.SendGiftCertificateEmailAsync(id);
            await LoadGiftCertificates();
        }
        catch (Exception)
        {
            // Handle error
        }
    }

    private string GetStatusBadgeClass(string status)
    {
        return status switch
        {
            "Active" => "bg-success",
            "PartiallyUsed" => "bg-info",
            "FullyRedeemed" => "bg-secondary",
            "Expired" => "bg-warning",
            "Cancelled" => "bg-danger",
            "Pending" => "bg-warning",
            _ => "bg-secondary"
        };
    }
}

