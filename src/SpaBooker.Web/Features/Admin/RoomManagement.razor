@page "/admin/rooms"
@using Microsoft.EntityFrameworkCore
@using SpaBooker.Core.Entities
@using SpaBooker.Infrastructure.Data
@using Microsoft.AspNetCore.Authorization
@inject ApplicationDbContext DbContext
@inject NavigationManager NavigationManager
@inject UserManager<ApplicationUser> UserManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@attribute [Authorize(Roles = "Admin")]

<PageTitle>Room Management - SpaBooker</PageTitle>

<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-12 d-flex justify-content-between align-items-center">
            <div>
                <h1 class="text-rose-gold mb-2">
                    <i class="bi bi-door-open me-2"></i>Room Management
                </h1>
                <p class="text-muted">Manage treatment rooms and their service capabilities</p>
            </div>
            <button class="btn btn-primary" @onclick="ShowCreateDialog">
                <i class="bi bi-plus-circle me-2"></i>Add New Room
            </button>
        </div>
    </div>

    @if (!string.IsNullOrEmpty(successMessage))
    {
        <div class="alert alert-success alert-dismissible fade show">
            <i class="bi bi-check-circle me-2"></i>
            @successMessage
            <button type="button" class="btn-close" @onclick="() => successMessage = null"></button>
        </div>
    }

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger alert-dismissible fade show">
            <i class="bi bi-exclamation-triangle me-2"></i>
            @errorMessage
            <button type="button" class="btn-close" @onclick="() => errorMessage = null"></button>
        </div>
    }

    <!-- Filter by Location -->
    <div class="row mb-4">
        <div class="col-12">
            <ul class="nav nav-tabs">
                <li class="nav-item">
                    <a class="nav-link @(selectedLocationId == null ? "active" : "")" 
                       href="#" 
                       @onclick="() => FilterByLocation(null)" 
                       @onclick:preventDefault>
                        All Locations (@allRooms.Count)
                    </a>
                </li>
                @foreach (var location in locations)
                {
                    <li class="nav-item">
                        <a class="nav-link @(selectedLocationId == location.Id ? "active" : "")" 
                           href="#"
                           @onclick="() => FilterByLocation(location.Id)" 
                           @onclick:preventDefault>
                            @location.Name (@GetLocationRoomCount(location.Id))
                        </a>
                    </li>
                }
            </ul>
        </div>
    </div>

    @if (isLoading)
    {
        <div class="text-center py-5">
            <div class="spinner"></div>
            <p class="mt-3 text-muted">Loading rooms...</p>
        </div>
    }
    else
    {
        <!-- Rooms Grid -->
        <div class="row">
            @if (filteredRooms.Any())
            {
                @foreach (var room in filteredRooms.OrderBy(r => r.DisplayOrder))
                {
                    var roomCapabilities = roomServiceCapabilities.ContainsKey(room.Id) 
                        ? roomServiceCapabilities[room.Id] 
                        : new List<RoomServiceCapability>();

                    <div class="col-md-6 col-lg-4 mb-4">
                        <div class="card room-card h-100 @(!room.IsActive ? "inactive" : "")" 
                             style="border-left: 4px solid @room.ColorCode;">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-3">
                                    <div class="d-flex align-items-center">
                                        <span class="room-color-badge me-2" 
                                              style="background-color: @room.ColorCode;"></span>
                                        <h5 class="card-title mb-0">@room.Name</h5>
                                    </div>
                                    @if (!room.IsActive)
                                    {
                                        <span class="badge bg-secondary">Inactive</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-success">Active</span>
                                    }
                                </div>

                                <div class="room-details mb-3">
                                    <div class="detail-item">
                                        <i class="bi bi-geo-alt text-rose-gold"></i>
                                        <span>@room.Location.Name</span>
                                    </div>
                                    <div class="detail-item">
                                        <i class="bi bi-list-ol text-rose-gold"></i>
                                        <span>Display Order: @room.DisplayOrder</span>
                                    </div>
                                    <div class="detail-item">
                                        <i class="bi bi-palette text-rose-gold"></i>
                                        <span>Color: @room.ColorCode</span>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <h6 class="text-muted mb-2">
                                        <i class="bi bi-spa"></i> Service Capabilities (@roomCapabilities.Count)
                                    </h6>
                                    @if (roomCapabilities.Any())
                                    {
                                        <div class="service-badges">
                                            @foreach (var capability in roomCapabilities.Take(3))
                                            {
                                                <span class="badge bg-light text-dark mb-1">
                                                    @capability.Service.Name
                                                </span>
                                            }
                                            @if (roomCapabilities.Count > 3)
                                            {
                                                <span class="badge bg-light text-muted mb-1">
                                                    +@(roomCapabilities.Count - 3) more
                                                </span>
                                            }
                                        </div>
                                    }
                                    else
                                    {
                                        <p class="text-muted small mb-0">No services assigned</p>
                                    }
                                </div>

                                <div class="d-flex gap-2">
                                    <button class="btn btn-sm btn-outline-primary flex-grow-1" 
                                            @onclick="() => ShowEditDialog(room)">
                                        <i class="bi bi-pencil"></i> Edit
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" 
                                            @onclick="() => ConfirmDelete(room)">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            }
            else
            {
                <div class="col-12">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        No rooms found. Click "Add New Room" to create one.
                    </div>
                </div>
            }
        </div>
    }
</div>

<!-- Create/Edit Modal -->
@if (showModal)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        @(isEditMode ? "Edit Room" : "Create New Room")
                    </h5>
                    <button type="button" class="btn-close" @onclick="CloseModal"></button>
                </div>
                <div class="modal-body">
                    <EditForm Model="currentRoom" OnValidSubmit="SaveRoom">
                        <DataAnnotationsValidator />

                        <div class="mb-3">
                            <label class="form-label">Room Name *</label>
                            <InputText class="form-control" @bind-Value="currentRoom.Name" 
                                       placeholder="e.g., Room 1" />
                            <ValidationMessage For="@(() => currentRoom.Name)" />
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Location *</label>
                                <InputSelect class="form-select" @bind-Value="currentRoom.LocationId">
                                    <option value="">-- Select Location --</option>
                                    @foreach (var location in locations)
                                    {
                                        <option value="@location.Id">@location.Name</option>
                                    }
                                </InputSelect>
                                <ValidationMessage For="@(() => currentRoom.LocationId)" />
                            </div>

                            <div class="col-md-6 mb-3">
                                <label class="form-label">Display Order *</label>
                                <InputNumber class="form-control" @bind-Value="currentRoom.DisplayOrder" 
                                             min="1" />
                                <ValidationMessage For="@(() => currentRoom.DisplayOrder)" />
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Color Code *</label>
                            <div class="input-group">
                                <InputText type="color" class="form-control form-control-color" 
                                           @bind-Value="currentRoom.ColorCode" 
                                           style="width: 80px;" />
                                <InputText class="form-control" @bind-Value="currentRoom.ColorCode" 
                                           placeholder="#3B82F6" />
                            </div>
                            <small class="text-muted">Choose a color to identify this room visually</small>
                            <ValidationMessage For="@(() => currentRoom.ColorCode)" />
                        </div>

                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <InputCheckbox class="form-check-input" @bind-Value="currentRoom.IsActive" 
                                               id="isActiveCheck" />
                                <label class="form-check-label" for="isActiveCheck">
                                    Room is Active
                                </label>
                            </div>
                        </div>

                        <hr />

                        <div class="mb-3">
                            <label class="form-label">
                                <i class="bi bi-spa me-1"></i>Service Capabilities
                            </label>
                            <p class="text-muted small">Select which services can be performed in this room</p>
                            
                            @if (currentRoom.LocationId > 0)
                            {
                                var locationServices = allServices
                                    .Where(s => s.LocationId == currentRoom.LocationId)
                                    .ToList();

                                @if (locationServices.Any())
                                {
                                    <div class="service-checkboxes">
                                        @foreach (var service in locationServices)
                                        {
                                            var isChecked = selectedServiceIds.Contains(service.Id);
                                            <div class="form-check mb-2">
                                                <input type="checkbox" class="form-check-input" 
                                                       id="service-@service.Id"
                                                       checked="@isChecked"
                                                       @onchange="@(e => ToggleService(service.Id, e.Value))" />
                                                <label class="form-check-label" for="service-@service.Id">
                                                    @service.Name
                                                    <small class="text-muted">(@service.DurationMinutes min)</small>
                                                </label>
                                            </div>
                                        }
                                    </div>
                                }
                                else
                                {
                                    <div class="alert alert-warning">
                                        <i class="bi bi-exclamation-triangle me-2"></i>
                                        No services available for this location.
                                    </div>
                                }
                            }
                            else
                            {
                                <div class="alert alert-info">
                                    <i class="bi bi-info-circle me-2"></i>
                                    Please select a location first to choose services.
                                </div>
                            }
                        </div>

                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" @onclick="CloseModal">
                                Cancel
                            </button>
                            <button type="submit" class="btn btn-primary" disabled="@isSaving">
                                @if (isSaving)
                                {
                                    <span class="spinner-border spinner-border-sm me-2"></span>
                                }
                                @(isEditMode ? "Update Room" : "Create Room")
                            </button>
                        </div>
                    </EditForm>
                </div>
            </div>
        </div>
    </div>
}

<!-- Delete Confirmation Modal -->
@if (showDeleteConfirm)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirm Delete</h5>
                    <button type="button" class="btn-close" @onclick="CancelDelete"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete <strong>@roomToDelete?.Name</strong>?</p>
                    <p class="text-danger">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        This action cannot be undone. Any bookings assigned to this room will become unassigned.
                    </p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CancelDelete">
                        Cancel
                    </button>
                    <button type="button" class="btn btn-danger" @onclick="DeleteRoom" disabled="@isDeleting">
                        @if (isDeleting)
                        {
                            <span class="spinner-border spinner-border-sm me-2"></span>
                        }
                        Delete Room
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private bool isLoading = true;
    private bool isSaving = false;
    private bool isDeleting = false;
    private bool showModal = false;
    private bool showDeleteConfirm = false;
    private bool isEditMode = false;

    private string? successMessage;
    private string? errorMessage;

    private List<Room> allRooms = new();
    private List<Room> filteredRooms = new();
    private List<Location> locations = new();
    private List<SpaService> allServices = new();
    private Dictionary<int, List<RoomServiceCapability>> roomServiceCapabilities = new();
    
    private int? selectedLocationId;
    private Room currentRoom = new();
    private Room? roomToDelete;
    private HashSet<int> selectedServiceIds = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        isLoading = true;

        try
        {
            // Get current user's location to default to
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;
            
            if (user.Identity?.IsAuthenticated == true)
            {
                var currentUser = await UserManager.GetUserAsync(user);
                if (currentUser?.LocationId != null)
                {
                    selectedLocationId = currentUser.LocationId;
                }
            }

            locations = await DbContext.Locations
                .Where(l => l.IsActive)
                .OrderBy(l => l.Name)
                .ToListAsync();

            allServices = await DbContext.SpaServices
                .Where(s => s.IsActive)
                .OrderBy(s => s.Name)
                .ToListAsync();

            allRooms = await DbContext.Rooms
                .Include(r => r.Location)
                .ToListAsync();

            var capabilities = await DbContext.RoomServiceCapabilities
                .Include(rsc => rsc.Service)
                .ToListAsync();

            roomServiceCapabilities = capabilities
                .GroupBy(rsc => rsc.RoomId)
                .ToDictionary(g => g.Key, g => g.ToList());

            FilterByLocation(selectedLocationId);
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading rooms: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private void FilterByLocation(int? locationId)
    {
        selectedLocationId = locationId;
        filteredRooms = locationId.HasValue
            ? allRooms.Where(r => r.LocationId == locationId).ToList()
            : allRooms;
    }

    private int GetLocationRoomCount(int locationId)
    {
        return allRooms.Count(r => r.LocationId == locationId);
    }

    private void ShowCreateDialog()
    {
        isEditMode = false;
        currentRoom = new Room 
        { 
            IsActive = true,
            DisplayOrder = 1,
            ColorCode = "#3B82F6"
        };
        selectedServiceIds.Clear();
        showModal = true;
    }

    private void ShowEditDialog(Room room)
    {
        isEditMode = true;
        currentRoom = new Room
        {
            Id = room.Id,
            Name = room.Name,
            ColorCode = room.ColorCode,
            LocationId = room.LocationId,
            DisplayOrder = room.DisplayOrder,
            IsActive = room.IsActive
        };

        // Load existing service capabilities
        if (roomServiceCapabilities.ContainsKey(room.Id))
        {
            selectedServiceIds = roomServiceCapabilities[room.Id]
                .Select(rsc => rsc.ServiceId)
                .ToHashSet();
        }
        else
        {
            selectedServiceIds.Clear();
        }

        showModal = true;
    }

    private void CloseModal()
    {
        showModal = false;
        currentRoom = new();
        selectedServiceIds.Clear();
    }

    private void ToggleService(int serviceId, object? value)
    {
        var isChecked = value is bool b && b;
        if (isChecked)
        {
            selectedServiceIds.Add(serviceId);
        }
        else
        {
            selectedServiceIds.Remove(serviceId);
        }
    }

    private async Task SaveRoom()
    {
        isSaving = true;
        errorMessage = null;

        try
        {
            if (currentRoom.LocationId == 0)
            {
                errorMessage = "Please select a location.";
                return;
            }

            if (string.IsNullOrWhiteSpace(currentRoom.Name))
            {
                errorMessage = "Room name is required.";
                return;
            }

            if (isEditMode)
            {
                var existingRoom = await DbContext.Rooms
                    .FirstOrDefaultAsync(r => r.Id == currentRoom.Id);

                if (existingRoom == null)
                {
                    errorMessage = "Room not found.";
                    return;
                }

                existingRoom.Name = currentRoom.Name;
                existingRoom.ColorCode = currentRoom.ColorCode;
                existingRoom.LocationId = currentRoom.LocationId;
                existingRoom.DisplayOrder = currentRoom.DisplayOrder;
                existingRoom.IsActive = currentRoom.IsActive;

                // Update service capabilities
                var existingCapabilities = await DbContext.RoomServiceCapabilities
                    .Where(rsc => rsc.RoomId == existingRoom.Id)
                    .ToListAsync();

                DbContext.RoomServiceCapabilities.RemoveRange(existingCapabilities);

                foreach (var serviceId in selectedServiceIds)
                {
                    DbContext.RoomServiceCapabilities.Add(new RoomServiceCapability
                    {
                        RoomId = existingRoom.Id,
                        ServiceId = serviceId,
                        CreatedAt = DateTime.UtcNow
                    });
                }

                successMessage = $"Room '{existingRoom.Name}' updated successfully!";
            }
            else
            {
                var newRoom = new Room
                {
                    Name = currentRoom.Name,
                    ColorCode = currentRoom.ColorCode,
                    LocationId = currentRoom.LocationId,
                    DisplayOrder = currentRoom.DisplayOrder,
                    IsActive = currentRoom.IsActive,
                    CreatedAt = DateTime.UtcNow
                };

                DbContext.Rooms.Add(newRoom);
                await DbContext.SaveChangesAsync();

                // Add service capabilities
                foreach (var serviceId in selectedServiceIds)
                {
                    DbContext.RoomServiceCapabilities.Add(new RoomServiceCapability
                    {
                        RoomId = newRoom.Id,
                        ServiceId = serviceId,
                        CreatedAt = DateTime.UtcNow
                    });
                }

                successMessage = $"Room '{newRoom.Name}' created successfully!";
            }

            await DbContext.SaveChangesAsync();
            await LoadData();
            CloseModal();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error saving room: {ex.Message}";
        }
        finally
        {
            isSaving = false;
        }
    }

    private void ConfirmDelete(Room room)
    {
        roomToDelete = room;
        showDeleteConfirm = true;
    }

    private void CancelDelete()
    {
        roomToDelete = null;
        showDeleteConfirm = false;
    }

    private async Task DeleteRoom()
    {
        if (roomToDelete == null) return;

        isDeleting = true;
        errorMessage = null;

        try
        {
            // Remove service capabilities first
            var capabilities = await DbContext.RoomServiceCapabilities
                .Where(rsc => rsc.RoomId == roomToDelete.Id)
                .ToListAsync();

            DbContext.RoomServiceCapabilities.RemoveRange(capabilities);

            // Set any bookings with this room to null (unassigned)
            var bookings = await DbContext.Bookings
                .Where(b => b.RoomId == roomToDelete.Id)
                .ToListAsync();

            foreach (var booking in bookings)
            {
                booking.RoomId = null;
            }

            // Remove the room
            DbContext.Rooms.Remove(roomToDelete);
            await DbContext.SaveChangesAsync();

            successMessage = $"Room '{roomToDelete.Name}' deleted successfully!";
            await LoadData();
            CancelDelete();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error deleting room: {ex.Message}";
        }
        finally
        {
            isDeleting = false;
        }
    }
}

