@page "/schedule/my-schedule"
@using Microsoft.EntityFrameworkCore
@using SpaBooker.Core.Entities
@using SpaBooker.Infrastructure.Data
@using Microsoft.AspNetCore.Authorization
@inject ApplicationDbContext DbContext
@inject UserManager<ApplicationUser> UserManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@attribute [Authorize(Roles = "Therapist,Admin")]

<PageTitle>My Schedule - SpaBooker</PageTitle>

<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="text-rose-gold mb-2">My Schedule</h1>
            <p class="text-muted">View and manage your appointments</p>
        </div>
    </div>

    @if (isLoading)
    {
        <div class="text-center py-5">
            <div class="spinner"></div>
            <p class="mt-3 text-muted">Loading schedule...</p>
        </div>
    }
    else
    {
        <!-- Date Navigation -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                            <button class="btn btn-outline-primary" @onclick="PreviousWeek">
                                <i class="bi bi-chevron-left"></i> Previous Week
                            </button>
                            
                            <div class="text-center">
                                <h5 class="mb-0">
                                    @selectedWeekStart.ToString("MMM dd") - @selectedWeekStart.AddDays(6).ToString("MMM dd, yyyy")
                                </h5>
                                <button class="btn btn-sm btn-link" @onclick="GoToToday">Go to Today</button>
                            </div>
                            
                            <button class="btn btn-outline-primary" @onclick="NextWeek">
                                Next Week <i class="bi bi-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Weekly Calendar View -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-body p-0">
                        <div class="schedule-grid">
                            @for (int i = 0; i < 7; i++)
                            {
                                var day = selectedWeekStart.AddDays(i);
                                var dayBookings = GetBookingsForDay(day);
                                var isToday = day.Date == DateTime.Today;
                                
                                <div class="schedule-day @(isToday ? "today" : "")">
                                    <div class="day-header">
                                        <div class="day-name">@day.ToString("ddd")</div>
                                        <div class="day-date @(isToday ? "text-primary fw-bold" : "")">
                                            @day.ToString("MMM dd")
                                        </div>
                                    </div>
                                    
                                    <div class="day-content">
                                        @if (dayBookings.Any())
                                        {
                                            @foreach (var booking in dayBookings.OrderBy(b => b.StartTime))
                                            {
                                                <div class="booking-item status-@booking.Status.ToString().ToLower()"
                                                     @onclick="() => SelectBooking(booking.Id)">
                                                    <div class="booking-time">
                                                        @booking.StartTime.ToString("h:mm tt")
                                                    </div>
                                                    <div class="booking-service">
                                                        @booking.Service?.Name
                                                    </div>
                                                    <div class="booking-client">
                                                        @booking.Client.FirstName @booking.Client.LastName
                                                    </div>
                                                    <div class="booking-duration text-muted small">
                                                        @(booking.Service?.DurationMinutes ?? 0) min
                                                    </div>
                                                </div>
                                            }
                                        }
                                        else
                                        {
                                            <div class="text-center text-muted py-3 small">
                                                No appointments
                                            </div>
                                        }
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Daily Summary -->
        <div class="row mt-4">
            <div class="col-md-6 col-lg-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h3 class="text-rose-gold mb-2">@todayBookings.Count</h3>
                        <p class="mb-0 text-muted">Today's Appointments</p>
                    </div>
                </div>
            </div>
            <div class="col-md-6 col-lg-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h3 class="text-rose-gold mb-2">@weekBookings.Count</h3>
                        <p class="mb-0 text-muted">This Week</p>
                    </div>
                </div>
            </div>
            <div class="col-md-6 col-lg-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h3 class="text-rose-gold mb-2">@pendingCount</h3>
                        <p class="mb-0 text-muted">Pending Confirmations</p>
                    </div>
                </div>
            </div>
            <div class="col-md-6 col-lg-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h3 class="text-rose-gold mb-2">@CalculateTotalHours()</h3>
                        <p class="mb-0 text-muted">Hours This Week</p>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

<!-- Booking Details Modal -->
@if (selectedBookingId.HasValue && selectedBooking != null)
{
    <div class="modal-backdrop show"></div>
    <div class="modal show d-block" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Appointment Details</h5>
                    <button type="button" class="btn-close" @onclick="CloseModal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-rose-gold mb-3">Appointment Information</h6>
                            <dl class="row">
                                <dt class="col-sm-4">Service:</dt>
                                <dd class="col-sm-8">@selectedBooking.Service?.Name</dd>
                                
                                <dt class="col-sm-4">Date:</dt>
                                <dd class="col-sm-8">@selectedBooking.StartTime.ToString("MMMM dd, yyyy")</dd>
                                
                                <dt class="col-sm-4">Time:</dt>
                                <dd class="col-sm-8">
                                    @selectedBooking.StartTime.ToString("h:mm tt") - @selectedBooking.EndTime.ToString("h:mm tt")
                                </dd>
                                
                                <dt class="col-sm-4">Duration:</dt>
                                <dd class="col-sm-8">@(selectedBooking.Service?.DurationMinutes ?? 0) minutes</dd>
                                
                                <dt class="col-sm-4">Status:</dt>
                                <dd class="col-sm-8">
                                    <span class="badge @GetStatusBadgeClass(selectedBooking.Status)">
                                        @selectedBooking.Status
                                    </span>
                                </dd>
                            </dl>
                        </div>
                        
                        <div class="col-md-6">
                            <h6 class="text-rose-gold mb-3">Client Information</h6>
                            <dl class="row">
                                <dt class="col-sm-4">Name:</dt>
                                <dd class="col-sm-8">@selectedBooking.Client.FirstName @selectedBooking.Client.LastName</dd>
                                
                                <dt class="col-sm-4">Email:</dt>
                                <dd class="col-sm-8">@selectedBooking.Client.Email</dd>
                                
                                <dt class="col-sm-4">Phone:</dt>
                                <dd class="col-sm-8">@selectedBooking.Client.PhoneNumber</dd>
                            </dl>
                        </div>
                    </div>
                    
                    @if (!string.IsNullOrEmpty(selectedBooking.Notes))
                    {
                        <div class="mt-3">
                            <h6 class="text-rose-gold">Client Notes:</h6>
                            <div class="alert alert-info">
                                @selectedBooking.Notes
                            </div>
                        </div>
                    }
                    
                    <div class="mt-3">
                        <h6 class="text-rose-gold">Pricing:</h6>
                        <dl class="row">
                            <dt class="col-sm-4">Service Price:</dt>
                            <dd class="col-sm-8">$@selectedBooking.ServicePrice.ToString("F2")</dd>
                            
                            @if (selectedBooking.DiscountApplied > 0)
                            {
                                <dt class="col-sm-4">Discount:</dt>
                                <dd class="col-sm-8 text-success">-$@selectedBooking.DiscountApplied.Value.ToString("F2")</dd>
                            }
                            
                            <dt class="col-sm-4">Total:</dt>
                            <dd class="col-sm-8 fw-bold">$@selectedBooking.TotalPrice.ToString("F2")</dd>
                        </dl>
                    </div>
                </div>
                <div class="modal-footer">
                    @if (selectedBooking.Status == BookingStatus.Pending)
                    {
                        <button type="button" class="btn btn-success" @onclick="ConfirmBooking">
                            Confirm Appointment
                        </button>
                    }
                    @if (selectedBooking.Status == BookingStatus.Confirmed)
                    {
                        <button type="button" class="btn btn-primary" @onclick="MarkCompleted">
                            Mark as Completed
                        </button>
                        <button type="button" class="btn btn-warning" @onclick="MarkNoShow">
                            Mark as No-Show
                        </button>
                    }
                    <button type="button" class="btn btn-secondary" @onclick="CloseModal">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private List<Booking> allBookings = new();
    private List<Booking> weekBookings = new();
    private List<Booking> todayBookings = new();
    private DateTime selectedWeekStart;
    private bool isLoading = true;
    private string? currentUserId;
    private int? selectedBookingId;
    private Booking? selectedBooking;
    private int pendingCount = 0;

    protected override async Task OnInitializedAsync()
    {
        await GetCurrentUser();
        selectedWeekStart = GetWeekStart(DateTime.Today);
        await LoadSchedule();
    }

    private async Task GetCurrentUser()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        
        if (user.Identity?.IsAuthenticated == true)
        {
            var appUser = await UserManager.GetUserAsync(user);
            currentUserId = appUser?.Id;
        }
    }

    private async Task LoadSchedule()
    {
        if (string.IsNullOrEmpty(currentUserId)) return;

        isLoading = true;

        var weekEnd = selectedWeekStart.AddDays(7);

        allBookings = await DbContext.Bookings
            .Include(b => b.Service)
            .Include(b => b.Client)
            .Include(b => b.Location)
            .Where(b => b.TherapistId == currentUserId)
            .OrderBy(b => b.StartTime)
            .ToListAsync();

        weekBookings = allBookings
            .Where(b => b.StartTime >= selectedWeekStart && b.StartTime < weekEnd)
            .ToList();

        todayBookings = allBookings
            .Where(b => b.StartTime.Date == DateTime.Today && b.Status != BookingStatus.Cancelled)
            .ToList();

        pendingCount = weekBookings.Count(b => b.Status == BookingStatus.Pending);

        isLoading = false;
    }

    private DateTime GetWeekStart(DateTime date)
    {
        int diff = (7 + (date.DayOfWeek - DayOfWeek.Sunday)) % 7;
        return date.AddDays(-diff).Date;
    }

    private List<Booking> GetBookingsForDay(DateTime day)
    {
        return weekBookings
            .Where(b => b.StartTime.Date == day.Date && b.Status != BookingStatus.Cancelled)
            .ToList();
    }

    private async Task PreviousWeek()
    {
        selectedWeekStart = selectedWeekStart.AddDays(-7);
        await LoadSchedule();
    }

    private async Task NextWeek()
    {
        selectedWeekStart = selectedWeekStart.AddDays(7);
        await LoadSchedule();
    }

    private async Task GoToToday()
    {
        selectedWeekStart = GetWeekStart(DateTime.Today);
        await LoadSchedule();
    }

    private async Task SelectBooking(int bookingId)
    {
        selectedBookingId = bookingId;
        selectedBooking = await DbContext.Bookings
            .Include(b => b.Service)
            .Include(b => b.Client)
            .Include(b => b.Location)
            .FirstOrDefaultAsync(b => b.Id == bookingId);
    }

    private void CloseModal()
    {
        selectedBookingId = null;
        selectedBooking = null;
    }

    private async Task ConfirmBooking()
    {
        if (selectedBooking == null) return;

        selectedBooking.Status = BookingStatus.Confirmed;
        selectedBooking.UpdatedAt = DateTime.UtcNow;
        await DbContext.SaveChangesAsync();
        
        await LoadSchedule();
        CloseModal();
    }

    private async Task MarkCompleted()
    {
        if (selectedBooking == null) return;

        selectedBooking.Status = BookingStatus.Completed;
        selectedBooking.UpdatedAt = DateTime.UtcNow;
        await DbContext.SaveChangesAsync();
        
        await LoadSchedule();
        CloseModal();
    }

    private async Task MarkNoShow()
    {
        if (selectedBooking == null) return;

        selectedBooking.Status = BookingStatus.NoShow;
        selectedBooking.UpdatedAt = DateTime.UtcNow;
        await DbContext.SaveChangesAsync();
        
        await LoadSchedule();
        CloseModal();
    }

    private string GetStatusBadgeClass(BookingStatus status)
    {
        return status switch
        {
            BookingStatus.Pending => "badge-warning",
            BookingStatus.Confirmed => "badge-success",
            BookingStatus.Completed => "badge-secondary",
            BookingStatus.Cancelled => "badge-danger",
            BookingStatus.NoShow => "badge-danger",
            _ => "badge-secondary"
        };
    }

    private string CalculateTotalHours()
    {
        var totalMinutes = weekBookings
            .Where(b => b.Status != BookingStatus.Cancelled)
            .Sum(b => b.Service?.DurationMinutes ?? 0);
        var hours = totalMinutes / 60.0;
        return hours.ToString("F1") + "h";
    }
}

