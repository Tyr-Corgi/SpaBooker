@page "/schedule/enhanced"
@using Microsoft.EntityFrameworkCore
@using SpaBooker.Core.Entities
@using SpaBooker.Infrastructure.Data
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Web
@inject ApplicationDbContext DbContext
@inject UserManager<ApplicationUser> UserManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject NavigationManager NavigationManager
@attribute [Authorize(Roles = "Therapist,Admin")]
@rendermode @(new InteractiveServerRenderMode(prerender: false))

<PageTitle>Schedule - SpaBooker</PageTitle>

<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                <div>
                    <h1 class="text-rose-gold mb-2">@GetScheduleTitle()</h1>
                    <p class="text-muted mb-0">View appointments and manage availability</p>
                </div>
                <div class="d-flex gap-2 flex-wrap align-items-center">
                    @if (isAdmin && therapists.Any())
                    {
                        <button class="btn btn-outline-secondary" @onclick="ShowViewScheduleModal">
                            <i class="bi bi-people"></i> View Another Schedule
                        </button>
                    }
                    <button class="btn btn-primary" @onclick="() => ShowBlockTimeModal()">
                        <i class="bi bi-calendar-x"></i> Block Time Off
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Debug Info -->
    @if (!string.IsNullOrEmpty(debugMessage))
    {
        <div class="alert alert-info alert-dismissible fade show">
            <strong>Debug:</strong> @debugMessage
            <button type="button" class="btn-close" @onclick="() => debugMessage = null"></button>
        </div>
    }

    @if (isLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3 text-muted">Loading schedule...</p>
        </div>
    }
    else
    {
        <!-- View Controls -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <!-- View Mode Selection -->
                            <div class="col-md-4 mb-3 mb-md-0">
                                <div class="btn-group w-100" role="group">
                                    <button type="button" class="btn btn-sm @(viewMode == ViewMode.Day ? "btn-primary" : "btn-outline-primary")" 
                                            @onclick="() => ChangeViewMode(ViewMode.Day)">Day</button>
                                    <button type="button" class="btn btn-sm @(viewMode == ViewMode.Week ? "btn-primary" : "btn-outline-primary")" 
                                            @onclick="() => ChangeViewMode(ViewMode.Week)">Week</button>
                                    <button type="button" class="btn btn-sm @(viewMode == ViewMode.Fortnight ? "btn-primary" : "btn-outline-primary")" 
                                            @onclick="() => ChangeViewMode(ViewMode.Fortnight)">Fortnight</button>
                                    <button type="button" class="btn btn-sm @(viewMode == ViewMode.Month ? "btn-primary" : "btn-outline-primary")" 
                                            @onclick="() => ChangeViewMode(ViewMode.Month)">Month</button>
                                </div>
                            </div>
                            
                            <!-- Navigation Controls -->
                            <div class="col-md-4 mb-3 mb-md-0">
                                <div class="d-flex justify-content-center align-items-center gap-2">
                                    <button class="btn btn-outline-secondary btn-sm" @onclick="NavigatePrevious">
                                        <i class="bi bi-chevron-left"></i>
                                    </button>
                                    
                                    <div class="text-center">
                                        <strong>@GetDateRangeDisplay()</strong>
                                    </div>
                                    
                                    <button class="btn btn-outline-secondary btn-sm" @onclick="NavigateNext">
                                        <i class="bi bi-chevron-right"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Today Button -->
                            <div class="col-md-4 text-md-end">
                                <button class="btn btn-outline-primary btn-sm" @onclick="GoToToday">
                                    <i class="bi bi-calendar-check"></i> Today
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Calendar View -->
        @if (viewMode == ViewMode.Day)
        {
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title text-center mb-4">@currentDate.ToString("dddd, dd/MM/yyyy")</h5>
                            <div class="day-view-grid">
                                <!-- Header Row -->
                                <div class="time-slot-row header-row">
                                    <div class="time-label">Time</div>
                                    <div class="client-column">Client</div>
                                    <div class="service-column">Service</div>
                                    <div class="room-column">Room</div>
                                    <div class="status-column">Status</div>
                                </div>
                                
                                @foreach (var timeSlot in timeSlots)
                                {
                                    var slotEnd = timeSlot.Add(TimeSpan.FromMinutes(15));
                                    var slotBooking = bookings.FirstOrDefault(b => 
                                        b.StartTime.Date == currentDate.Date && 
                                        b.StartTime.TimeOfDay <= timeSlot && 
                                        b.EndTime.TimeOfDay > timeSlot);
                                    
                                    var slotBlock = blockedTimes.FirstOrDefault(bt => 
                                        bt.SpecificDate == currentDate.Date &&
                                        ((bt.StartTime == TimeSpan.Zero && bt.EndTime.TotalSeconds >= 86399) ||
                                         (bt.StartTime <= timeSlot && bt.EndTime > timeSlot)));
                                    
                                    var isBooked = slotBooking != null;
                                    var isBlocked = slotBlock != null;
                                    var statusClass = isBooked ? $"booked status-{slotBooking!.Status.ToString().ToLower()}" : 
                                                     isBlocked ? "blocked" : "open";
                                    
                                    <div class="time-slot-row @statusClass" @onclick="() => HandleSlotClick(slotBooking, slotBlock)">
                                        <div class="time-label">@timeSlot.ToString(@"hh\:mm")</div>
                                        <div class="client-column">
                                            @if (isBlocked)
                                            {
                                                <span class="text-danger fw-bold">ðŸš« Blocked</span>
                                            }
                                            else if (isBooked)
                                            {
                                                <span class="fw-bold">Client: @slotBooking.Client.FirstName @slotBooking.Client.LastName</span>
                                            }
                                            else
                                            {
                                                <span class="text-muted">Client: Open</span>
                                            }
                                        </div>
                                        <div class="service-column">
                                            @if (isBooked)
                                            {
                                                <span>@slotBooking?.Service?.Name</span>
                                            }
                                        </div>
                                        <div class="room-column">
                                            @if (isBooked)
                                            {
                                                @if (slotBooking!.Room != null)
                                                {
                                                    <span class="badge room-badge" style="background-color: @slotBooking.Room.ColorCode; color: white;">
                                                        @slotBooking.Room.Name
                                                    </span>
                                                }
                                                else
                                                {
                                                    <span class="badge bg-secondary">Unassigned</span>
                                                }
                                            }
                                        </div>
                                        <div class="status-column">
                                            @if (isBlocked)
                                            {
                                                <span class="badge bg-danger">Blocked</span>
                                            }
                                            else if (isBooked)
                                            {
                                                <span class="badge @GetStatusBadgeClass(slotBooking!.Status)">@slotBooking.Status</span>
                                            }
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        }
        else if (viewMode == ViewMode.Week || viewMode == ViewMode.Fortnight)
        {
            var weekStart = GetWeekStart(currentDate);
            var days = viewMode == ViewMode.Fortnight ? 14 : 7;
            var hourlySlots = Enumerable.Range(8, 13).Select(h => new TimeSpan(h, 0, 0)).ToArray();
            
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body p-0">
                            <div class="week-time-grid" style="grid-template-columns: 100px repeat(@days, 1fr);">
                                <!-- Header Row -->
                                <div class="week-time-cell header-cell">Time</div>
                                @for (int i = 0; i < days; i++)
                                {
                                    var day = weekStart.AddDays(i);
                                    var isToday = day.Date == DateTime.Today;
                                    <div class="week-time-cell header-cell @(isToday ? "today" : "")">
                                        <div class="fw-bold">@day.ToString("ddd")</div>
                                        <div class="small">@day.ToString("dd/MM")</div>
                                    </div>
                                }
                                
                                <!-- Time Slot Rows -->
                                @foreach (var hourSlot in hourlySlots)
                                {
                                    <div class="week-time-cell time-label-cell">@hourSlot.ToString(@"hh\:mm")</div>
                                    
                                    @for (int i = 0; i < days; i++)
                                    {
                                        var day = weekStart.AddDays(i);
                                        var slotBookings = bookings.Where(b => 
                                            b.StartTime.Date == day.Date && 
                                            b.StartTime.TimeOfDay >= hourSlot && 
                                            b.StartTime.TimeOfDay < hourSlot.Add(TimeSpan.FromHours(1))).ToList();
                                        
                                        var slotBlocks = blockedTimes.Any(bt => 
                                            bt.SpecificDate == day.Date &&
                                            ((bt.StartTime == TimeSpan.Zero && bt.EndTime.TotalSeconds >= 86399) ||
                                             (bt.StartTime <= hourSlot && bt.EndTime > hourSlot)));
                                        
                                        var hasBookings = slotBookings.Any();
                                        var cellClass = slotBlocks ? "week-time-cell blocked-cell" : 
                                                       hasBookings ? "week-time-cell booked-cell" : "week-time-cell";
                                        
                                        <div class="@cellClass">
                                            @if (slotBlocks)
                                            {
                                                <span class="text-danger small fw-bold">ðŸš« Blocked</span>
                                            }
                                            else if (hasBookings)
                                            {
                                                @foreach (var booking in slotBookings)
                                                {
                                                    <div class="week-booking-item" @onclick="() => SelectBooking(booking)">
                                                        <div class="small fw-bold">@booking.StartTime.ToString("HH:mm")</div>
                                                        <div class="small">@booking.Client.FirstName @booking.Client.LastName</div>
                                                        @if (booking.Room != null)
                                                        {
                                                            <div class="badge badge-sm room-badge mt-1" style="background-color: @booking.Room.ColorCode; font-size: 0.65rem;">
                                                                @booking.Room.Name
                                                            </div>
                                                        }
                                                    </div>
                                                }
                                            }
                                            else
                                            {
                                                <span class="text-muted small">Open</span>
                                            }
                                        </div>
                                    }
                                }
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        }
        else if (viewMode == ViewMode.Month)
        {
            var monthStart = new DateTime(currentDate.Year, currentDate.Month, 1);
            var firstDayOfWeek = GetWeekStart(monthStart);
            var daysToShow = 35;
            var dayNames = new[] { "Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun" };
            
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body p-0">
                            <div class="month-grid">
                                @foreach (var dayName in dayNames)
                                {
                                    <div class="month-day-header">@dayName</div>
                                }
                                
                                @for (int i = 0; i < daysToShow; i++)
                                {
                                    var day = firstDayOfWeek.AddDays(i);
                                    var isToday = day.Date == DateTime.Today;
                                    var isCurrentMonth = day.Month == currentDate.Month;
                                    var dayBookings = bookings.Where(b => b.StartTime.Date == day.Date).ToList();
                                    var dayBlocks = blockedTimes.Where(bt => bt.SpecificDate == day.Date).ToList();
                                    
                                    <div class="month-day @(isToday ? "today" : "") @(!isCurrentMonth ? "other-month" : "")">
                                        <div class="day-number">@day.Day</div>
                                        <div class="day-indicators">
                                            @if (dayBlocks.Any())
                                            {
                                                <div class="indicator blocked" title="@string.Join(", ", dayBlocks.Select(b => b.Notes))">ðŸš«</div>
                                            }
                                            @if (dayBookings.Any())
                                            {
                                                <div class="indicator bookings" title="@($"{dayBookings.Count} appointment(s)")">@dayBookings.Count</div>
                                            }
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        }
    }
</div>

<!-- Block Time Off Modal -->
@if (showBlockModal)
{
    <div class="modal-backdrop show"></div>
    <div class="modal show d-block" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Block Time Off</h5>
                    <button type="button" class="btn-close" @onclick="CloseBlockModal"></button>
                </div>
                <div class="modal-body">
                    @if (!string.IsNullOrEmpty(blockErrorMessage))
                    {
                        <div class="alert alert-danger">@blockErrorMessage</div>
                    }
                    
                    <EditForm Model="@blockModel" OnValidSubmit="SaveTimeBlock" FormName="blockTimeForm">
                        <DataAnnotationsValidator />
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Start Date *</label>
                                <InputDate class="form-control" @bind-Value="blockModel.StartDate" />
                                <ValidationMessage For="@(() => blockModel.StartDate)" />
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label class="form-label">End Date *</label>
                                <InputDate class="form-control" @bind-Value="blockModel.EndDate" />
                                <ValidationMessage For="@(() => blockModel.EndDate)" />
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Start Time (Optional)</label>
                                <input type="time" class="form-control" value="@blockModel.StartTimeString" 
                                      @onchange="@(e => blockModel.StartTimeString = e.Value?.ToString())" />
                                <small class="form-text text-muted">Leave blank to block entire day</small>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label class="form-label">End Time (Optional)</label>
                                <input type="time" class="form-control" value="@blockModel.EndTimeString" 
                                      @onchange="@(e => blockModel.EndTimeString = e.Value?.ToString())" />
                                <small class="form-text text-muted">Leave blank to block entire day</small>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Reason/Notes *</label>
                            <InputTextArea class="form-control" @bind-Value="blockModel.Notes" 
                                          rows="3" placeholder="e.g., Vacation, Personal Day, Medical Appointment" />
                            <ValidationMessage For="@(() => blockModel.Notes)" />
                        </div>
                        
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary" disabled="@isSaving">
                                @if (isSaving)
                                {
                                    <span class="spinner-border spinner-border-sm me-2"></span>
                                }
                                Block Time
                            </button>
                            <button type="button" class="btn btn-secondary" @onclick="CloseBlockModal">
                                Cancel
                            </button>
                        </div>
                    </EditForm>
                </div>
            </div>
        </div>
    </div>
}

<!-- Appointment Details Modal -->
@if (selectedBooking != null)
{
    <div class="modal-backdrop show"></div>
    <div class="modal show d-block" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Appointment Details</h5>
                    <button type="button" class="btn-close" @onclick="CloseBookingModal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-rose-gold mb-3">Appointment Information</h6>
                            <dl class="row mb-0">
                                <dt class="col-sm-4">Service:</dt>
                                <dd class="col-sm-8">@selectedBooking.Service?.Name</dd>
                                
                                <dt class="col-sm-4">Date:</dt>
                                <dd class="col-sm-8">@selectedBooking.StartTime.ToString("dd/MM/yyyy")</dd>
                                
                                <dt class="col-sm-4">Time:</dt>
                                <dd class="col-sm-8">
                                    @selectedBooking.StartTime.ToString("HH:mm") - @selectedBooking.EndTime.ToString("HH:mm")
                                </dd>
                                
                                <dt class="col-sm-4">Status:</dt>
                                <dd class="col-sm-8">
                                    <span class="badge @GetStatusBadgeClass(selectedBooking.Status)">
                                        @selectedBooking.Status
                                    </span>
                                </dd>
                                
                                <dt class="col-sm-4">Room:</dt>
                                <dd class="col-sm-8">
                                    @if (selectedBooking.Room != null)
                                    {
                                        <span class="badge room-badge" style="background-color: @selectedBooking.Room.ColorCode; color: white;">
                                            @selectedBooking.Room.Name
                                        </span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-secondary">Unassigned</span>
                                        @if (isAdmin)
                                        {
                                            <button class="btn btn-sm btn-link p-0 ms-2" @onclick="() => ShowRoomAssignmentModal()">
                                                <i class="bi bi-pencil"></i> Assign Room
                                            </button>
                                        }
                                    }
                                </dd>
                            </dl>
                        </div>
                        
                        <div class="col-md-6">
                            <h6 class="text-rose-gold mb-3">Client Information</h6>
                            <dl class="row mb-0">
                                <dt class="col-sm-4">Name:</dt>
                                <dd class="col-sm-8">@selectedBooking.Client.FirstName @selectedBooking.Client.LastName</dd>
                                
                                <dt class="col-sm-4">Email:</dt>
                                <dd class="col-sm-8">@selectedBooking.Client.Email</dd>
                                
                                <dt class="col-sm-4">Phone:</dt>
                                <dd class="col-sm-8">@selectedBooking.Client.PhoneNumber</dd>
                            </dl>
                        </div>
                    </div>
                    
                    @if (!string.IsNullOrEmpty(selectedBooking.Notes))
                    {
                        <div class="mt-3">
                            <h6 class="text-rose-gold">Client Notes:</h6>
                            <div class="alert alert-info mb-0">@selectedBooking.Notes</div>
                        </div>
                    }
                </div>
                <div class="modal-footer">
                    @if (selectedBooking.Status == BookingStatus.Pending)
                    {
                        <button type="button" class="btn btn-success" @onclick="ConfirmBooking">
                            Confirm
                        </button>
                    }
                    @if (selectedBooking.Status == BookingStatus.Confirmed)
                    {
                        <button type="button" class="btn btn-primary" @onclick="MarkCompleted">
                            Complete
                        </button>
                    }
                    <button type="button" class="btn btn-secondary" @onclick="CloseBookingModal">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>
}

<!-- Block Details Modal -->
@if (selectedBlockedTime != null)
{
    <div class="modal-backdrop show"></div>
    <div class="modal show d-block" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Blocked Time Details</h5>
                    <button type="button" class="btn-close" @onclick="CloseBlockDetailsModal"></button>
                </div>
                <div class="modal-body">
                    <dl class="row mb-0">
                        <dt class="col-sm-4">Date:</dt>
                        <dd class="col-sm-8">@selectedBlockedTime.SpecificDate?.ToString("dd/MM/yyyy")</dd>
                        
                        @if (selectedBlockedTime.StartTime != TimeSpan.Zero || selectedBlockedTime.EndTime != TimeSpan.Zero)
                        {
                            <dt class="col-sm-4">Time:</dt>
                            <dd class="col-sm-8">
                                @selectedBlockedTime.StartTime.ToString(@"hh\:mm") - @selectedBlockedTime.EndTime.ToString(@"hh\:mm")
                            </dd>
                        }
                        else
                        {
                            <dt class="col-sm-4">Duration:</dt>
                            <dd class="col-sm-8">All Day</dd>
                        }
                        
                        <dt class="col-sm-4">Reason:</dt>
                        <dd class="col-sm-8">@selectedBlockedTime.Notes</dd>
                    </dl>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" @onclick="RemoveBlock">
                        Remove Block
                    </button>
                    <button type="button" class="btn btn-secondary" @onclick="CloseBlockDetailsModal">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>
}

<!-- View Schedule Modal -->
@if (showViewScheduleModal)
{
    <div class="modal-backdrop show"></div>
    <div class="modal show d-block" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-people me-2"></i>View Staff Schedule
                    </h5>
                    <button type="button" class="btn-close" @onclick="CloseViewScheduleModal"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted mb-3">Select a staff member to view their schedule in a new window:</p>
                    
                    <div class="list-group">
                        <button type="button" 
                                class="list-group-item list-group-item-action d-flex align-items-center justify-content-between"
                                @onclick="() => ViewMySchedule()">
                            <div>
                                <i class="bi bi-person-circle me-2"></i>
                                <strong>My Schedule</strong>
                            </div>
                            <i class="bi bi-arrow-right"></i>
                        </button>
                        
                        @if (therapists.Any())
                        {
                            <div class="list-group-item bg-light">
                                <small class="text-muted fw-bold">ALL STAFF</small>
                            </div>
                            @foreach (var therapist in therapists)
                            {
                                <button type="button" 
                                        class="list-group-item list-group-item-action d-flex align-items-center justify-content-between"
                                        @onclick="() => ViewTherapistSchedule(therapist.Id)">
                                    <div>
                                        <i class="bi bi-person me-2"></i>
                                        @therapist.FirstName @therapist.LastName
                                    </div>
                                    <i class="bi bi-box-arrow-up-right"></i>
                                </button>
                            }
                        }
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseViewScheduleModal">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
}

<!-- Room Assignment Modal -->
@if (showRoomAssignmentModal && selectedBooking != null)
{
    <div class="modal-backdrop show"></div>
    <div class="modal show d-block" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Assign Room</h5>
                    <button type="button" class="btn-close" @onclick="CloseRoomAssignmentModal"></button>
                </div>
                <div class="modal-body">
                    <p class="mb-3">
                        <strong>Service:</strong> @selectedBooking?.Service?.Name<br />
                        <strong>Time:</strong> @selectedBooking?.StartTime.ToString("dd/MM/yyyy HH:mm")
                    </p>

                    @if (availableRooms.Any())
                    {
                        <div class="list-group">
                            @foreach (var room in availableRooms)
                            {
                                <button type="button" class="list-group-item list-group-item-action d-flex align-items-center" 
                                        @onclick="() => AssignRoom(room.Id)">
                                        <span class="badge room-badge me-2" 
                                              style="background-color: @room.ColorCode; color: white; width: 60px;">
                                            @room.Name
                                        </span>
                                        <span class="flex-grow-1">@room.Location.Name</span>
                                        <i class="bi bi-arrow-right"></i>
                                    </button>
                                }

                        </div>
                    }
                    else
                    {
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            No rooms available for this service at this location.
                        </div>
                    }
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseRoomAssignmentModal">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private enum ViewMode { Day, Week, Fortnight, Month }
    
    private ViewMode viewMode = ViewMode.Week;
    private DateTime currentDate = DateTime.Today;
    private bool isLoading = true;
    private bool isSaving = false;
    private bool showBlockModal = false;
    private bool showRoomAssignmentModal = false;
    private bool showViewScheduleModal = false;
    private string? currentUserId;
    private string? blockErrorMessage;
    private string? debugMessage;
    
    private List<Booking> bookings = new();
    private List<TherapistAvailability> blockedTimes = new();
    private Booking? selectedBooking;
    private TherapistAvailability? selectedBlockedTime;
    private BlockTimeModel blockModel = new();
    private List<Room> availableRooms = new();
    
    // User switching
    private List<ApplicationUser> therapists = new();
    private string? viewingUserId;
    private ApplicationUser? viewingUser;
    private bool isAdmin = false;
    
    // Time slots for day view (8 AM to 8 PM in 15-minute intervals)
    private readonly TimeSpan[] timeSlots = Enumerable.Range(0, 49).Select(i => new TimeSpan(8, i * 15, 0)).ToArray();

    protected override async Task OnInitializedAsync()
    {
        try
        {
            await GetCurrentUser();
            viewingUserId = currentUserId;
            
            // Check if user is admin
            if (!string.IsNullOrEmpty(currentUserId))
            {
                var user = await UserManager.FindByIdAsync(currentUserId);
                if (user != null)
                {
                    isAdmin = await UserManager.IsInRoleAsync(user, "Admin");
                    
                    // Redirect admins to comprehensive scheduler
                    if (isAdmin)
                    {
                        NavigationManager.NavigateTo("/admin/scheduler", forceLoad: true);
                        return;
                    }
                }
            }
            
            if (isAdmin)
            {
                await LoadTherapists();
            }
            
            await LoadScheduleData();
        }
        catch (Exception)
        {
            isLoading = false;
        }
    }
    
    private async Task LoadTherapists()
    {
        try
        {
            // Load both therapists and admins (all staff who can have schedules)
            var therapistList = await UserManager.GetUsersInRoleAsync("Therapist");
            var adminList = await UserManager.GetUsersInRoleAsync("Admin");
            
            // Combine and deduplicate (in case someone has both roles)
            var allStaff = therapistList.Union(adminList).Distinct().ToList();
            therapists = allStaff.OrderBy(t => t.FirstName).ThenBy(t => t.LastName).ToList();
            
            if (!string.IsNullOrEmpty(viewingUserId))
            {
                viewingUser = therapists.FirstOrDefault(t => t.Id == viewingUserId);
                if (viewingUser == null && viewingUserId == currentUserId)
                {
                    viewingUser = await UserManager.FindByIdAsync(currentUserId);
                }
            }
        }
        catch (Exception)
        {
            therapists = new();
        }
    }
    
    private string GetScheduleTitle()
    {
        if (viewingUser != null && viewingUser.Id != currentUserId)
        {
            return $"{viewingUser.FirstName} {viewingUser.LastName}'s Schedule";
        }
        return "My Schedule";
    }
    
    private void ShowViewScheduleModal()
    {
        showViewScheduleModal = true;
    }
    
    private void CloseViewScheduleModal()
    {
        showViewScheduleModal = false;
    }
    
    private void ViewMySchedule()
    {
        NavigationManager.NavigateTo("/schedule/enhanced", forceLoad: true);
        CloseViewScheduleModal();
    }
    
    private void ViewTherapistSchedule(string therapistId)
    {
        // Open in new window using JavaScript
        var url = $"/schedule/enhanced?userId={therapistId}";
        NavigationManager.NavigateTo(url, forceLoad: true);
        CloseViewScheduleModal();
    }
    
    private async Task SwitchToUser(string? userId)
    {
        if (string.IsNullOrEmpty(userId)) return;
        
        try
        {
            viewingUserId = userId;
            viewingUser = therapists.FirstOrDefault(t => t.Id == userId);
            if (viewingUser == null && userId == currentUserId && !string.IsNullOrEmpty(currentUserId))
            {
                viewingUser = await UserManager.FindByIdAsync(currentUserId);
            }
            
            await LoadScheduleData();
        }
        catch (Exception)
        {
            // Silent fail
        }
    }

    private async Task GetCurrentUser()
    {
        try
        {
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;
            
            if (user.Identity?.IsAuthenticated == true)
            {
                var appUser = await UserManager.GetUserAsync(user);
                currentUserId = appUser?.Id;
            }
        }
        catch (Exception)
        {
            // Silent fail - user not authenticated
        }
    }

    private async Task LoadScheduleData()
    {
        if (string.IsNullOrEmpty(currentUserId))
        {
            isLoading = false;
            return;
        }

        try
        {
            isLoading = true;
            
            var userIdToLoad = viewingUserId ?? currentUserId;
            var (startDate, endDate) = GetDateRange();

            // Load data in parallel
            var bookingsTask = DbContext.Bookings
                .AsNoTracking()
                .Include(b => b.Service)
                .Include(b => b.Client)
                .Include(b => b.Location)
                .Include(b => b.Room)
                .Where(b => b.TherapistId == userIdToLoad 
                         && b.StartTime >= startDate 
                         && b.StartTime < endDate
                         && b.Status != BookingStatus.Cancelled)
                .OrderBy(b => b.StartTime)
                .ToListAsync();

            var blockedTimesTask = DbContext.TherapistAvailability
                .AsNoTracking()
                .Where(a => a.TherapistId == userIdToLoad 
                         && a.SpecificDate != null
                         && !a.IsAvailable
                         && a.SpecificDate >= startDate.Date
                         && a.SpecificDate < endDate.Date)
                .OrderBy(a => a.SpecificDate)
                .ToListAsync();

            await Task.WhenAll(bookingsTask, blockedTimesTask);
            
            bookings = await bookingsTask;
            blockedTimes = await blockedTimesTask;
        }
        catch (ObjectDisposedException)
        {
            // Component was disposed, ignore
            bookings = new();
            blockedTimes = new();
        }
        catch (Exception)
        {
            bookings = new();
            blockedTimes = new();
        }
        finally
        {
            isLoading = false;
        }
    }
    
    private (DateTime start, DateTime end) GetDateRange()
    {
        return viewMode switch
        {
            ViewMode.Day => (currentDate.Date, currentDate.Date.AddDays(1)),
            ViewMode.Week => (GetWeekStart(currentDate), GetWeekStart(currentDate).AddDays(7)),
            ViewMode.Fortnight => (GetWeekStart(currentDate), GetWeekStart(currentDate).AddDays(14)),
            ViewMode.Month => (new DateTime(currentDate.Year, currentDate.Month, 1), 
                              new DateTime(currentDate.Year, currentDate.Month, 1).AddMonths(1)),
            _ => (currentDate.Date, currentDate.Date.AddDays(1))
        };
    }

    private DateTime GetWeekStart(DateTime date)
    {
        int diff = (7 + (date.DayOfWeek - DayOfWeek.Monday)) % 7;
        return date.AddDays(-diff).Date;
    }

    private string GetDateRangeDisplay()
    {
        var (start, end) = GetDateRange();
        
        return viewMode switch
        {
            ViewMode.Day => currentDate.ToString("dddd, dd/MM/yyyy"),
            ViewMode.Week => $"{start:dd/MM} - {end.AddDays(-1):dd/MM/yyyy}",
            ViewMode.Fortnight => $"{start:dd/MM} - {end.AddDays(-1):dd/MM/yyyy}",
            ViewMode.Month => currentDate.ToString("MMMM yyyy"),
            _ => currentDate.ToString("dd/MM/yyyy")
        };
    }

    private void ChangeViewMode(ViewMode mode)
    {
        viewMode = mode;
        StateHasChanged();
    }

    private async Task NavigatePrevious()
    {
        currentDate = viewMode switch
        {
            ViewMode.Day => currentDate.AddDays(-1),
            ViewMode.Week => currentDate.AddDays(-7),
            ViewMode.Fortnight => currentDate.AddDays(-14),
            ViewMode.Month => currentDate.AddMonths(-1),
            _ => currentDate.AddDays(-1)
        };
        await LoadScheduleData();
    }

    private async Task NavigateNext()
    {
        currentDate = viewMode switch
        {
            ViewMode.Day => currentDate.AddDays(1),
            ViewMode.Week => currentDate.AddDays(7),
            ViewMode.Fortnight => currentDate.AddDays(14),
            ViewMode.Month => currentDate.AddMonths(1),
            _ => currentDate.AddDays(1)
        };
        await LoadScheduleData();
    }

    private async Task GoToToday()
    {
        currentDate = DateTime.Today;
        await LoadScheduleData();
    }

    private void HandleSlotClick(Booking? booking, TherapistAvailability? block)
    {
        if (booking != null)
        {
            SelectBooking(booking);
        }
        else if (block != null)
        {
            SelectBlockedTime(block);
        }
    }

    private void ShowBlockTimeModal()
    {
        blockModel = new BlockTimeModel { StartDate = currentDate, EndDate = currentDate };
        showBlockModal = true;
        blockErrorMessage = null;
    }

    private void CloseBlockModal()
    {
        showBlockModal = false;
        blockModel = new BlockTimeModel();
        blockErrorMessage = null;
    }

    private async Task SaveTimeBlock()
    {
        if (string.IsNullOrEmpty(currentUserId)) return;

        blockErrorMessage = null;

        if (blockModel.EndDate < blockModel.StartDate)
        {
            blockErrorMessage = "End date cannot be before start date.";
            return;
        }

        isSaving = true;

        try
        {
            // Use UTC dates to avoid PostgreSQL timezone issues
            var currentBlockDate = DateTime.SpecifyKind(blockModel.StartDate.Date, DateTimeKind.Utc);
            var endBlockDate = DateTime.SpecifyKind(blockModel.EndDate.Date, DateTimeKind.Utc);
            
            while (currentBlockDate <= endBlockDate)
            {
                var existingBlock = await DbContext.TherapistAvailability
                    .FirstOrDefaultAsync(a => a.TherapistId == currentUserId 
                                           && a.SpecificDate == currentBlockDate
                                           && !a.IsAvailable);

                if (existingBlock == null)
                {
                    var block = new TherapistAvailability
                    {
                        TherapistId = currentUserId,
                        DayOfWeek = currentBlockDate.DayOfWeek,
                        StartTime = blockModel.StartTime ?? TimeSpan.Zero,
                        EndTime = blockModel.EndTime ?? new TimeSpan(23, 59, 59),
                        IsAvailable = false,
                        SpecificDate = currentBlockDate,
                        Notes = blockModel.Notes,
                        CreatedAt = DateTime.UtcNow
                    };

                    DbContext.TherapistAvailability.Add(block);
                }

                currentBlockDate = currentBlockDate.AddDays(1);
            }

            await DbContext.SaveChangesAsync();
            await LoadScheduleData();
            CloseBlockModal();
        }
        catch (Exception ex)
        {
            blockErrorMessage = $"Error blocking time: {ex.Message}";
        }
        finally
        {
            isSaving = false;
        }
    }

    private void SelectBooking(Booking booking)
    {
        selectedBooking = booking;
    }

    private void CloseBookingModal()
    {
        selectedBooking = null;
    }

    private void SelectBlockedTime(TherapistAvailability block)
    {
        selectedBlockedTime = block;
    }

    private void CloseBlockDetailsModal()
    {
        selectedBlockedTime = null;
    }

    private async Task RemoveBlock()
    {
        if (selectedBlockedTime == null) return;

        DbContext.TherapistAvailability.Remove(selectedBlockedTime);
        await DbContext.SaveChangesAsync();
        await LoadScheduleData();
        CloseBlockDetailsModal();
    }

    private async Task ConfirmBooking()
    {
        if (selectedBooking == null) return;

        selectedBooking.Status = BookingStatus.Confirmed;
        selectedBooking.UpdatedAt = DateTime.UtcNow;
        await DbContext.SaveChangesAsync();
        
        await LoadScheduleData();
        CloseBookingModal();
    }

    private async Task MarkCompleted()
    {
        if (selectedBooking == null) return;

        selectedBooking.Status = BookingStatus.Completed;
        selectedBooking.UpdatedAt = DateTime.UtcNow;
        await DbContext.SaveChangesAsync();
        
        await LoadScheduleData();
        CloseBookingModal();
    }

    private string GetStatusBadgeClass(BookingStatus status)
    {
        return status switch
        {
            BookingStatus.Pending => "bg-warning text-dark",
            BookingStatus.Confirmed => "bg-success",
            BookingStatus.Completed => "bg-secondary",
            _ => "bg-secondary"
        };
    }

    private async Task ShowRoomAssignmentModal()
    {
        if (selectedBooking == null) return;

        // Load available rooms for this booking's service and location
        var roomServiceCapabilities = await DbContext.RoomServiceCapabilities
            .Where(rsc => rsc.ServiceId == selectedBooking.ServiceId)
            .Select(rsc => rsc.RoomId)
            .ToListAsync();

        availableRooms = await DbContext.Rooms
            .Include(r => r.Location)
            .Where(r => r.LocationId == selectedBooking.LocationId 
                     && r.IsActive 
                     && roomServiceCapabilities.Contains(r.Id))
            .OrderBy(r => r.DisplayOrder)
            .ToListAsync();

        showRoomAssignmentModal = true;
    }

    private void CloseRoomAssignmentModal()
    {
        showRoomAssignmentModal = false;
        availableRooms.Clear();
    }

    private async Task AssignRoom(int roomId)
    {
        if (selectedBooking == null) return;

        var booking = await DbContext.Bookings.FindAsync(selectedBooking.Id);
        if (booking != null)
        {
            booking.RoomId = roomId;
            booking.UpdatedAt = DateTime.UtcNow;
            await DbContext.SaveChangesAsync();
            await LoadScheduleData();
        }

        CloseRoomAssignmentModal();
        CloseBookingModal();
    }

    public class BlockTimeModel
    {
        [Required(ErrorMessage = "Start date is required")]
        public DateTime StartDate { get; set; } = DateTime.Today;

        [Required(ErrorMessage = "End date is required")]
        public DateTime EndDate { get; set; } = DateTime.Today;

        public string? StartTimeString { get; set; }
        public string? EndTimeString { get; set; }

        public TimeSpan? StartTime => string.IsNullOrEmpty(StartTimeString) ? null : TimeSpan.Parse(StartTimeString);
        public TimeSpan? EndTime => string.IsNullOrEmpty(EndTimeString) ? null : TimeSpan.Parse(EndTimeString);

        [Required(ErrorMessage = "Please provide a reason for blocking this time")]
        [StringLength(500, ErrorMessage = "Notes cannot exceed 500 characters")]
        public string Notes { get; set; } = string.Empty;
    }
}

