@page "/payment/success"
@using Microsoft.EntityFrameworkCore
@using SpaBooker.Core.Entities
@using SpaBooker.Core.Enums
@using SpaBooker.Core.Interfaces
@using SpaBooker.Infrastructure.Data
@using Microsoft.AspNetCore.Authorization
@inject ApplicationDbContext DbContext
@inject NavigationManager NavigationManager
@inject IEmailService EmailService
@attribute [Authorize]

<PageTitle>Payment Successful - SpaBooker</PageTitle>

<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-6">
            @if (isLoading)
            {
                <div class="text-center py-5">
                    <div class="spinner"></div>
                    <p class="mt-3 text-muted">Confirming your payment...</p>
                </div>
            }
            else if (booking != null)
            {
                <div class="card shadow-lg border-0">
                    <div class="card-body text-center p-5">
                        <div class="success-icon mb-4">
                            <i class="bi bi-check-circle-fill"></i>
                        </div>
                        <h1 class="text-rose-gold mb-3">Payment Successful!</h1>
                        <p class="lead mb-4">Your booking has been confirmed.</p>

                        <div class="booking-confirmation">
                            <h5 class="text-rose-gold mb-3">Booking Details</h5>
                            <div class="details-box p-4 bg-light rounded">
                                <div class="row mb-2">
                                    <div class="col-6 text-start"><strong>Service:</strong></div>
                                    <div class="col-6 text-end">@booking.Service?.Name</div>
                                </div>
                                <div class="row mb-2">
                                    <div class="col-6 text-start"><strong>Therapist:</strong></div>
                                    <div class="col-6 text-end">@booking.Therapist?.FirstName @booking.Therapist?.LastName</div>
                                </div>
                                <div class="row mb-2">
                                    <div class="col-6 text-start"><strong>Location:</strong></div>
                                    <div class="col-6 text-end">@booking.Location.Name</div>
                                </div>
                                <div class="row mb-2">
                                    <div class="col-6 text-start"><strong>Date:</strong></div>
                                    <div class="col-6 text-end">@booking.StartTime.ToString("MMMM dd, yyyy")</div>
                                </div>
                                <div class="row mb-2">
                                    <div class="col-6 text-start"><strong>Time:</strong></div>
                                    <div class="col-6 text-end">@booking.StartTime.ToString("h:mm tt")</div>
                                </div>
                                <hr class="my-3" />
                                <div class="row mb-2">
                                    <div class="col-6 text-start"><strong>Total Cost:</strong></div>
                                    <div class="col-6 text-end">${booking.TotalPrice:F2}</div>
                                </div>
                                <div class="row mb-2">
                                    <div class="col-6 text-start"><strong>Paid Today:</strong></div>
                                    <div class="col-6 text-end text-success">${booking.DepositAmount:F2}</div>
                                </div>
                                <div class="row">
                                    <div class="col-6 text-start"><strong>Balance Due:</strong></div>
                                    <div class="col-6 text-end">${(booking.TotalPrice - booking.DepositAmount):F2}</div>
                                </div>
                            </div>
                        </div>

                        <div class="alert alert-info mt-4">
                            <i class="bi bi-info-circle me-2"></i>
                            <strong>What's Next:</strong> A confirmation email has been sent to your email address. 
                            Please arrive 10 minutes before your appointment time.
                        </div>

                        <div class="d-grid gap-2 mt-4">
                            <a href="/bookings/my-bookings" class="btn btn-primary btn-lg">
                                View My Bookings
                            </a>
                            <a href="/services" class="btn btn-outline-secondary">
                                Book Another Service
                            </a>
                        </div>
                    </div>
                </div>
            }
            else
            {
                <div class="card shadow-lg border-0">
                    <div class="card-body text-center p-5">
                        <div class="error-icon mb-4">
                            <i class="bi bi-exclamation-circle-fill"></i>
                        </div>
                        <h3 class="text-danger mb-3">Booking Not Found</h3>
                        <p>We couldn't find your booking. Please check your bookings or contact support.</p>
                        <a href="/bookings/my-bookings" class="btn btn-primary mt-3">View My Bookings</a>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

@code {
    private Booking? booking;
    private bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        // Get booking ID from query string
        var uri = new Uri(NavigationManager.Uri);
        var query = Microsoft.AspNetCore.WebUtilities.QueryHelpers.ParseQuery(uri.Query);
        
        if (query.TryGetValue("booking_id", out var bookingIdStr) && int.TryParse(bookingIdStr, out var bookingId))
        {
            await LoadBooking(bookingId);
        }
        else
        {
            isLoading = false;
        }
    }

    private async Task LoadBooking(int bookingId)
    {
        booking = await DbContext.Bookings
            .Include(b => b.Service)
            .Include(b => b.Therapist)
            .Include(b => b.Location)
            .FirstOrDefaultAsync(b => b.Id == bookingId);

        // Mark booking as confirmed if not already
        if (booking != null && booking.Status == BookingStatus.Pending)
        {
            booking.Status = BookingStatus.Confirmed;
            booking.UpdatedAt = DateTime.UtcNow;
            await DbContext.SaveChangesAsync();
            
            // Send confirmation email
            try
            {
                await EmailService.SendBookingConfirmationAsync(bookingId);
            }
            catch (Exception ex)
            {
                // Log but don't fail the page - email failure shouldn't block user
                Console.WriteLine($"Failed to send confirmation email: {ex.Message}");
            }
        }

        isLoading = false;
    }
}

